function ownKeys(e,n){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter(function(f){return Object.getOwnPropertyDescriptor(e,f).enumerable})),o.push.apply(o,a)}return o}function _objectSpread(e){for(var n=1;n<arguments.length;n++){var o=arguments[n]!=null?arguments[n]:{};n%2?ownKeys(Object(o),!0).forEach(function(a){_defineProperty(e,a,o[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(o,a))})}return e}function _typeof(e){return _typeof=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(n){return typeof n}:function(n){return n&&typeof Symbol=="function"&&n.constructor===Symbol&&n!==Symbol.prototype?"symbol":typeof n},_typeof(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if(typeof Symbol!="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _defineProperty(e,n,o){return n=_toPropertyKey(n),n in e?Object.defineProperty(e,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[n]=o,e}function _toPropertyKey(e){var n=_toPrimitive(e,"string");return _typeof(n)==="symbol"?n:String(n)}function _toPrimitive(e,n){if(_typeof(e)!=="object"||e===null)return e;var o=e[Symbol.toPrimitive];if(o!==void 0){var a=o.call(e,n||"default");if(_typeof(a)!=="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(e)}function _readOnlyError(e){throw new TypeError('"'+e+'" is read-only')}function _slicedToArray(e,n){return _arrayWithHoles(e)||_iterableToArrayLimit(e,n)||_unsupportedIterableToArray(e,n)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,n){if(e){if(typeof e=="string")return _arrayLikeToArray(e,n);var o=Object.prototype.toString.call(e).slice(8,-1);if(o==="Object"&&e.constructor&&(o=e.constructor.name),o==="Map"||o==="Set")return Array.from(e);if(o==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o))return _arrayLikeToArray(e,n)}}function _arrayLikeToArray(e,n){(n==null||n>e.length)&&(n=e.length);for(var o=0,a=new Array(n);o<n;o++)a[o]=e[o];return a}function _iterableToArrayLimit(e,n){var o=e==null?null:typeof Symbol!="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(o!=null){var a,f,T,S,b=[],w=!0,H=!1;try{if(T=(o=o.call(e)).next,n===0){if(Object(o)!==o)return;w=!1}else for(;!(w=(a=T.call(o)).done)&&(b.push(a.value),b.length!==n);w=!0);}catch(g){H=!0,f=g}finally{try{if(!w&&o.return!=null&&(S=o.return(),Object(S)!==S))return}finally{if(H)throw f}}return b}}function _arrayWithHoles(e){if(Array.isArray(e))return e}vim.dom=function(){"use strict";var e=function(w){return typeof w=="string"?document.querySelector(w):w},n=function(w,H){return e(w).classList.contains(H)},o=function(w,H){n(w,H)||e(w).classList.add(H)},a=function(w,H){return e(w).classList.remove(H)},f=function(w,H,g){return(g?o:a)(w,H)},T=function(w,H,g){return e(w).addEventListener(H,g,!1)},S=function(w,H,g){return e(w).removeEventListener(H,g,!1)};return{$:function(w){return document.querySelectorAll(w)},hasClass:n,addClass:o,removeClass:a,setClass:f,bind:T,unbind:S}}();var detectTilde=function(){var e=!1,n=!1,o=!1,a=!1,f=!1,T=!1,S=!1,b=!1,w=!1,H=!1,g=!1,M=!1,A=!1,O=!1,B=!1,G=!1,U=!1,V=/firefox/i.test(navigator.userAgent),Y=!1,ve=!1,ue=!1,K=!1,fe=!1,q=[],de=["225D","229D","221U","225U","229D","32U"],ye=["225D","221U","229D","221U","225U"],We=["225D","221U","225U","229D","32U"],Be=["18D","221D","221U","18U"],D=["16D","229D","221U","16U","229D","32U"],ee=["16D","221U","16U","229D","32U"],J=["16D","221U","229D","221U","16U"],h=["16D","221D","221U","16U"],_=["18D","16D","54D","54U","16U","18U"],y=["16D","18D","54D","54U","18U","16U"],P=["16D","222D","39P","222U","16U"],W=["16D","192D","192U","16U","32D","32P"],$=["16D","54D","54U","16U","32D","32P"],ie=["192D","192U"],pe=["191D","39P","191U"],Ae=["32D","32U"],Ne=["16D","222D","222U","16U"],ae=["!16D","222D","222U"],De=["16D","187D","187U","16U"],Re=["16D","187D","16U","187U"],Ge=["!16D&!225D","187D","187U"],Xe=["225D","187D","187U","225U"];function ze(z){if(!vim.screens["game-screen"].isTitleScreenOn())if(_n(z.keyCode+"D"),O=!1,z.keyCode===18)e=!0,b=!0;else if(z.keyCode===225)n=!0,w=!0;else if(z.keyCode===16)o=!0,H=!0;else if(z.keyCode===17)a=!0,g=!0;else if(z.keyCode===224||z.keyCode===91||z.keyCode===93)f=!0;else{if(z.keyCode===82&&(a||f||z.ctrlKey===!0||z.metaKey===!0))return G=!0,a=!1,f=!1,U=!1,Y=!1,ve=!1,he(z),!1;if(z.keyCode===85&&(a||f||z.ctrlKey===!0||z.metaKey===!0))return U=!0,a=!1,f=!1,G=!1,Y=!1,ve=!1,he(z),!1;if(V&&z.keyCode===222&&!o)return ve=!0,Y=!1,U=!1,G=!1,a=!1,f=!1,he(z),!1;if(V&&z.keyCode===191&&!o)return Y=!0,ve=!1,U=!1,G=!1,a=!1,f=!1,he(z),!1;if(z.keyCode===219&&(a||z.ctrlKey===!0))return a=!1,fe=!0,he(z),!1}}function $e(z){_n(z.keyCode+"P"),b=!1,w=!1,H=!1,g=!1,O=!0}function he(z){z&&z.preventDefault?(z.preventDefault(),z.stopPropagation&&z.stopPropagation()):window.event&&window.event.returnValue&&(window.eventReturnValue=!1)}function Q(z){switch(_n(z.keyCode+"U"),z.keyCode){case 18:e=!1;break;case 225:n=!1;break;case 16:o=!1;break;case 17:a=!1;break;case 221:e&&(M=!0);break;case 192:O||(S=!0);break;case 78:!O&&e&&(T=!0);break;case 186:!O&&e&&(ue=!0);break;case 219:!O&&o?K=!0:!O&&!(a||z.ctrlKey||fe)&&(B=!0);break;case 224:case 91:case 93:f=!1;break;case 32:break;default:M=!1,A=!1,T=!1,S=!1,B=!1,G=!1,U=!1,Y=!1,ve=!1,ue=!1,K=!1;break}}function ne(){var z=M;return M=!1,z}function ce(){var z=T;return T=!1,z}function oe(){var z=A;return A=!1,z}function te(){return Ue(Ge)}function Ee(){return Ue(ie)}function Ie(){return Ue(Ne)}function Oe(){return Ue(ae)}function Ke(){return Ue(De)}function we(){return Ue(Re)}function wn(){var z=B;return B=!1,z}function on(){var z=S;return S=!1,z}function an(){var z=G;return G=!1,z}function bn(){var z=U;return U=!1,z}function Dn(){var z=Y;return Y=!1,z}function Bn(){var z=ve;return ve=!1,z}function nn(){var z=fe;return fe=!1,z}function Hn(){return Ue(Xe)}function nr(){var z=q.length;if(z<8)return!1;var dn=q.slice(-8),In=dn.slice(0,3).sort(),cn=_slicedToArray(In,3),Ln=cn[0],Mn=cn[1],On=cn[2],sr=dn.slice(3,5),r=_slicedToArray(sr,2),i=r[0],s=r[1],l=dn.slice(5).sort(),u=_slicedToArray(l,3),t=u[0],c=u[1],m=u[2];if(i!=="160D"||s!=="160U"||Ln!=="16D"||Mn!=="17D"||On!=="18D"||t!=="16U"||c!=="17U"||m!=="18U")return!1;var v=q[z-1];return q.length=0,q.push(v),!0}function Rn(){return Ue(We)||Ue(ye)||Ue(de)||Ue(Be)}function hn(){return Ue(ee)||Ue(J)||Ue(D)||Ue(h)}function Tn(){var z=ue;return ue=!1,z}function kn(){var z=K;return K=!1,z}function Gn(){return Ue(pe)}function vn(){return Ue(P)}function jn(){return Ue(_)||Ue(y)}function ar(){return Ue(W)}function mr(){return Ue($)}function hr(){return Ue(Ae)}function _n(z){q.length>1&&q[q.length-1]===z||(q.push(z),q.length>10&&q.shift())}function Ue(z,dn){var In,cn,Ln=z.length,Mn=q.length,On;if(Mn<Ln)return!1;for(dn&&console.log(q.slice(-Ln)),In=0;In<Ln;++In)for(On=z[In].split("&"),cn=0;cn<On.length;++cn){if(On[cn][0]==="!"&&On[cn].substr(1)===q[Mn-Ln+In])return!1;if(On[cn][0]!=="!"&&On[cn]!==q[Mn-Ln+In])return!1}var sr=q[Mn-1];return q.length=0,q.push(sr),!0}function rr(){var z={altDown:e,altGrDown:n,shiftDown:o,ctrlDown:a,cmdDown:f,ctrlOpenBracketDown:fe,swissGermanTildeDown:T,germanCaretDown:S,altDownNoKeyPress:b,altGrDownNoKeyPress:w,shiftDownNoKeyPress:H,ctrlDownNoKeyPress:g,tildeDown:M,caretDown:A,keypressTriggered:O,frenchCaretDown:B,ctrlRDown:G,ctrlUDown:U,slashDown:Y,singleQuoteDown:ve,spanishTildeDown:ue,spanishCaretDown:K};console.log(z)}return{keydown:ze,keyup:Q,keypress:$e,checkAndResetTilde:ne,checkAndResetSwissGermanTilde:ce,checkAndResetCaret:oe,checkAndResetSwissGermanCaret:te,checkAndResetGermanQwertzCaret:Ee,checkAndResetMacBookProDoubleQuote:Ie,checkAndResetMacBookProSingleQuote:Oe,checkAndResetFrenchCaret:wn,checkAndResetGermanCaret:on,checkAndResetCtrlR:an,checkAndResetCtrlU:bn,checkAndResetFirefoxSlash:Dn,checkAndResetFirefoxSingleQuote:Bn,checkAndResetCtrlOpenBracket:nn,checkAndResetSwedishTilde:Rn,checkAndResetSwedishCaret:hn,checkAndResetSpanishTilde:Tn,checkAndResetSpanishCaret:kn,checkAndResetNorwegianSingleQuote:Gn,checkAndResetGermanMacbookSingleQuote:vn,checkAndResetGermanBacktickMacbook:Ke,checkAndResetGermanQwertzBacktick:we,checkAndResetGerman3KeysCaret:jn,checkBrazilianTildeFollowedBySpaceKeypress:ar,checkBrazilianCaretFollowedBySpaceKeypress:mr,checkIOSBluetoothSpace:hr,checkAndResetAnotherGermanTilde:Hn,checkAndResetNorwegianFirefoxMacTilde:nr,isFirefox:V,debug:rr}}(),adjust=function(n){return function(o){return function(a){return mapi(function(f){return function(T){return T==n?o(f):f}})(a)}}},dropFirst=function(n){return n.slice(1)},dropLast=function(n){return n.slice(0,n.length-1)},id=function(n){return n},k=function(n){return function(){return n}},map=function(n){return function(o){return o.map(n)}},mapi=function(n){return function(o){return o.map(function(a,f){return n(a)(f)})}},filter=function(n){return function(o){return o.filter(n)}},merge=function(n){return function(o){return Object.assign({},n,o)}},mod=function(n){return function(o){return(o%n+n)%n}},objOf=function(n){return function(o){return _defineProperty({},n,o)}},pipe=function(){for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return function(f){return[].concat(o).reduce(function(T,S){return S(T)},f)}},prop=function(n){return function(o){return o[n]}},range=function(n){return function(o){return new Array(Math.max(n,o)-Math.min(n,o)+1).fill(0).map(function(a,f){return n+(n<o?f:-f)})}},rep=function(n){return function(o){return map(k(n))(range(0)(o))}},rnd=function(n){return function(o){return Math.floor(Math.random()*o)+n}},split=function(n){return function(o){return o.split(n)}},join=function(n){return function(o){return o.join(n)}},reverse=function(n){return n.split("").reverse().join("")},odd=function(n){return function(o){return o.map(function(a,f){return f%2===0?a:n(a)})}},find=function(n){return function(o){return o.find(n)}},sum=function(n,o){return n+o},sort=function(n){return function(o){return _toConsumableArray(o).sort(n)}},tap=function(){for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return function(f){var T;return(T=console).log.apply(T,o),f}},unique=function(n,o){return o?n.filter(function(a,f){return n.findIndex(function(T){return o(T)===o(a)})===f}):n.filter(function(a,f){return n.indexOf(a)===f})},last=function(n){return function(o){return filter(n)(o).pop()}},anyOf=function(){for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return function(f){return o.some(function(T){return T(f)===!0})}},noneOf=function(){for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];return function(f){return!o.some(function(T){return T(f)===!0})}},swapCase=function(n){return n===n.toLowerCase()?n.toUpperCase():n.toLowerCase()},randomId=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},shuffle=function(n){for(var o=n.length-1;o>0;o--){var a=Math.floor(Math.random()*(o+1)),f=n[o];n[o]=n[a],n[a]=f}return n},choose=function(n){return function(o){return shuffle(o.slice(0)).slice(0,n)}},flat=function e(n){var o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return o>0?n.reduce(function(a,f){return a.concat(Array.isArray(f)?e(f,o-1):f)},[]):n.slice()},mergeDeep=function e(n){return function(o){var a=function(T){return T&&_typeof(T)==="object"};return[n,o].reduce(function(f,T){return Object.keys(T).forEach(function(S){var b=f[S],w=T[S];Array.isArray(b)&&Array.isArray(w)?f[S]=b.concat.apply(b,_toConsumableArray(w)):a(b)&&a(w)?f[S]=e(b)(w):f[S]=w}),f},{})}},sortXYAscending=function(n,o){return n.y===o.y?n.x-o.x:n.y-o.y},withoutTimes=function(n){return n==="0"?"0":n.replace(/^\d+/,"")},supportedMarks="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",isSupportedMark=function(n){return supportedMarks.includes(n)},isLocalMark=function(n){return n>="a"&&n<="z"||n===" "},isGlobalMark=function(n){return n>="A"&&n<="Z"},debounce=function(n,o){var a;return function(){var f=arguments,T=this;clearTimeout(a),a=setTimeout(function(){return n.apply(T,f)},o)}},throttle=function(n,o){var a=!1;return function(){a||(a=!0,setTimeout(function(){return a=!1},o),n.apply(this,arguments))}},measureDuration=function(n){var o=new Date().valueOf(),a=n();return console.log("Took ".concat((new Date().valueOf()-o)/1e3,"s")),a};function includes(e,n){"use strict";if(e instanceof RegExp)throw TypeError("first argument must not be a RegExp");return n===void 0&&(n=0),this.indexOf(e,n)!==-1}String.prototype.includes=String.prototype.includes||includes,Array.prototype.includes=Array.prototype.includes||includes,Array.prototype.find=Array.prototype.find||function(e){if(this===null)throw new TypeError("Array.prototype.find called on null or undefined");if(typeof e!="function")throw new TypeError("callback must be a function");for(var n=Object(this),o=n.length>>>0,a=arguments[1],f=0;f<o;f++){var T=n[f];if(e.call(a,T,f,n))return T}},Array.prototype.fill||Object.defineProperty(Array.prototype,"fill",{value:function(n){if(this==null)throw new TypeError("this is null or not defined");for(var o=Object(this),a=o.length>>>0,f=arguments[1],T=f>>0,S=T<0?Math.max(a+T,0):Math.min(T,a),b=arguments[2],w=b===void 0?a:b>>0,H=w<0?Math.max(a+w,0):Math.min(w,a);S<H;)o[S]=n,S++;return o}}),module.exports={adjust:adjust,anyOf:anyOf,choose:choose,debounce:debounce,dropFirst:dropFirst,dropLast:dropLast,filter:filter,find:find,flat:flat,id:id,isGlobalMark:isGlobalMark,isLocalMark:isLocalMark,isSupportedMark:isSupportedMark,join:join,k:k,last:last,map:map,measureDuration:measureDuration,merge:merge,mergeDeep:mergeDeep,mod:mod,noneOf:noneOf,objOf:objOf,odd:odd,pipe:pipe,prop:prop,randomId:randomId,range:range,rep:rep,reverse:reverse,rnd:rnd,sort:sort,sortXYAscending:sortXYAscending,split:split,sum:sum,supportedMarks:supportedMarks,swapCase:swapCase,tap:tap,throttle:throttle,unique:unique,withoutTimes:withoutTimes};var Effect={};Effect.speechBubble=function(e){return["speech","cursorCommand"].includes(e.type)},Effect.fixedSpeechBubble=function(e){return Effect.speechBubble(e)&&e.fixed===!0},Effect.sound=function(e){return e.type==="sound"},Effect.defferedSound=function(e){return e.type==="sound"&&e.wait===!0},Effect.expiredSound=function(e){return Effect.sound(e)&&!e.wait},Effect.expiredSpeechBubble=function(e){return Effect.speechBubble(e)&&e.alpha===0},Effect.zeroCount=function(e){return e.count===0},Effect.princessFlash=function(e){return e.type==="princess-flash"},Effect.cursorGlow=function(e){return e.type==="cursor-pointer"},Effect.cursorCommand=function(e){return e.type==="cursorCommand"},Effect.timerStart=function(e){return e.type==="timer-start"},Effect.timerClear=function(e){return e.type==="timer-clear"},Effect.showRange=function(e){return e.type==="show-range"},Effect.textCompleted=function(e){return e.type==="text-completed"},Effect.expiredCursorGlow=function(e){return Effect.cursorGlow(e)&&e.times===0},Effect.commandHelp=function(e){return e.type==="command-help"},Effect.expiredTimer=function(e){return Effect.timerStart(e)&&(new Date().valueOf()-e.startTime)/1e3>e.duration},Effect.darknessFalls=function(e){return e.type==="darkness-falls"},Effect.lightsOn=function(e){return e.type==="lights-on"},Effect.bubbleUp=function(e){return e.type==="bubble-up"},Effect.executeColonCommand=function(e){return e.type==="execute-colon-command"},Effect.doubleEscMessage=function(e){return e.type==="double-esc-message"},Effect.expiredFallingCursor=function(e){return e.type==="falling-cursor"&&e.width!==void 0&&e.width<3},Effect.expiredFallingBlock=function(e){return e.type==="falling-block"&&e.width!==void 0&&e.width<3},Effect.expiredAppearingBGEffect=function(e){return e.type==="appearing-background"&&e.alpha===1},Effect.fadeIn=function(e){return e.type==="fade-in"},Effect.fadeOut=function(e){return e.type==="fade-out"},Effect.fading=function(e){return Effect.fadeIn(e)||Effect.fadeOut(e)},Effect.expiredFadeIn=function(e){return Effect.fadeIn(e)&&e.fadeRatio<0},Effect.expiredFadeOut=function(e){return Effect.fadeOut(e)&&e.fadeRatio>1.05},Effect.explosion=function(e){return e.type==="explosion"},Effect.clearSpeech=function(e){return e.type==="clear-speech"},Effect.doubleLogin=function(e){return e.type==="double-login"},Effect.licenseExpired=function(e){return e.type==="license-expired"},Effect.gameError=function(e){return e.type==="game-error"},Effect.startLevelMark=function(e){return e.type==="start-level-mark"},Effect.lightning=function(e){return e.type==="lightning"},Effect.runGameEnding=function(e){return e.type==="run-game-ending"},Effect.cancelAll=function(e){return e.type==="cancel-all"},Effect.challengeInstructions=function(e){return e.type==="challenge-instructions"},Effect.challengeOver=function(e){return e.type==="challenge-over"},Effect.resetClientState=function(e){return e.type==="reset-client-state"},Effect.expiredRoofFade=function(e){return e.type==="roof-fade"&&e.alpha<=0},Effect.setRegistersOutput=function(e){return e.type==="set-registers"},Effect.expiredSetRegistersOutput=function(e){return e.type==="set-registers"&&e.wait!==!0},Effect.SOUND_PRECEDENCE=["all_other_sounds","glitter","text_restored","teleport","boing","aura","explosion","error_beep","thunder","swipe","yank","deletion","blocked","key_press"],Effect.highestPrecedenceSound=function(e){return e.filter(Effect.sound).filter(find(Effect.fading)(e)?function(n){return n.wait!==!0}:id).reduce(function(n,o){return!n||Effect.SOUND_PRECEDENCE.indexOf(o.name)<=Effect.SOUND_PRECEDENCE.indexOf(n.name)?o:n},null)},Effect.expired=function(e){return anyOf(Effect.expiredSpeechBubble,Effect.zeroCount,Effect.expiredSound,Effect.expiredCursorGlow,Effect.commandHelp,Effect.expiredTimer,Effect.expiredFallingCursor,Effect.expiredFallingBlock,Effect.expiredFadeIn,Effect.expiredFadeOut,Effect.expiredRoofFade,Effect.expiredAppearingBGEffect,Effect.expiredSetRegistersOutput)(e)},Effect.unexpired=function(e){return!Effect.expired(e)};var Tile={WATER:"w",WALL:"s",TALL_WALL:"S",HOUSE_WALL:"_",WOOD:"W",PATH:".",GRASS:"g",RAMP_EAST:"<",RAMP_WEST:">",PLAIN:"+",MISSING:"M",SKY_MISSING:"m",CRACKED:"x",DARK:"*",CLOUD:"c",WHITE:"#",SAND:"~",LAVA:"l"};Tile.nonCodeTiles=Tile.WATER+Tile.WHITE+Tile.LAVA+Tile.CLOUD+Tile.PATH+Tile.GRASS+Tile.WALL+Tile.WOOD+Tile.SKY_MISSING+Tile.SAND,Tile.isCodeTile=function(e){return!Tile.nonCodeTiles.includes(e)},Tile.height=function(e){return e===Tile.MISSING||e===Tile.SKY_MISSING?-1:e===Tile.WATER||e===Tile.LAVA?0:e===Tile.HOUSE_WALL?3:e===Tile.TALL_WALL||e===Tile.RAMP_EAST||e===Tile.RAMP_WEST?2:1},Tile.at=function(e,n){return function(o){var a=Buffers.currentBuffer(o),f=a.topX,T=a.topY,S=a.bg,b=a.fillerBG;return!S[n-T+2]||!S[n-T+2][e-f+2]?b:S[n-T+2][e-f+2]}},module.exports=Tile;var Inventory={};Inventory.hasKey=function(e){return function(n){return n.inventory[e.replace("small_","")]>0}},Inventory.numberOfKeys=function(e){return function(n){return n.inventory[e.replace("small_","")]}},vim.audio=function(){"use strict";var e,n=!1,o;function a(){n=!0,e={},o=50}function f(g){if(n){var M=document.createElement("audio");return M.canPlayType("audio/mpeg")||M.canPlayType("audio/mp3")?M.setAttribute("src","sounds/"+g+".mp3"):M.canPlayType("audio/ogg")&&M.setAttribute("src","sounds/"+g+".ogg"),e[g]=M,M}}function T(g){return n?e[g]?e[g]:f(g):void 0}function S(g,M){var A=vim.view;if(n){if(M===!0){A.scheduleSoundAfterFadeIn(g);return}var O=T(g);if(!O){console.log("Can't find "+g);return}if(O.volume=o/100,O.paused&&o!==0)try{O.play()}catch(B){}}}function b(){return o}function w(g){o=g}function H(g){T(g)}return{initialize:a,play:S,prepare:H,getVolume:b,setVolume:w}}(),vim.game=function(){"use strict";var e=vim.dom,n=e.$;function o(a){var f=n("#game .screen.active")[0],T=n("#"+a)[0];f&&(e.removeClass(f,"active"),vim.screens[f.id]&&vim.screens[f.id].done&&vim.screens[f.id].done()),e.addClass(T,"active"),vim.screens[a]&&vim.screens[a].run&&vim.screens[a].run()}return{showScreen:o}}(),vim.video=function(){vim.videoMode=!0,document.getElementById("game-menu").style.display="none",document.getElementById("game").style.margin="0",document.getElementById("game").style.overflow="hidden",document.getElementById("button-desc").style.fontSize="1.4em",document.getElementById("colon-command").style.fontSize="1.5em",document.body.style.imageRendering="auto",document.styleSheets[0].addRule(".code","font-weight: bold;")},vim.socket=function(){"use strict";var e=document.location,n=e.hostname,o=e.port,a=e.origin,f,T={},S=[],b=!1,w=0,H=0,g=!1,M=!1,A=0,O=0,B=n==="localhost",G=n==="test.vim-adventures.com"&&o==="3000"||n==="beta.vim-adventures.com",U=B?["ws://localhost:3000/"]:G?[n==="test.vim-adventures.com"&&o==="3000"?"ws://test.vim-adventures.com:3001/":"wss://lnws.vim-adventures.com/"]:["wss://sfws.vim-adventures.com/","wss://usws.vim-adventures.com/","wss://euws.vim-adventures.com/"],V=U.map(function(h){return{wsUri:h,latency:1/0}});function Y(){function h(_){var y=_.wsUri.replace("ws:","http:").replace("wss:","https:")+"ping",P=window.performance.now();return fetch(y).then(function(W){return!W||!W.ok||W.status!==200?1/0:window.performance.now()-P}).then(function(W){_.latency=W,console.log("Latency for ".concat(_.wsUri," was ").concat(W))}).catch(function(){console.log("Failed to measure latency for ".concat(_.wsUri))})}Promise.all(V.map(function(_){return h(_)}))}var ve=a.includes("translate.goog");function ue(){if(g){Game.showMessage("Connection refused.<BR>Please refresh the page to try again.",!0);return}var h=w>1?"Reconnect failed. ":"Disconnected. ";h+=H?"Retry #".concat(w," in ").concat(H," seconds..."):"Retrying to connect...",Game.showMessage(h,!0)}function K(){b&&(H=Math.max(H-1,0),H==0?(b=!1,ye()):(ue(),window.setTimeout(K,1e3)))}function fe(){if(!M){if(window.performance.now()-A<1e3){g=!0,ue();return}if(!b&&(f.readyState===f.CLOSED||f.readyState===f.CLOSING)){if(w>5){Game.showMessage("Could not connect to server.<BR>Please refresh the page to try again.",!0);return}w=Math.max(1,w),H=[0,1,5,10,20,30,30][w]||30,H+=1+rnd(0)(5),b=!0,window.setTimeout(K,1e3)}}}function q(h){var _=h.data,y=JSON.parse(_),P=y.type,W=y.value;if(P==="dont-reconnect"){M=!0;var $=!!W&&W.message||"Stopped connecting to server.";W.allowReconnect&&($+='<BR><a class="reconnect-link" onClick="vim.socket.reconnect();">Click here to reconnect.</a>'),Game.showMessage($,!0),D()}else{var ie=T[P];return ie?ie(W):void 0}}function de(h){h.onerror=(f||{}).onerror||fe,h.onmessage=(f||{}).onmessage||q,h.onopen=(f||{}).onopen||function(){Game.hideMessage(),w=0,A=window.performance.now()},h.onclose=(f||{}).onclose||fe}function ye(){if(ve){Game.showMessage("VIM-Adventures can't be played<BR>via Google Translate.",!0),f={};return}V.sort(function(y,P){var W=y.latency,$=P.latency;return W-$});var h=V[0];if(!h.latency||!isFinite(h.latency)){O===0&&(console.log("Delaying connect for latency data"),Game.showMessage("Waiting for latency data...",!0),O++),O>30?h.latency=99999:(O++,setTimeout(ye,100)),f=f||{},de(f);return}console.log("Using ".concat(h.wsUri," with latency ").concat(h.latency));var _=new WebSocket(V[0].wsUri);de(_),f=_,Game.showMessage("Connecting to server...",!0),w++}function We(h,_){if(h==="message")throw new Error("Overriding onmessage will disable type to callback mapping");if(["open","close","error"].includes(h)){var y=f["on"+h];f["on"+h]=function(P){return y&&y(P),_(P)}}else T[h]=_}function Be(h){var _=typeof h!="string"?JSON.stringify(h):h;S.push(_)}function D(){f.close()}function ee(){w=0,H=0,g=!1,M=!1,A=0,ye()}function J(){if(!(!S.length||!f||f.readyState!==1))for(;S.length;){var h=S.shift();f.send(h)}}return Y(),setInterval(J,50),{open:ye,on:We,send:Be,close:D,reconnect:ee}}(),vim.client=function(){var e=!1,n=function(){};function o(){e||(vim.socket.open(),vim.socket.on("open",function(){console.log("Connected"),e=!0,n()}),vim.socket.on("error",function(b){console.log("Websocket error",b)}),vim.socket.on("close",function(){console.log("Socket closed."),e=!1}))}function a(b,w){vim.socket.on(b,w)}function f(b){vim.socket.send(b)}function T(){return e}function S(b){n=b}return{connect:o,on:a,send:f,isConnected:T,runOnConnect:S}}(),vim.input=function(){"use strict";var e=vim.dom,n=-1,o,a;function f(K){var fe=K.keyCode||K.which,q=K.shiftKey||fe===16,de=String.fromCharCode(K.charCode||K.keyCode),ye=de.toUpperCase(),We=de.toLowerCase();return ye!==We&&(de===ye&&!q||de===We&&q)}function T(K){K&&K.preventDefault?K.preventDefault():window.event&&window.event.returnValue&&(window.eventReturnValue=!1)}function S(K){var fe;return K||(K=window.event),fe=K.target?K.target:K.srcElement,fe.nodeType==3&&(fe=fe.parentNode),fe}function b(K){K.charCodeAt(0)!==127&&Game.sendKeyToServer(K)}function w(K){var fe="",q=!1;if(typeof w.escCount=="undefined"&&(w.escCount=0),detectTilde.keydown(K),K.keyCode===27||detectTilde.checkAndResetCtrlOpenBracket()?(q=!0,w.escCount++,b("ESC"),vim.screens["game-screen"].hideCommandHelp()):w.escCount=0,K.keyCode===13&&b("ENTER"),K.keyCode===8&&(b("BACKSPACE"),q=!0),K.keyCode===46&&b("DELETE"),K.keyCode===8&&(S(K).nodeName!=="INPUT"||S(K).style.visibility!=="visible")&&(q=!0),K.keyCode>=37&&K.keyCode<=40&&(q=!0,!ve()))if(!a&&o===0||vim.enforceHjkl)vim.enforceHjkl||vim.screens["game-screen"].confirmArrowKeys();else{switch(o<1&&++o,K.keyCode){case 37:fe="h";break;case 40:fe="j";break;case 38:fe="k";break;case 39:fe="l";break}fe!==""&&(vim.screens["game-screen"].isCommandHelpOn()&&vim.screens["game-screen"].hideCommandHelp(),b(fe))}return detectTilde.checkAndResetCtrlR()&&(b("CTRL-R"),q=!0),detectTilde.checkAndResetFirefoxSlash()&&(b("/"),q=!0),detectTilde.checkAndResetFirefoxSingleQuote()&&(q=!0),q?(T(K),!1):!0}function H(K){var fe=K.charCode||K.keyCode,q=String.fromCharCode(fe),de=!1,ye=!1,We=vim.screens["game-screen"];if(detectTilde.keypress(K),f(K))return Game.showMessage("Caps Lock is on. Please turn it off to play.<BR>You can use shift to type upper-case letters."),!1;if(fe>=128)return Game.showMessage("That last keystroke was not in English.<BR>Please change keyboard language to English."),!1;if(q===" "&&(detectTilde.checkAndResetTilde()||detectTilde.checkBrazilianTildeFollowedBySpaceKeypress())&&(q="~",de=!0),q===" "&&detectTilde.checkAndResetCaret()&&(detectTilde.checkAndResetSwedishCaret(),q="^",ye=!0),q===" "&&(detectTilde.checkAndResetGermanCaret()||detectTilde.checkBrazilianCaretFollowedBySpaceKeypress())&&(q="^",ye=!0),q!=="+"&&q!=="-"&&q!="_"&&q!="="&&fe!==13&&We.isCommandHelpOn()&&We.hideCommandHelp(),(q==="+"||q==="-"||q==="_"||q==="=")&&We.isCommandHelpOn()){We.traverseHelpCommandExample(q==="+"||q==="="?1:-1);return}return q>=" "&&b(q),q===" "||de||ye?(T(K),!1):!0}function g(K){detectTilde.keyup(K),detectTilde.checkAndResetSwissGermanTilde()||detectTilde.checkAndResetAnotherGermanTilde()||detectTilde.checkAndResetNorwegianFirefoxMacTilde()?b("~"):detectTilde.checkAndResetSwissGermanCaret()||detectTilde.checkAndResetFrenchCaret()?b("^"):detectTilde.checkAndResetSpanishTilde()?b("~"):detectTilde.checkAndResetSpanishCaret()?b("^"):detectTilde.checkAndResetSwedishTilde()?b("~"):detectTilde.checkAndResetSwedishCaret()||detectTilde.checkAndResetGerman3KeysCaret()?b("^"):detectTilde.checkAndResetGermanMacbookSingleQuote()?b("'"):detectTilde.checkAndResetGermanBacktickMacbook()?b("`"):detectTilde.checkIOSBluetoothSpace()?b(" "):detectTilde.checkAndResetMacBookProDoubleQuote()?b('"'):detectTilde.checkAndResetMacBookProSingleQuote()?b("'"):detectTilde.checkAndResetGermanQwertzCaret()?b("^"):detectTilde.checkAndResetGermanQwertzBacktick()&&b("`")}function M(K){detectTilde.keyup(K)}function A(K){detectTilde.keypress(K)}function O(K){detectTilde.keydown(K)}function B(K){e.unbind(window,"keypress",H),e.unbind(window,"keyup",g),e.unbind(window,"keydown",w),K!==!0&&(e.bind(window,"keydown",O),e.bind(window,"keypress",A),e.bind(window,"keyup",M))}function G(){B(!0),e.unbind(window,"keydown",O),e.unbind(window,"keypress",A),e.unbind(window,"keyup",M),e.bind(window,"keypress",H),e.bind(window,"keyup",g),e.bind(window,"keydown",w)}function U(){n!==-1&&(window.clearTimeout(n),n=-1),a=!1,o=0,G()}function V(K){B(),n=window.setTimeout(G,K)}function Y(){a=!0}function ve(){return vim.screens["game-screen"].getColonCommand()!==""}function ue(K){K.forEach(b)}return{initialize:U,disableKeys:B,enableKeys:G,enableArrowKeys:Y,suspend:V,isInColonInputMode:ve,injectMenuColonCommand:ue,preventDefault:T}}(),vim.images=function(){"use strict";var e=vim.spritesImg,n=vim.cloudsImg,o=vim.explosionImg,a,f,T,S,b,w,H=!1,g=!1,M={grass:{x:0,y:0,w:37,h:64},water:{x:0,y:67,w:37,h:64},stone:{x:0,y:134,w:37,h:64},stone_facade:{x:0,y:183,w:37,h:15},plain:{x:0,y:201,w:37,h:64},cracked:{x:0,y:268,w:37,h:64},dark:{x:0,y:335,w:37,h:64},wood:{x:0,y:402,w:37,h:64},stone_tall:{x:0,y:469,w:37,h:64},stone_tall_facade:{x:0,y:503,w:37,h:33},dirt:{x:0,y:536,w:37,h:64},shadow_east:{x:0,y:603,w:37,h:64},shadow_west:{x:0,y:670,w:37,h:64},shadow_north:{x:0,y:737,w:37,h:64},shadow_south:{x:40,y:0,w:37,h:64},shadow_north_east:{x:40,y:67,w:37,h:64},shadow_north_west:{x:40,y:134,w:37,h:64},shadow_south_east:{x:40,y:201,w:37,h:64},shadow_south_west:{x:40,y:268,w:37,h:64},ramp_west:{x:40,y:335,w:37,h:64},ramp_east:{x:40,y:402,w:37,h:64},rock:{x:40,y:469,w:37,h:64},candle:{x:40,y:536,w:37,h:64},tall_tree:{x:40,y:603,w:37,h:64},short_tree:{x:40,y:670,w:37,h:64},ugly_tree:{x:40,y:737,w:37,h:64},kid:{x:80,y:0,w:37,h:64},pink_girl:{x:80,y:67,w:37,h:64},brown_girl:{x:80,y:134,w:37,h:64},princess:{x:80,y:201,w:37,h:64},closed_door:{x:80,y:268,w:37,h:64},blue_closed_door:{x:80,y:335,w:37,h:64},yellow_key:{x:80,y:402,w:37,h:64},blue_key:{x:80,y:469,w:37,h:64},small_brown_key:{x:80,y:536,w:37,h:64},keyboard_key:{x:80,y:603,w:37,h:64},closed_chest:{x:80,y:670,w:37,h:64},open_chest:{x:80,y:737,w:37,h:64},chest_lid:{x:120,y:0,w:37,h:64},cat_girl:{x:120,y:67,w:37,h:64},horn_girl:{x:120,y:134,w:37,h:64},north_east_roof:{x:120,y:201,w:37,h:64},north_west_roof:{x:120,y:268,w:37,h:64},north_roof:{x:120,y:335,w:37,h:64},south_east_roof:{x:120,y:402,w:37,h:64},south_west_roof:{x:120,y:469,w:37,h:64},south_roof:{x:120,y:536,w:37,h:64},east_roof:{x:120,y:603,w:37,h:64},west_roof:{x:120,y:670,w:37,h:64},lava:{x:120,y:737,w:37,h:64},sand:{x:160,y:0,w:37,h:64},cloud:{x:160,y:67,w:37,h:64},white:{x:160,y:134,w:37,h:64},red_key:{x:160,y:201,w:37,h:64},red_closed_door:{x:160,y:268,w:37,h:64},red_bug_right:{x:160,y:335,w:37,h:64},red_bug_left:{x:160,y:402,w:37,h:64},green_kid:{x:160,y:469,w:37,h:64},blond_kid:{x:160,y:536,w:37,h:64},star_key:{x:160,y:603,w:37,h:64},selector:{x:160,y:670,w:37,h:64},speech:{x:200,y:0,w:101,h:171},cursor_speech:{x:200,y:180,w:101,h:171},text_speech:{x:200,y:360,w:101,h:171},text_speech_line:{x:200,y:540,w:101,h:171},big_bug_right:{x:320,y:0,w:180,h:140},big_bug_left:{x:320,y:150,w:180,h:140},cloud1:{x:0,y:0,w:216,h:86,img:"clouds"},cloud1b:{x:226,y:0,w:216,h:86,img:"clouds"},cloud4:{x:0,y:96,w:200,h:143,img:"clouds"},cloud4b:{x:210,y:96,w:200,h:143,img:"clouds"},cloud2:{x:0,y:249,w:386,h:207,img:"clouds"},cloud2b:{x:0,y:466,w:386,h:207,img:"clouds"},cloud3:{x:0,y:683,w:460,h:204,img:"clouds"},cloud3b:{x:0,y:897,w:460,h:204,img:"clouds"},explosion1:{x:0,y:0,w:37,h:64,img:"explosion"},explosion2:{x:0,y:67,w:37,h:64,img:"explosion"},explosion3:{x:0,y:134,w:37,h:64,img:"explosion"},explosion4:{x:0,y:201,w:37,h:64,img:"explosion"},explosion5:{x:0,y:268,w:37,h:64,img:"explosion"},explosion6:{x:0,y:335,w:37,h:64,img:"explosion"},explosion7:{x:0,y:402,w:37,h:64,img:"explosion"},explosion8:{x:0,y:469,w:37,h:64,img:"explosion"},explosion9:{x:0,y:536,w:37,h:64,img:"explosion"}},A=[{str:"Level",x:0,w:90},{str:"1",x:90,w:30},{str:"2",x:120,w:30},{str:"3",x:150,w:30},{str:"4",x:180,w:30},{str:"5",x:210,w:30},{str:"6",x:250,w:30},{str:"7",x:280,w:30},{str:"8",x:310,w:30},{str:"9",x:340,w:30},{str:"10",x:370,w:50},{str:"11",x:420,w:50},{str:"12",x:470,w:50},{str:"13",x:520,w:50},{str:"14",x:570,w:50}];function O(h){return typeof M[h]!="undefined"}function B(h,_){var y=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,P=_===" ",W=g||y?"#313726":"#a36d36",$=g||y?"3f5d57":"#d2ba7c",ie=g||y?"34454c":"#ae894c",pe=P?y?"#1f1f1f":"#600":g?"0646a7":"#158cef",Ae=P?y?"#ededed":"#f00":g?"447eb3":"#e2fbff",Ne=P?y?"#adadad":"#c00":g?"4761b3":"#5bc2ff",ae=0,De=5,Re=50,Ge=25,Xe=25,ze=18,$e="#fff",he="#000",Q,ne,ce;for(h.clearRect(0,0,w.width,w.height),h.fillStyle=W,h.fillRect(ae,De,4,Re),h.fillStyle=$,h.fillRect(ae+1,De+1,1,Re-2),h.fillStyle=ie,h.fillRect(ae+2,De+1,1,Re-2),h.fillStyle=pe,h.fillRect(ae+3,De+3,Ge,Xe),h.fillStyle=Ne,h.fillRect(ae+4,De+4,Ge-2,Xe-2),h.fillStyle=Ae,h.fillRect(ae+4,De+4,Ge-2,1),h.font=ze+"px Curier New",Q=h.measureText(_).width,h.fillStyle=he,ne=0;ne<3;++ne)for(ce=0;ce<3;++ce)h.fillText(_,ae+15+ce-Math.round(Q/2),De+21+ne);h.fillStyle=$e,h.fillText(_,ae+16-Math.round(Q/2),De+22)}function G(){if(!(f||T)){var h,_,y;for(y=a.getContext("2d").getImageData(0,0,e.width,e.height),h=0;h<y.data.length;h+=4)_=Math.floor(y.data[h]*.3+y.data[h+1]*.59+y.data[h+2]*.11),y.data[h]=y.data[h+1]=y.data[h+2]=_;for(f=document.createElement("canvas"),f.width=e.width,f.height=e.height,f.getContext("2d").putImageData(y,0,0),y=a.getContext("2d").getImageData(0,0,e.width,e.height),h=0;h<y.data.length;h+=4)y.data[h]=Math.floor(y.data[h]*.4),y.data[h+1]=Math.floor(y.data[h+1]*.6),y.data[h+2]=Math.floor(y.data[h+2]*.8);T=document.createElement("canvas"),T.width=e.width,T.height=e.height,T.getContext("2d").putImageData(y,0,0)}}function U(){!a&&!S&&e.complete&&n.complete&&!b&&o.complete&&(a=document.createElement("canvas"),a.width=e.width,a.height=e.height,a.getContext("2d").drawImage(e,0,0),S=document.createElement("canvas"),S.width=n.width,S.height=n.height,S.getContext("2d").drawImage(n,0,0),b=document.createElement("canvas"),b.width=o.width,b.height=o.height,b.getContext("2d").drawImage(o,0,0),w=document.createElement("canvas"),w.width=50,w.height=60,M.selector_on=M.selector)}function V(h,_){var y=a;return typeof h=="undefined"?((H||g)&&G(),y=H?f:g?T:a):h==="clouds"?y=S:h==="explosion"&&(y=o),(_==="selector"||_==="selector_on"||_==="star_key")&&(y=a),y}function Y(h){return typeof h=="undefined"?a&&e.complete:h==="clouds"?S&&n.complete:h==="explosion"?o&&o.complete:!1}function ve(h,_,y,P,W,$){typeof M[_]!="undefined"&&(U(),Y(M[_].img)&&h.drawImage(V(M[_].img,_),M[_].x,M[_].y,M[_].w,M[_].h,y,P,W,$))}function ue(h,_,y,P,W,$){typeof M[_]!="undefined"&&(U(),Y(M[_].img)&&h.drawImage(V(M[_].img,_),M[_].x,M[_].y,M[_].w,M[_].h,y,P,M[_].w*W,M[_].h*$))}function K(h,_,y,P,W){var $,ie=M[_],pe;typeof ie!="undefined"&&(pe=ie.cachedCanvas,pe||(U(),Y(ie.img)&&(pe=document.createElement("canvas"),pe.width=ie.w,pe.height=ie.h,window.setTimeout(function(){pe.getContext("2d").drawImage(V(ie.img,_),ie.x,ie.y,ie.w,ie.h,0,0,ie.w,ie.h)},1),ie.cachedCanvas=pe)),pe&&(typeof W=="undefined"?h.drawImage(pe,y,P):($=ie.h,W!==void 0&&P+$>W&&($=Math.max(0,W-P)),$>0&&h.drawImage(pe,0,0,ie.w,$,y|0,P|0,ie.w,$))))}function fe(h,_,y,P,W,$,ie,pe,Ae,Ne){typeof M[_]!="undefined"&&(U(),Y(M[_].img)&&h.drawImage(V(M[_].img,_),M[_].x+y,M[_].y+P,W,$,ie,pe,Ae,Ne))}function q(){Object.keys(M).forEach(function(h){return delete M[h].cachedCanvas})}function de(){H&&!g||(H=!0,g=!1,q())}function ye(){!H&&g||(H=!1,g=!0,q())}function We(){!H&&!g||(H=!1,g=!1,q())}function Be(h,_,y,P){var W=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1,$=6,ie=3,pe=150,Ae=25,Ne=-.1,ae=25,De=35,Re,Ge,Xe,ze,$e,he,Q,ne,ce,oe,te,Ee,Ie,Oe,Ke;for(typeof w=="undefined"&&U(),Re=w.getContext("2d",{willReadFrequently:!0}),B(Re,P,W),Ge=Re.getImageData(3,5,ae,De).data,Xe=Re.getImageData(0,0,ae,De),ze=Xe.data,$e=W?75:new Date/pe,he=0;he<De;++he)for(Q=0,ne=0,ce=(he-De/2)*Ne,oe=0;oe<ae;++oe)te=(he*ae+oe)*4,Ee=oe/ae,Ie=Math.sin(oe/$-$e)*ie*Ee,Oe=he+(Ie+ce*Ee)<<0,Ke=(Oe*ae+oe)*4,ne=(Ie-Q)*Ae,ze[te]=Ge[Ke]+ne,ze[te+1]=Ge[Ke+1]+ne,ze[te+2]=Ge[Ke+2]+ne,ze[te+3]=Ge[Ke+3],Q=Ie;Re.putImageData(Xe,3,5),h.drawImage(w,0,0,w.width,w.height,_,y,w.width,w.height)}function D(h,_,y,P){typeof w=="undefined"&&U(),B(w.getContext("2d"),P),h.drawImage(w,0,0,w.width,w.height,_,y,w.width*.6,w.height*.6)}function ee(h,_,y){var P=_,W=y+5,$="#f00",ie="#600",pe=10,Ae=0,Ne=30;h.save(),h.beginPath(),h.lineWidth=5,h.lineCap="round",h.strokeStyle=ie,h.moveTo(P+Ae,W+Ne+pe),h.lineTo(P+Ae+pe,W+Ne),h.moveTo(P+Ae,W+Ne),h.lineTo(P+Ae+pe,W+Ne+pe),h.stroke(),h.beginPath(),h.strokeStyle=$,h.moveTo(P+1+Ae,W+Ne+1+pe),h.lineTo(P+1+Ae+pe,W+1+Ne),h.moveTo(P+1+Ae,W+1+Ne),h.lineTo(P+1+Ae+pe,W+1+Ne+pe),h.stroke(),h.restore()}function J(h,_){var y=A[_],P=A[0],W=J.canvas,$,ie,pe,Ae;if(!(!_||!y)){if(!W){for(W=document.createElement("canvas"),W.width=620,W.height=40,$=W.getContext("2d"),$.font="30px Arial",Ae=0;Ae<=14;++Ae){for($.fillStyle="#000",ie=-2;ie<3;ie+=1)for(pe=-2;pe<3;pe+=1)$.fillText(A[Ae].str,A[Ae].x+pe+7,30+ie);$.fillStyle="#fff",$.fillText(A[Ae].str,A[Ae].x+7,30)}J.canvas=W,y=A[_]}h.drawImage(W,P.x,0,P.w,40,43,20,P.w,40),h.drawImage(W,y.x,0,y.w,40,43+P.w,20,y.w,40)}}return{exists:O,draw:K,drawScale:ve,drawMulScale:ue,drawPartScale:fe,drawFlag:Be,drawSmallStillFlag:D,drawToBeRemovedSign:ee,drawLevelNumber:J,toGrayScale:de,toDark:ye,toNormalColor:We,isGrayScale:function(){return H},drawTest:function(){for(var _=document.getElementById("screen"),y=_.getContext("2d"),P=100,W=1e4,$=0,ie,pe;P--;){for(W=1e4,pe=window.performance.now();W--;)K(y,"water",0,0);ie=window.performance.now(),$=$+(ie-pe)}return $/100|0}}}();var ValidKeys={};ValidKeys.isValid=function(e){return function(n){var o=e.startsWith("\\"),a=e==="CTRL-R"?"\\redo":"DXFTGNPYIASCO".includes(e)?e.toLowerCase():o?e.substr(1):e;return(o?n.validKeys.topics:n.validKeys.validKeys).includes(a)}},ValidKeys.isDisabled=function(e){return function(n){var o="DXFTGNPYIASCO".includes(e)?e.toLowerCase():e;return n.validKeys.disabledKeys.includes(o)}},ValidKeys.getNumberOfExampleSteps=function(e){return e?e.example?e.example.length:0:void 0},ValidKeys.getExtendedDescHTML=function(e,n){if(e){var o=e.cmd,a=e.desc,f=e.example,T=e.type,S=n||0,b="";if(b+="<h1>"+o+"</h1>",b+="<p class='key-type'>"+T+"</p><div class='clearBoth'></div>",a.split("\n").forEach(function(g){b+="<p>"+g+"</p>"}),b+="<div id='example'>",f&&f[S]&&f[S].text){var w=f[S].text.split("\n");b+="<p>Example: <span class='code'>"+f[S].command+"</span><br><span class='caption'>(Press '+' or '-' to move through the example)</span></p>",b+="<p class='example_text code'>";for(var H=0;H<w.length;++H)b+=w[H]+(H!==w.length-1?"<br />":"");b+="</p>",f&&f[S]&&f[S].mode&&(b+="<span class='example_mode'>"+f[S].mode+"</span>")}return b+="</div>",b}},ValidKeys.getKeyDescription=function(e){switch(e){case"h":return"Move one character to the left";case"j":return"Move one character down";case"k":return"Move one character up";case"l":return"Move one character right";case"w":return"Jump to the next beginning of word";case"e":return"Jump to the next end of word";case"b":return"Jump to the previous beginning of word";case"B":return"Jump to the previous beginning of WORD";case"x":return"Delete the character under the cursor";case"X":return"Delete the character before the cursor (Backspace)";case"W":return"Jump to the next beginning of WORD";case"E":return"Jump to the next end of WORD";case"r":return"Replace the character under the cursor with another one";case"~":return"Flip the case of the character under the cursor";case"d":return"Delete range indicated by following motion (w, e, etc). dd for the entire line.";case"D":return"Delete from the current position until the end of the line.";case"^":return"Move to the first non-space character in the current line";case"0":return"Move to the beginning of the current line";case"$":return"Move to the end of the current line";case"f":return"Move to the next occurence of a given character in the same line";case"F":return"Move to the previous occurence of a given character in the same line";case"t":return"Move to one character before the next occurence of a given character in the same line";case"T":return"Move to one character before the previous occurence of a given character in the same line";case"z":return"Scroll screen so the cursor current position will be at the top (t), bottom (b) or middle (z)";case"%":return"Move to the matching bracket or parentheses";case":":return"Enter VIM Command line mode. For a full command list, type ':help :' (without the quotes)";case";":return"Repeat the last t/T/f/F search";case",":return"Reverse the last t/T/f/F search";case"G":return"Move to the last line of the text (soft beginning of line) or to the given [count] line number";case"g":return"Use 'gg' to move to the first line of the text (soft beginning of line)";case"-":return"Move to the first non-blank character in the line above (soft beginning of line) or [count] lines above";case"+":return"Move to the first non-blank character in the line below (soft beginning of line) or [count] lines below";case"*":return"Search forward for the word nearest to the cursor";case"#":return"Search backwards for the word nearest to the cursor";case"n":return"Repeat the last */#/? or / search";case"N":return"Repeat the last */#/? or / search in the opposite direction";case"p":return"Paste the last yanked, changed, or deleted text after the current position";case"P":return"Paste the last yanked, changed, or deleted text before the current position";case'"':return'Use register {a-zA-Z0-9.%#:-"} for next delete, yank	or put (use uppercase character to append with delete and yank)';case"y":return"Yank (copy) text";case"Y":return"Linewise yank (copy) text";case"i":return"Insert text before cursor position";case"I":return"Insert text before first non-space character in the current line";case"a":return"Append text after cursor position";case"A":return"Append text at the end of the current line";case"c":return"Change range indicated by the following motion (w, e, etc.) and enter insert mode. cc for the changing the entire line.";case"C":return"Change text from current location until the end of the line. Synonym for c$.";case"s":return"Substitute current char with new text (enters insert mode).";case"S":return"Substitute current line with new text (enters insert mode). Synonym for cc.";case"o":return"Open a new line below the current line and enter insert mode.";case"O":return"Open a new line above the current line and enter insert mode.";case"{":return"Move to the empty line before the current (or previous) paragraph";case"}":return"Move to the empty line after the current (or next) paragraph";case")":return"Move to the beginning of the next sentence.";case"(":return"Move to the beginning of the current (or previous) sentence.";case"[":return"Use [{ or [( to find the first unmatched { or ( going backward from current position";case"]":return"Use ]} or ]) to find the first unmatched } or ) going forward from current position";case".":return"Repeat last change";case"H":return"To line [count] from top (Home) of window on the first non-blank character";case"M":return"To Middle line of window, on the first non-blank character";case"L":return"To line [count] from bottom of window on the first non-blank character";case"/":return"Search forward for [count]'th occurrence of search pattern specified";case"?":return"Search backward for [count]'th occurrence of search pattern specified";case"|":return"Move to column [count] in the current line";case"`":return"Jump to mark";case"'":return"Jump to the first non-blank character in the line of the specified mark (linewise motion)";case"m":return"Set mark {a-zA-Z} at cursor position";case"u":return"Undo [count] changes";case"CTRL-R":return"Redo [count] changes that were undone";case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":return"Use as a part of a number [count] before an operation or a motion to repeat it the specified number of times";case"q":return'Record typed characters into register {0-9a-zA-Z"} (uppercase to append)';case"@":return'Execute the contents of register {0-9a-z".=*+} [count] times'}return""};var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(n){var o="",a,f,T,S,b,w,H,g=0;for(n=Base64._utf8_encode(n);g<n.length;)a=n.charCodeAt(g++),f=n.charCodeAt(g++),T=n.charCodeAt(g++),S=a>>2,b=(a&3)<<4|f>>4,w=(f&15)<<2|T>>6,H=T&63,isNaN(f)?w=H=64:isNaN(T)&&(H=64),o=o+this._keyStr.charAt(S)+this._keyStr.charAt(b)+this._keyStr.charAt(w)+this._keyStr.charAt(H);return o},decode:function(n){var o="",a,f,T,S,b,w,H,g=0;for(n=n.replace(/[^A-Za-z0-9+/=]/g,"");g<n.length;)S=this._keyStr.indexOf(n.charAt(g++)),b=this._keyStr.indexOf(n.charAt(g++)),w=this._keyStr.indexOf(n.charAt(g++)),H=this._keyStr.indexOf(n.charAt(g++)),a=S<<2|b>>4,f=(b&15)<<4|w>>2,T=(w&3)<<6|H,o=o+String.fromCharCode(a),w!=64&&(o=o+String.fromCharCode(f)),H!=64&&(o=o+String.fromCharCode(T));return o=Base64._utf8_decode(o),o},_utf8_encode:function(n){n=n.replace(/\r\n/g,"\n");for(var o="",a=0;a<n.length;a++){var f=n.charCodeAt(a);f<128?o+=String.fromCharCode(f):f>127&&f<2048?(o+=String.fromCharCode(f>>6|192),o+=String.fromCharCode(f&63|128)):(o+=String.fromCharCode(f>>12|224),o+=String.fromCharCode(f>>6&63|128),o+=String.fromCharCode(f&63|128))}return o},_utf8_decode:function(n){for(var o="",a=0,f=0,T=0,S=0;a<n.length;)f=n.charCodeAt(a),f<128?(o+=String.fromCharCode(f),a++):f>191&&f<224?(T=n.charCodeAt(a+1),o+=String.fromCharCode((f&31)<<6|T&63),a+=2):(T=n.charCodeAt(a+1),S=n.charCodeAt(a+2),o+=String.fromCharCode((f&15)<<12|(T&63)<<6|S&63),a+=3);return o}};vim.fetcher=function(){"use strict";var e=vim.dom.$;function n(a,f,T,S,b,w,H,g){var M=new XMLHttpRequest,A,O,B=typeof g=="undefined"?"GET":"POST",G=document.location.hostname==="localhost"?"http://localhost/":Game.connectionDetails()["api-endpoint"]||"https://neweudb.vim-adventures.com/",U=G[G.length-1]==="/"?G:G+"/",V=a.substr(0,4)==="php/"?U+a:a;H&&typeof H=="string"&&(O=e(H)[0]),S&&(window.btoa?A="Basic "+window.btoa(S+":"+b):A="Basic "+Base64.encode(S+":"+b)),O?(O.innerHTML=w,O.style.visibility="visible"):typeof H=="function"&&H(w),M.open(B,V,!0),S&&(M.setRequestHeader("Authorization",A),M.withCredentials=!0,vim.token&&M.setRequestHeader("X-Token",vim.token)),typeof g=="string"&&M.setRequestHeader("Content-type","application/x-www-form-urlencoded"),M.onload=function(){O&&(O.style.visibility="hidden"),M.status>=200&&M.status<=299?f(M):M.status===402?vim.login.logout(!1,!0,!1,S,M.getResponseHeader("X-Activation-Date")):M.status===403?vim.login.logout(!0,!1):T(M)},M.send(typeof g=="undefined"?null:g)}function o(a,f,T,S,b){var w;typeof b=="string"?(w=e(b)[0],w.innerHTML=S,w.style.visibility="visible"):typeof b=="function"&&b(S);var H=a.type;vim.socket.on(H,function(g){vim.socket.on(H,function(){}),w&&(w.style.visibility="hidden");var M=g.status,A=g.email,O=g.activationDate;M>=200&&M<=299?f(g):M===402?vim.login.logout(!1,!0,!1,A,O):g.status===403?vim.login.logout(!0,!1):T(g)}),vim.socket.send(a)}return{getUrl:n,sendRequest:o}}();var Model={};Model.isCandleLightMode=function(e){return e.model.candleLightMode},Model.isShowNumbers=function(e){return e.model.showNumbers},Model.isShowRelativeNumbers=function(e){return e.model.showRelativeNumbers},Model.level=function(e){return e.model.level},Model.cursorHidden=function(e){return e.model.cursorHidden},Model.inputMode=function(e){return e.model.inputMode},Model.marks=function(e){return e.model.marks},Model.macroRegister=function(e){return e.model.macroRegister};var Buffers={};if(Buffers.currentBuffer=function(e){return e.buffer},typeof find=="undefined"){var base=require("./base");base.find,_readOnlyError("find"),base.join,_readOnlyError("join"),base.map,_readOnlyError("map"),base.odd,_readOnlyError("odd"),base.pipe,_readOnlyError("pipe"),base.split,_readOnlyError("split"),base.sum,_readOnlyError("sum")}var TextArea={};TextArea.at=function(e,n,o){return function(a){return find(function(f){var T=e-f.x,S=n-f.y;if(T<0||S<0)return!1;var b=TextArea.visibleText(f);return!(S>=b.length||T>=b[S].length)})((a.buffer||(o?a.buffers.buffers.find(function(f){return f.name===o}):a.buffers.buffers[a.buffers.curBufferIndex])).textareas)}},TextArea.letterAt=function(e,n){return function(o){var a=TextArea.at(e,n)(o);if(a)return TextArea.visibleText(a)[n-a.y].charAt(e-a.x)}},TextArea.letterAtByText=function(e,n){return function(o){return TextArea.visibleText(o)[n-o.y].charAt(e-o.x)}},TextArea.specialAreas=function(e){if(TextArea.specialAreas.memoValue&&e.text.length===TextArea.specialAreas.memoValue.length&&e.text===TextArea.specialAreas.memoValue)return TextArea.specialAreas.memoResult;var n=split("\xAC")(e.text),o=odd(function(g){return"\xAC"+g+"\xAC"})(n),a=0,f=o.map(function(g,M){var A=a;a=a+g.length;var O=A===0||e.text.charAt(A-1)==="\n",B=a===e.text.length||e.text.charAt(a)==="\n";return{rawStart:A,rawEnd:a-1,bol:O,eol:B,eols:o[M].split("\n").length-1+(O&&B?1:0)}}),T=pipe(odd(TextArea.specialAreaToVisibleText),map(pipe(split("\n"),map(function(g){return g.length}))))(n),S=0,b=0,w=0,H=T.reduce(function(g,M,A){var O=S,B=b,G=A%2!==0;return M.length===1?(S=S+M[0],w=w+M[0]+(G?2:0)):(w=w+M.reduce(function(U,V){return U+V.length},0)+(G?3:0),b=b+M.length-1,S=_toConsumableArray(M).pop()),A%2!==0?[].concat(_toConsumableArray(g),[_objectSpread(_objectSpread({startX:O+e.x,startY:B+e.y,endX:S+e.x-1,endY:b+e.y,visibleText:TextArea.specialAreaToVisibleText(n[A])},f[A]),TextArea.specialAreaProps(n[A]))]):g},[]);return H=H.map(function(g){return g.type==="*"&&g.visibleText===""&&g.bol&&g.originalText.charAt(g.originalText.length-1)==="\n"?_objectSpread(_objectSpread({},g),{},{emptyLine:!0}):g}),TextArea.specialAreas.memoValue=e.text,TextArea.specialAreas.memoResult=H,H},TextArea.matchSpecialArea=function(e,n){return function(o){var a=o.startX,f=o.startY,T=o.endX,S=o.endY;return n>=f&&n<=S&&f===S&&f===n&&a<=e&&T>=e||f!==S&&(n===f&&e>=a||n>f&&n<S||n===S&&e<=T)}},TextArea.specialAreaAt=function(e,n){return function(o){var a=TextArea.specialAreas(o);return a.find(TextArea.matchSpecialArea(e,n))}},TextArea.SPECIAL_TYPE_TO_VISIBLE={x:function(n){return n.charAt(1)},t:function(n){return n.charAt(1)},r:function(n){return n.charAt(2)},M:function(n){return n.charAt(1)},d:function(n){return n.slice(1)},n:function(n){return n.charAt(n.length-1)},"*":function(n){var o=parseInt(n.slice(1),10);return n.slice((""+o).length+o+3)},"+":function(n){var o=parseInt(n.slice(1),10);return n.slice((""+o).length+o+3)},_:function(n){return n.charAt(2)},o:function(n){return n.charAt(2)},h:function(n){return TextArea.SPECIAL_TYPE_TO_VISIBLE[n.charAt(1)](n.slice(1))}},TextArea.specialAreaProps=function(e){var n=e.charAt(0);if("xd_".includes(n))return{type:n};if("n".includes(n))return{type:n,stepNumber:e.slice(1,e.length-1),originalCharacter:e.charAt(e.length-1)};if("rtM".includes(n))return{type:n,originalCharacter:e.charAt(1)};if("*+".includes(n)){var o=parseInt(e.slice(1),10),a=e.slice((""+o).length+o+3),f=e.slice(2+(""+o).length,(""+o).length+o+2);return{type:n,originalText:f,inplace:a.length===f.length}}if("o".includes(n))return{type:n,requiredMark:e.charAt(1)};if(n==="h")return _objectSpread(_objectSpread({},TextArea.specialAreaProps(e.substr(1))),{},{hidden:!0})},TextArea.SPECIAL_TYPE_TO_LENGTH={x:function(){return 1},t:function(){return 1},r:function(){return 1},M:function(){return 1},o:function(){return 1},d:function(n){return n.slice(1).length},n:function(){return 1},"*":function(n){var o=parseInt(n.slice(1),10);return n.slice((""+o).length+o+4).length},"+":function(n){var o=parseInt(n.slice(1),10);return n.slice((""+o).length+o+4).length},_:function(){return 1},h:function(n){return TextArea.SPECIAL_TYPE_TO_LENGTH[n.charAt(1)](n.slice(1))}},TextArea.specialAreaToVisibleText=function(e){return TextArea.SPECIAL_TYPE_TO_VISIBLE[e.charAt(0)](e)||""},TextArea.visibleText=function(e){var n=e.text;if(TextArea.visibleText.memoValue&&n.length===TextArea.visibleText.memoValue.length&&n===TextArea.visibleText.memoValue)return TextArea.visibleText.memoResult;var o=pipe(split("\xAC"),odd(TextArea.specialAreaToVisibleText),join(""),split("\n"),function(a){return a[a.length-1]===""?a.slice(0,a.length-1):a})(n);return TextArea.visibleText.memoValue=n,TextArea.visibleText.memoResult=o,o},TextArea.lineLength=function(e){return function(n){return TextArea.visibleText(n)[e].length}},TextArea.numberOfLines=function(e){return TextArea.visibleText(e).length},TextArea.highlights=function(e){return function(n){if(typeof e=="undefined")return[];var o=[],a=TextArea.visibleText(n),f=e.substr(1),T,S=f.indexOf("\\<")===0,b=f.length>2&&f.indexOf("\\>")===f.length-2;f=(S?"\\b":"")+f.substr(S?2:0,f.length-(S?2:0)-(b?2:0))+(b?"\\b":"");for(var w=new RegExp(f,"g"),H=0;H<a.length;++H)do{var g=w.exec(a[H]);T=g&&g[0]!=="",T&&o.push({y:n.y+H,sx:n.x+g.index,ex:n.x+g.index+g[0].length-1})}while(T);return o}},TextArea.isHighlighted=function(e,n){return function(o){return function(a){var f=a.model.globalSearchStr;if(f===void 0)return!1;for(var T=TextArea.highlights(f)(o),S=0;S<T.length;++S){if(T[S].y===n&&T[S].sx<=e&&T[S].ex>=e)return!0;if(T[S].y>n)break}return!1}}},TextArea.currentStepNumber=function(e){return""+TextArea.specialAreas(e).reduce(function(n,o){var a=o.type==="n"?parseInt(o.stepNumber):999;return Math.min(n,a)},999)},TextArea.getEmptyLineSpecialArea=function(e,n,o){return function(a){return find(function(f){return f.emptyLine===!0&&f.startY===f.endY&&f.startY===n+(o?0:1)})(TextArea.specialAreas(a))}},TextArea.getEmptySpecialArea=function(e,n,o){return function(a){return find(function(f){return f.emptyLine!==!0&&n>=f.startY&&n<=f.endY&&f.startY===f.endY&&f.startY===n&&f.startX===e+(o?0:1)&&f.endX===e-1+(o?0:1)})(TextArea.specialAreas(a))}},TextArea.toJoinedOffset=function(e,n){return function(o){return TextArea.visibleText(o).map(function(a,f){return TextArea.lineLength(f)(o)+1}).slice(0,n-o.y).reduce(sum,e-o.x)}},TextArea.toPosition=function(e){return function(n){for(var o=TextArea.visibleText(n),a=0,f=e;f-o[a].length-1>=0;)f=f-o[a].length-1,a=a+1;return{x:n.x+f,y:n.y+a}}},TextArea.findMatchingBracket=function(e,n){return function(o){for(var a=TextArea.visibleText(o).join("\n"),f=TextArea.visibleText(o).map(function(G){return G.length+1}).reduce(sum,0),T="([{<",S=")]}>",b="()[]{}<>",w=TextArea.toJoinedOffset(e,n)(o);w<f&&a[w]!=="\n"&&b.indexOf(a[w])===-1;w++);var H=-1,g,M=0,A=-1,O,B;if(w<f&&a[w]!=="\n"&&(g=a[w],A=Math.floor(b.indexOf(g)/2),B=T.indexOf(g)!==-1?1:-1),A!==-1){for(;w>=0&&w<f;w=w+B)if(O=a[w],O===T[A]?M=M+1:O===S[A]&&(M=M-1),M===0){H=w;break}}return H>=0?TextArea.toPosition(H)(o):{x:e,y:n}}},module.exports={TextArea:TextArea},vim.email=function(){"use strict";var e=vim.dom,n=vim.audio,o,a,f,T,S,b,w,H,g,M,A,O,B,G,U,V,Y;function ve(){A=-1,T.style.visibility="hidden",S.style.visibility="visible",window.setTimeout(function(){O.focus()},10)}function ue(y,P,W,$){f.innerHTML=y,f.className=P,T.style.visibility="visible",S.style.visibility="hidden",A=window.setTimeout(W||ve,3e3),$&&(O=$)}function K(y){var P=(B?U:b).value.trim();y.status===200?(vim.emailaddr=P,ue("Connecting to PayPal...","ok",function(){}),fe(!0,!0)):y.status===201?y.responseText==10&&(vim.emailaddr=P,ue("Connecting to PayPal...","ok",function(){}),fe(!0,!0,y.responseText)):y.status===202&&ue((B?"Recipient's email":"Email")+" address is already licensed! Aborting.","error",function(){ve(),fe(!1,!1)})}function fe(y,P,W){if(!y){if(A!==-1&&f.className!=="error")return;A!==-1&&(window.clearTimeout(A),ve())}P||(w.style.display="none",H.style.visibility="hidden"),J(),y?o&&o(B,G,W):a&&a()}function q(y){ue("Error: "+y.responseText,"error")}function de(){var y=b.value.trim(),P=g.value.trim();y=y.replace(/\+/g,"%2b"),P=P.replace(/\+/g,"%2b"),n.play("menu_click"),y===""?ue("Please enter an email address.","error",void 0,b):y.indexOf("@")===-1?ue("Email address missing @ sign.","error",void 0,b):y.indexOf(".",y.indexOf("@"))===-1?ue("Email address appears to be invalid. Please recheck.","error",void 0,b):y!==P?ue("The two email addresses are not the same. Please recheck.","error",void 0,g):M.checked?vim.fetcher.getUrl("php/prepaymentSubscribe.php",K,q,void 0,void 0,void 0,function(){ue("Processing email information...","processing",function(){})},"email="+encodeURIComponent(y)+"&terms="+(M.checked?"true":"false")):ue("You have to read and accept the Terms of Use<BR>and Privacy Policy to buy a license.","error",void 0,M)}function ye(){var y=U.value.trim(),P=V.value.trim(),W=Y.value.trim();y=y.replace(/\+/g,"%2b"),P=P.replace(/\+/g,"%2b"),W=W.replace(/\+/g,"%2b"),n.play("menu_click"),y===""?ue("Please enter the recipient's email address.","error",void 0,U):y.indexOf("@")===-1?ue("Recipient's address missing @ sign.","error",void 0,U):y.indexOf(".",y.indexOf("@"))===-1?ue("Recipient's address appears to be invalid. Please recheck.","error",void 0,U):P===""?ue("Please enter the buyer's email address.","error",void 0,V):P.indexOf("@")===-1?ue("Buyer's address missing @ sign.","error",void 0,V):P.indexOf(".",P.indexOf("@"))===-1?ue("Buyer's address appears to be invalid. Please recheck.","error",void 0,V):P!==W?ue("The two email addresses of the buyer are not the same. Please recheck.","error",void 0,Y):vim.fetcher.getUrl("php/prepaymentSubscribe.php",K,q,void 0,void 0,void 0,function(){ue("Processing email information...","processing",function(){})},"email="+encodeURIComponent(y)+"&buyer_email="+encodeURIComponent(P)+"&gift=true")}function We(y){y&&y.preventDefault?y.preventDefault():window.event&&window.event.returnValue&&(window.eventReturnValue=!1)}function Be(y){return y.keyCode===27?(fe(!1,!1),We(y),!1):!0}function D(y){if((y.charCode===13||y.keyCode===13)&&(B?ye():de()),y.charCode===32||y.keyCode===32)return We(y),!1}function ee(y,P,W,$){B=W,G=$,f=document.getElementById(B?"gift-message":"email-message"),T=document.getElementById(B?"gift-message-tab":"email-message-tab"),S=document.getElementById(B?"gift-tab":"email-tab"),w=document.getElementById(B?"gift-dialog-overlay":"email-dialog-overlay"),H=document.getElementById("shadowOverlay"),g=document.getElementById("repeat-email"),b=document.getElementById("user-email"),M=document.getElementById("buyer-confirm-terms"),U=document.getElementById("recipient-email"),V=document.getElementById("buyer-email"),Y=document.getElementById("repeat-buyer"),O=B?U:b,o=y,a=P,A=-1,vim.screens["game-screen"].disableKeys(),H.style.visibility="visible",e.bind("#confirm-email-button","click",de),e.bind("#confirm-gift-button","click",ye),window.addEventListener("keypress",D,!1),window.addEventListener("keydown",Be,!1),B?(U.value="",V.value="",Y.value=""):(b.value="",g.value="",M.checked=""),w.style.display="block"}function J(){vim.screens["game-screen"].enableKeys(),e.unbind("#confirm-email-button","click",de),e.unbind("#confirm-gift-button","click",ye),window.removeEventListener("keypress",D,!1),window.removeEventListener("keydown",Be,!1)}function h(){return vim.emailaddr&&vim.emailaddr.length>0}function _(y,P,W,$){return ee(y,P,W,$),S.style.visibility="visible",O.focus(),!1}return{hasEmailAddress:h,confirmEmailAddress:_}}(),vim.stats=function(){"use strict";var e=1,n=[{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{},{}],o;function a(A){var O=A/1e3,B=Math.floor(O%60),G=Math.min(Math.floor(O/60),59);return isNaN(A)?"":(G===59&&(B=59),O<0?"00:00":(G<10?"0"+G:G)+":"+(B<10?"0"+B:B))}function f(){var A;for(e=1,A=0;A<n.length;++A)n[A]={}}function T(){var A;for(A=0;A<n.length;++A)delete n[A].minGroupCompletionTime,delete n[A].minGroupCompletionTimeEmail,delete n[A].minGroupKeystrokes,delete n[A].minGroupKeystrokesEmail,delete n[A].minGroupDeaths,delete n[A].minGroupDeathsEmail}function S(A,O,B){var G="",U=typeof O!="undefined"&&O!=="",V=vim.login.isPartOfAGroup()?" colspan='2'":"",Y=U&&O===A&&A!=="N/A"&&A!=="",ve=A==="No way";return ve?"<td"+V+" class='locked'>No way</td>":(vim.login.isPartOfAGroup()?Y?(G+="<td>"+(A||"N/A")+"</td>",G+="<td class='record medal'><span class='best'>Best in Group!",B.indexOf(vim.emailaddr)!==-1&&(G+="<BR>"+B.split("|").join("<BR>")),G+="</span></td>"):(G+="<td>"+(A||"N/A")+"</td>",U?(G+="<td>",G+="<span class='group-result record'>",G+="("+O+")",G+="<span class='best'>",G+="Best in group: "+O,G+="<BR>"+B.split("|").join("<BR>"),G+="</span>",G+="</td>"):G+="<td>N/A</td>"):G+="<td"+V+">"+(A||"N/A")+"</td>",G)}function b(){var A=vim.login.isPartOfAGroup(),O=A?" colspan='2'":"",B=A?"<th class='spacer'>&nbsp;</th>":"",G='<tr><th id="level-column">Level</th><th id="keys-column">Keys</th><th'+O+">Fastest Completion Time</th>"+B+"<th"+O+">Minimal Number of Keystrokes</th>"+B+"<th"+O+'>Minimal Number of "Deaths"</th></tr>',U=[{name:"1. Through the Maze",keys:"h j k l"},{name:"2. The Prophecy",keys:"w e b"},{name:"3. Into the Darkness",keys:"x B"},{name:"4. Replacing Bad",keys:"r W E"},{name:"5. Deleting Your Way",keys:"d"},{name:"6. Flipping Sides",keys:"~ $ 0 ^"},{name:"7. Inline Jumpin'",keys:"f t , ; g z"},{name:"8. Mind the GAP",keys:"* # n"},{name:"9. Prime Numbers",keys:"Digits"},{name:"10. Cut n' Paste",keys:'p y " :reg'},{name:"11. Input Buffer",keys:"c s i a o :b"},{name:"12. Bug Bash",keys:"( ) { } [ ] ia ."},{name:"13. Fill in the Blank",keys:"-- unknown --"},{name:"14. Lorem Ipsum",keys:"H M L | / ? ' ` m u"}],V="<table id=\"stat-table\" rules='groups'><thead>"+G;V+="</thead><tbody>",A&&(V+="<tr id='stats-table-header-end'><th></th><th></th><th class='personal-header'>Personal</th><th class='group-header'>Group</th><th>&nbsp;</th><th class='personal-header'>Personal</th><th class='group-header'>Group</th><th>&nbsp;</th><th class='personal-header'>Personal</th><th class='group-header'>Group</th></tr>",V+="</tbody><tbody>");for(var Y=0;Y<U.length;++Y)V+="<tr"+(Y+1>e||Y+1==13?" class='locked' ":"")+(Y===13?" id='stats-tbl-last'":"")+"><td"+(Y===0?" id='stat-tbl-first-cell' ":"")+">"+U[Y].name+"</td>",V+="<td>"+U[Y].keys+"</td>",V+=S(a(n[Y+1].bestCompletionTime),a(n[Y+1].minGroupCompletionTime),n[Y+1].minGroupCompletionTimeEmail),A&&(V+="<td>&nbsp</td>"),V+=S(n[Y+1].minKeystrokes,n[Y+1].minGroupKeystrokes,n[Y+1].minGroupKeystrokesEmail),A&&(V+="<td>&nbsp</td>"),V+=S(Y+1<8?"No way":n[Y+1].minDeaths,n[Y+1].minGroupDeaths,n[Y+1].minGroupDeathsEmail),V+="</tr>";return V+="</tbody>",V+"</table>"}function w(A){var O=A.level,B=A.valid,G=A.keystrokes,U=A.deaths,V=A.visible;return V?B?["Time:	".concat(a(Date.now()-o)),"Keystrokes:	".concat(G),O>=8?'"Deaths":	'.concat(U):""].filter(Boolean).join("\n"):"Statistics are measured\nonly when playing from\nthe beginning of the level.":""}function H(){return a(Date.now()-o)}function g(A){var O=A*1e3-(Date.now()-o);return O<0?"Time's up!":a(A*1e3-(Date.now()-o))}function M(A,O){var B,G,U,V,Y;if(typeof A!="undefined"&&A!==null)for(f(),B=A.split("_"),e=parseInt(B[0],10)||1,G=1;G<B.length;++G)B[G]!==""&&(n[G]=n[G]||{},U=n[G],V=B[G].split("-"),U.bestCompletionTime=isNaN(parseInt(V[0],10))?void 0:parseInt(V[0],10),U.minKeystrokes=isNaN(parseInt(V[1],10))?void 0:parseInt(V[1],10),U.minDeaths=isNaN(parseInt(V[2],10))?void 0:parseInt(V[2],10),U.valid=!1);if(typeof O!="undefined"&&O!==null)for(T(),B=O.substr(O.indexOf("_")+1).split(":").map(function(ve){var ue=ve.lastIndexOf("-");return ue!==-1&&ue!==ve.length-1?ve.substr(0,ue)+"}"+ve.substr(ue+1):ve}).join(":").split("}_"),B.unshift(""),G=1;G<B.length;++G)B[G]!==""&&(n[G]=n[G]||{},U=n[G],V=B[G].split("}"),Y=V[0].split(":"),U.minGroupCompletionTime=isNaN(parseInt(Y[0],10))?void 0:parseInt(Y[0],10),U.minGroupCompletionTimeEmail=Y[1],Y=V[1].split(":"),U.minGroupKeystrokes=isNaN(parseInt(Y[0],10))?void 0:parseInt(Y[0],10),U.minGroupKeystrokesEmail=Y[1],Y=V[2].split(":"),U.minGroupDeaths=isNaN(parseInt(Y[0],10))?void 0:parseInt(Y[0],10),U.minGroupDeathsEmail=Y[1])}return{resetAllStats:f,getUserStatisticsTable:b,getStatisticsStr:w,getElapsedTimeStr:H,getChallengeTimeLeft:g,unmarshal:M,setStartLevelMark:function(){o=Date.now()}}}(),vim.login=function(){"use strict";var e=vim.dom,n=e.$,o=vim.audio,a=n("#login-email")[0],f=n("#login-password")[0],T=-1,S=n("#login-form")[0],b=n("#login-message-tab")[0],w=n("#signup-email")[0],H=n("#signup-password")[0],g=n("#signup-password-retyped")[0],M=n("#signup-form")[0],A=n("#signup-message-tab")[0],O,B,G=n("#forgot-password-email")[0],U=-1,V=n("#forgot-password-form")[0],Y=n("#forgot-password-message-tab")[0],ve,ue=n("#redeemed-code")[0],K=n("#redeem-email")[0],fe=n("#redeem-repeat-email")[0],q=n("#redeem-password")[0],de=n("#redeem-password-retyped")[0],ye=n("#redeem-buyer-confirm-terms")[0],We=n("#redeem-form")[0],Be=n("#redeem-message-tab")[0],D,ee=!1;function J(t,c,m){var v=c.indexOf("<BR>")===-1?3e3:6e3;Ne(!0),n("#login-message")[0].className=t,n("#login-message")[0].innerHTML=c,S.style.display="none",b.style.display="table",m=m||Ne,t!=="processing"&&(T=window.setTimeout(m,v))}function h(t){J("error",t)}function _(t){J("processing",t)}function y(t,c){J("ok",t,c)}function P(t){t&&t.preventDefault?t.preventDefault():window.event&&window.event.returnValue&&(window.eventReturnValue=!1)}function W(t){if(t.keyCode===27){Re();return}t.keyCode===13&&(P(t),$()),t.keyCode===32&&P(t)}function $(){var t=a.value.trim(),c=f.value.trim();if(o.play("menu_click"),t===""){O=a,h("Email address can't be empty.");return}if(t.indexOf("@")===-1){O=a,h("Email address missing @ sign.");return}if(t.indexOf(".",t.indexOf("@"))===-1){O=a,h("Email address appears to be invalid. Please recheck.");return}if(c===""){O=f,h("Password can't be empty.");return}vim.fetcher.sendRequest({type:"login",value:{email:t,password:c}},Ae,ie,"Logging in ...",_)}function ie(t){h(t.responseText)}function pe(t){Ae(t,!0)}function Ae(t,c,m){var v,p;c?(v=w.value.trim(),p=H.value.trim()):m?(v=K.value.trim(),p=q.value.trim()):(v=a.value.trim(),p=f.value.trim()),rr({mail:v,password:p},t),c?ce("Password set, and user logged in successfully",t.status===202?wn:we):m?cn("Password set, and user logged in successfully",t.status===202?u:l):y("Logged in successfully",t.status===202?Ge:Re),vim.screens["game-screen"].updateLoginRelatedUI()}function Ne(t){T!==-1&&(window.clearTimeout(T),T=-1),t||(S.style.display="block",b.style.display="none",ae())}function ae(){O?(O.focus(),O=void 0):a.value.trim()===""?a.focus():f.focus()}function De(t){var c=vim.emailaddr&&vim.emailaddr.trim()!==""?vim.emailaddr.trim():"";vim.input.disableKeys(),ee=!0,t?(a.value=t.trim(),f.value=""):a.value.trim()===""&&(a.value=c),n("#shadowOverlay")[0].style.visibility="visible",Ne(!1),n("#login-dialog-overlay")[0].style.display="block",ae(),window.addEventListener("keydown",W,!1),e.bind("#login-button","click",$),e.bind("#no-password-yet-link","click",ze),e.bind("#forgot-password-link","click",$e),e.bind("#buy-license-link","click",Xe)}function Re(t,c,m){Ne(!1),window.removeEventListener("keydown",W,!1),e.unbind("#login-button","click",$),n("#login-dialog-overlay")[0].style.display="none",(typeof t!="boolean"||t===!0)&&(n("#shadowOverlay")[0].style.visibility="hidden"),ee=!1,vim.input.enableKeys(),typeof c=="boolean"&&c===!0&&vim.screens["game-screen"].openNewTermsDialog(void 0,""),typeof m=="boolean"&&m===!0&&vim.screens["game-screen"].showBuyLicense()}function Ge(){Re(!1,!0)}function Xe(){Re(!1,!1,!0)}function ze(){Re(!1),w.value=a.value,Ke()}function $e(){Re(!1),w.value=a.value,kn()}function he(t,c,m){var v=c.indexOf("<BR>")===-1?3e3:6e3;Ie(!0),n("#signup-message")[0].className=t,n("#signup-message")[0].innerHTML=c,M.style.display="none",A.style.display="table",m=m||Ie,t!=="processing"&&(T=window.setTimeout(m,v))}function Q(t){he("error",t)}function ne(t){he("processing",t)}function ce(t,c){he("ok",t,c)}function oe(t){if(t.keyCode===27){vim.newAccount=!1,we();return}t.keyCode===13&&(P(t),te()),t.keyCode===32&&P(t)}function te(){var t=w.value.trim(),c=H.value.trim(),m=g.value.trim();if(o.play("menu_click"),t===""){B=w,Q("Email address can't be empty.");return}if(t.indexOf("@")===-1){B=w,Q("Email address missing @ sign.");return}if(t.indexOf(".",t.indexOf("@"))===-1){B=w,Q("Email address appears to be invalid. Please recheck.");return}if(c===""){B=H,Q("Password can't be empty.");return}if(m!==c){B=H,Q("Password and re-entered password aren't the same");return}vim.fetcher.sendRequest({type:"signup",value:{email:t,password:c}},pe,Ee,"Storing password ...",ne)}function Ee(t){Q(t.responseText)}function Ie(t){T!==-1&&(window.clearTimeout(T),T=-1),t||(M.style.display="block",A.style.display="none",Oe())}function Oe(){B?(B.focus(),B=void 0):w.value.trim()===""?w.focus():H.value.trim()===""?H.focus():g.value.trim()===""?g.focus():H.focus()}function Ke(t){vim.input.disableKeys(),ee=!0,n("#shadowOverlay")[0].style.visibility="visible",Ie(!1),n("#signup-dialog-overlay")[0].style.display="block",Oe(),window.addEventListener("keydown",oe,!1),e.bind("#signup-button","click",te),e.bind("#signup-already-done-link","click",function(){on(),a.value=w.value,a.value&&f.focus()}),typeof t!="undefined"&&(w.value=t,H.focus())}function we(t,c){Ie(!1),window.removeEventListener("keydown",oe,!1),e.unbind("#signup-button","click",te),n("#signup-dialog-overlay")[0].style.display="none",(typeof t!="boolean"||t===!0)&&(n("#shadowOverlay")[0].style.visibility="hidden",vim.newAccount&&(vim.newAccount=!1,vim.screens["game-screen"].setColonCommand("You can use the command ':e before_darkness' (without quotes) to skip ahead to level 3 near the chest in the maze."))),ee=!1,vim.input.enableKeys(),typeof c=="boolean"&&c===!0&&vim.screens["game-screen"].openNewTermsDialog(void 0,"")}function wn(){we(!1,!0)}function on(){we(!1),Gn(!1),De()}function an(t,c,m){hn(!0),n("#forgot-password-message")[0].className=t,n("#forgot-password-message")[0].innerHTML=c,V.style.display="none",Y.style.display="table",m=m||hn,t!=="processing"&&(U=window.setTimeout(m,3e3))}function bn(t){an("error",t)}function Dn(t){an("processing",t)}function Bn(t,c){an("ok",t,c)}function nn(t){if(t.keyCode===27){Gn();return}t.keyCode===13&&(P(t),Hn()),t.keyCode===32&&P(t)}function Hn(){var t=G.value.trim();if(o.play("menu_click"),t===""){O=G,bn("Email address can't be empty.");return}if(t.indexOf("@")===-1){O=G,bn("Email address missing @ sign.");return}if(t.indexOf(".",t.indexOf("@"))===-1){O=G,bn("Email address appears to be invalid. Please recheck.");return}vim.fetcher.getUrl("php/sendResetMail.php",Rn,nr,t,"123456","Sending Password Reset Email ...",Dn)}function nr(t){bn(t.responseText)}function Rn(t){Bn(t.responseText,Gn)}function hn(t){U!==-1&&(window.clearTimeout(U),U=-1),t||(V.style.display="block",Y.style.display="none",Tn())}function Tn(){ve?(ve.focus(),ve=void 0):G.focus()}function kn(){var t=vim.emailaddr&&vim.emailaddr.trim()!==""?vim.emailaddr.trim():"";vim.input.disableKeys(),ee=!0,a.value.trim()===""?a.value=t:G.value=a.value.trim(),n("#shadowOverlay")[0].style.visibility="visible",hn(!1),n("#forgot-password-dialog-overlay")[0].style.display="block",Tn(),window.addEventListener("keydown",nn,!1),e.bind("#forgot-password-button","click",Hn),e.bind("#remembered-password-link","click",on)}function Gn(t){hn(!1),window.removeEventListener("keydown",nn,!1),e.unbind("#forgot-password-button","click",Hn),n("#forgot-password-dialog-overlay")[0].style.display="none",(typeof t!="boolean"||t===!0)&&(n("#shadowOverlay")[0].style.visibility="hidden"),ee=!1,vim.input.enableKeys()}function vn(t,c,m,v,p){jn(),c?vim.screens["game-screen"].doubleLogin():m?(Re(!0),vim.screens["game-screen"].licenseExpired(v,p)):vim.screens["game-screen"].setColonCommand("Successfully logged out.")}function jn(){vim.expiredEmail=void 0,vim.emailaddr=void 0,vim.password=void 0,vim.token=void 0,vim.groupName=void 0,vim.enforceHjkl=void 0,vim.accessToChallenges=void 0,Modernizr.localstorage&&(window.localStorage["VIM Adventures state"]="",window.localStorage["VIM Adventures password"]="",window.localStorage["VIM Adventures email"]="",window.localStorage["VIM Adventures token"]="",window.localStorage["VIM Adventures stats"]=""),a.value="",f.value="",w.value="",H.value="",g.value="",G.value="",vim.loggedIn=!1,vim.stats.resetAllStats(),vim.groupAdmin=!1,vim.terms=!0,vim.screens["game-screen"].updateLoginRelatedUI()}function ar(){return vim.loggedIn&&vim.terms===!1}function mr(t){vim.screens["game-screen"].setColonCommand(t.responseText)}function hr(){return typeof vim.groupName!="undefined"&&vim.groupName!==void 0}function _n(){return vim.groupName}function Ue(t,c,m,v,p){if(t||c)return vn(void 0,t,c,v,p);vim.loggedIn&&(vim.screens["game-screen"].setColonCommand("Logging out..."),vim.fetcher.sendRequest({type:"logout",value:{email:vim.emailaddr.trim(),password:vim.password.trim()}},vn,mr))}function rr(t,c){if(t){var m=t.mail,v=t.password;vim.emailaddr=m,vim.password=v}vim.loggedIn=c.loggedIn,vim.token=c.token,vim.enforceHjkl=!!c.enforceHjkl,vim.accessToChallenges=!!c.accessToChallenges,vim.stats.unmarshal(c.stats,c.groupStats),vim.groupName=c.groupName,vim.terms=c.status!==202,vim.groupAdmin=c.groupAdmin!==void 0}function z(t,c,m){var v=c.indexOf("<BR>")===-1?3e3:6e3;r(!0),n("#redeem-message")[0].className=t,n("#redeem-message")[0].innerHTML=c,We.style.display="none",Be.style.display="table",m=m||r,t!=="processing"&&(T=window.setTimeout(m,v))}function dn(t){z("error",t)}function In(t){z("processing",t)}function cn(t,c){z("ok",t,c)}function Ln(t){if(t.keyCode===27){vim.newAccount=!1,l();return}t.keyCode===13&&(P(t),Mn())}function Mn(){var t=K.value.trim(),c=fe.value.trim(),m=q.value.trim(),v=de.value.trim(),p=ye.checked,I=ue.value.trim();if(o.play("menu_click"),t===""){D=K,dn("Email address can't be empty.");return}if(t.indexOf("@")===-1){D=K,dn("Email address missing @ sign.");return}if(t.indexOf(".",t.indexOf("@"))===-1){D=K,dn("Email address appears to be invalid. Please recheck.");return}else if(t!==c){D=fe,dn("The two email addresses are not the same. Please recheck.");return}if(m===""){D=q,dn("Password can't be empty.");return}if(v!==m){D=de,dn("Password and re-entered password aren't the same");return}if(!p){D=ye,dn("You have to read and accept the Terms of Use<BR>and Privacy Policy to redeem a license.");return}vim.fetcher.sendRequest({type:"redeem",value:{email:t,password:m,code:I,terms:ye.checked}},On,sr,"Redeeming License ...",In)}function On(t){Ae(t,!1,!0)}function sr(t){dn(t.responseText)}function r(t){T!==-1&&(window.clearTimeout(T),T=-1),t||(We.style.display="block",Be.style.display="none",i())}function i(){D?(D.focus(),D=void 0):K.value.trim()===""?K.focus():q.value.trim()===""?q.focus():de.value.trim()===""?de.focus():q.focus()}function s(t){vim.input.disableKeys(),ee=!0,n("#shadowOverlay")[0].style.visibility="visible",r(!1),n("#redeem-dialog-overlay")[0].style.display="block",i(),window.addEventListener("keydown",Ln,!1),e.bind("#redeem-button","click",Mn),typeof t!="undefined"&&(ue.value=t,K.focus()),ye.checked=!1}function l(t,c){r(!1),ue.value="",window.removeEventListener("keydown",Ln,!1),e.unbind("#redeem-button","click",Mn),n("#redeem-dialog-overlay")[0].style.display="none",(typeof t!="boolean"||t===!0)&&(n("#shadowOverlay")[0].style.visibility="hidden",vim.newAccount&&(vim.newAccount=!1,vim.screens["game-screen"].setColonCommand("You can use the command ':e before_darkness' (without quotes) to skip ahead to level 3 near the chest in the maze."))),ee=!1,vim.input.enableKeys(),typeof c=="boolean"&&c===!0&&vim.screens["game-screen"].openNewTermsDialog(void 0,"")}function u(){l(!1,!0)}return{isPartOfAGroup:hr,getGroupName:_n,shouldUserConfirmTerms:ar,askForLoginInfo:De,choosePassword:Ke,redeemCode:s,askForResetPasswordInfo:kn,logout:Ue,updateUserInfo:rr,clearUserInfo:jn,isInDialogFlow:function(){return ee}}}();var Entity={};Entity.TYPE_TO_IMAGE_NAME={rock:"rock",chest:"closed_chest",chest_open:"open_chest",chest_lid:"chest_lid",selector:"selector",selector_on:"selector",short_tree:"short_tree",ugly_tree:"ugly_tree",tall_tree:"tall_tree",north_west_roof:"north_west_roof",north_east_roof:"north_east_roof",north_roof:"north_roof",south_west_roof:"south_west_roof",south_east_roof:"south_east_roof",south_roof:"south_roof",east_roof:"east_roof",west_roof:"west_roof",boy:"kid",green_boy:"green_kid",blond_boy:"blond_kid",pink_girl:"pink_girl",brown_girl:"brown_girl",cat_girl:"cat_girl",cursor_npc:"none",candle:"candle",small_brown_key:"small_brown_key",yellow_key:"yellow_key",blue_key:"blue_key",red_key:"red_key",star_key:"star_key",door:"closed_door",blue_door:"blue_closed_door",red_door:"red_closed_door",keyboard_key:"keyboard_key",princess:"princess",timer_start:"horn_girl",timer_stop:"horn_girl",plus_minus:"none",lights_on:"none",red_bug:"red_bug_right",red_bug_left:"red_bug_left",big_bug:"big_bug_right",big_bug_left:"red_bug_right"},Entity.typeToImageName=function(e){return Entity.TYPE_TO_IMAGE_NAME[e]},Entity.bugImageName=function(e){return e.type+(e.facing==="l"?"_left":"_right")},Entity.typeToInitialYOffset=function(e,n){return e==="key"&&n==="small_brown"?10:e==="door"||e==="keyboard_key"?3:e.includes("roof")?e.includes("south")?-31:-32:e.includes("tree")||e.includes("selector")?-3:0},vim.perfectArrows=function(){var e=Math.PI;function n(g,M,A,O){O===void 0&&(O=!1);var B=M[0],G=M[1],U=A[0],V=A[1],Y=U+(g-B)/(G-B)*(V-U);if(O===!0)if(U<V){if(Y<U)return U;if(Y>V)return V}else{if(Y>U)return U;if(Y<V)return V}return Y}function o(g,M,A,O,B){var G=Math.sin(B),U=Math.cos(B),V=g-A,Y=M-O,ve=V*U-Y*G,ue=V*G+Y*U;return[ve+A,ue+O]}function a(g,M,A,O){return Math.hypot(O-M,A-g)}function f(g,M,A,O){return Math.atan2(O-M,A-g)}function T(g,M,A,O){return[Math.cos(A)*O+g,Math.sin(A)*O+M]}function S(g,M,A,O,B){return B===void 0&&(B=.5),[g+(A-g)*B,M+(O-M)*B]}function b(g,M){return M===void 0&&(M=8),Math.floor(M*(.5+g/(e*2)%M))}function w(g,M,A,O){return Math.abs((A-g)/2/((O-M)/2))}function H(g,M,A,O,B){B===void 0&&(B={});var G=B,U=G.bow,V=U===void 0?0:U,Y=G.stretch,ve=Y===void 0?.5:Y,ue=G.stretchMin,K=ue===void 0?0:ue,fe=G.stretchMax,q=fe===void 0?420:fe,de=G.padStart,ye=de===void 0?0:de,We=G.padEnd,Be=We===void 0?0:We,D=G.flip,ee=D===void 0?!1:D,J=G.straights,h=J===void 0?!0:J,_=f(g,M,A,O),y=a(g,M,A,O),P=w(g,M,A,O);if(y<(ye+Be)*2||V===0&&ve===0||h&&[0,1,1/0].includes(P)){var W=Math.max(0,Math.min(y-ye,ye)),$=Math.max(0,Math.min(y-W,Be)),ie=T(g,M,_,W),pe=ie[0],Ae=ie[1],Ne=T(A,O,_+Math.PI,$),ae=Ne[0],De=Ne[1],Re=S(pe,Ae,ae,De,.5),Ge=Re[0],Xe=Re[1];return[pe,Ae,Ge,Xe,ae,De,_,_,_]}var ze=(b(_)%2===0?1:-1)*(ee?-1:1),$e=V+n(y,[K,q],[1,0],!0)*ve,he=S(g,M,A,O,.5),Q=he[0],ne=he[1],ce=S(g,M,A,O,.5-$e),oe=ce[0],te=ce[1],Ee=o(oe,te,Q,ne,Math.PI/2*ze);oe=Ee[0],te=Ee[1];var Ie=f(g,M,oe,te),Oe=T(g,M,Ie,ye),Ke=Oe[0],we=Oe[1],wn=f(A,O,oe,te),on=T(A,O,wn,Be),an=on[0],bn=on[1],Dn=f(oe,te,g,M),Bn=f(oe,te,A,O),nn=S(Ke,we,an,bn,.5),Hn=nn[0],nr=nn[1],Rn=S(Ke,we,an,bn,.5-$e),hn=Rn[0],Tn=Rn[1],kn=o(hn,Tn,Hn,nr,Math.PI/2*ze);hn=kn[0],Tn=kn[1];var Gn=S(oe,te,hn,Tn,.5),vn=Gn[0],jn=Gn[1];return[Ke,we,vn,jn,an,bn,Bn,Dn,_]}return{getArrow:H}}();var GAME_COLORS={regular:["#000","#555"],iregular:["#000","#fff"],d:["#a00","#a00"],id:["#000","#f00"],x:["#a00","#a00"],ix:["#000","#f00"],replaceOriginal:["rgba(85,85,85,1.0)","rgba(0,0,0,1.0)"],ireplaceOriginal:["rgba(0,0,0,1.0)","rgba(255,255,255,1.0)"],r:["rgba(170,0,0,1.0)","rgba(170,0,0,1.0)"],ir:["rgba(0,0,0,1.0)","rgba(255,0,0,1.0)"],"+":["#060","#090"],"i+":["#090","#fff"],watered:["#000","#008"],on_lava:["#fc0","#000"],d_on_lava:["#000","#500"],missing:["#fff","#f60"],imissing:["#fff","#f60"]},gameColor=function(n,o){var a=o?"i":"";return GAME_COLORS[a+n]||GAME_COLORS[a+"regular"]};Math.sign||(Math.sign=function(e){return(e>0)-(e<0)||+e});var isReviewMode=function(n){return n.challenge&&n.challenge.reviewMode},View={};View.dimensions=function(e){return{screenWidth:e.view.screenWidth,screenHeight:e.view.screenHeight,cellWidth:37,cellHeight:30,xPadding:vim.videoMode?4:8,yPadding:vim.videoMode?2:6,xCells:Math.floor(e.view.screenWidth/37),yCells:Math.floor(e.view.screenHeight/30),personSpeechSize:vim.videoMode?24:14,personSpeechLineHeight:vim.videoMode?30:20}},View.keyYOffset=function(e,n){var o=e.includes("small")?24:36,a=n%o;return-(a<o/2?a:o-a)},View.isInMiddleOfCursorCommand=function(e){return e[e.length-1].charAt(e[e.length-1].length-1)==="\xAC"},vim.view=function(){"use strict";var e,n,o,a,f,T,S,b,w,H,g,M,A=!1,O;function B(){O=new Date().getTime()}function G(r){S=0,e=r.getContext("2d"),B(),n=-1,a=!1,b=!1,w="rgba(0,0,0,1.0)",g=0,H=[],wn.initialize(),o=30}function U(r,i,s,l,u,t){var c=View.dimensions(r),m=c.cellHeight,v,p,I,E,x,N,R,F,X,Te,Ve;if(U.msgArray||(U.msgArray=[]),u.indexOf("\n")===-1?(U.msgArray[0]=u,Te=U.msgArray):(Te=u.split("\n"),Te[Te.length-1]===""&&Te.pop()),X="text_speech",Ve="text_speech_line",!(Te.length===1&&Te[0].length===0)){for(v=0,p=16*(Te.length-1),i.font='12px "Courier 10 Pitch", "Courier New", Courier, monospace',R=0;R<Te.length;R+=1)F=i.measureText(Te[R]),v=F.width>v?F.width:v;for(E=s,N=l+m+Math.floor(p/2)+2,I=E-v-13,x=N-p-20,vim.images.drawPartScale(i,X,5,65,13,13,I,x,13,13),vim.images.drawPartScale(i,X,87,65,13,13,E,x,13,13),vim.images.drawPartScale(i,Ve,5,150,23,20,I,N,23,20),vim.images.drawPartScale(i,X,87,150,13,20,E,N,13,20),vim.images.drawPartScale(i,X,20,65,1,13,I+13,x,v,13),vim.images.drawPartScale(i,X,30,150,1,13,I+23,N,v-10,13),vim.images.drawPartScale(i,X,5,79,13,71,I,x+13,13,p+7),vim.images.drawPartScale(i,X,87,79,13,71,E,x+13,13,p+7),vim.images.drawPartScale(i,X,29,79,1,71,I+13,x+13,v,p+7),vim.images.drawPartScale(i,Ve,84,109,13,12,E+11,x+13-1+Math.round(p/2)+4-5,13,12),i.fillStyle=gameColor(void 0,t)[1],R=0;R<Te.length;R+=1)i.fillText(Te[R],I+13,x+20+R*16)}}function V(r,i,s,l,u){var t,c,m,v,p,I,E,x,N,R,F;if(V.msgArray||(V.msgArray=[]),l.indexOf("\n")===-1?(V.msgArray[0]=l,R=V.msgArray):R=l.split("\n"),N="text_speech",!(R.length===1&&R[0].length===0)){for(t=0,c=0,F=0,r.font='14px "Courier 10 Pitch", "Courier New", Courier, monospace',E=0;E<R.length;E+=1)x=r.measureText(R[E]),t=x.width>t?x.width:t,c=c+16;for(c-=16,t<11&&(F=Math.round((11-t)/2),t=11),m=i+5,p=s+8-c,v=m+13+t-1,I=p+20+c,vim.images.drawPartScale(r,N,5,65,13,13,m,p,13,13),vim.images.drawPartScale(r,N,87,65,13,13,v,p,13,13),vim.images.drawPartScale(r,N,5,150,23,20,m,I,23,20),vim.images.drawPartScale(r,N,87,150,13,20,v,I,13,20),vim.images.drawPartScale(r,N,20,65,1,13,m+13,p,t-1,13),vim.images.drawPartScale(r,N,30,150,1,13,m+23,I,t-11,13),vim.images.drawPartScale(r,N,5,79,13,71,m,p+13,13,c+7),vim.images.drawPartScale(r,N,87,79,13,71,v,p+13,13,c+7),vim.images.drawPartScale(r,N,29,79,1,71,m+13,p+13,t,c+7),r.fillStyle=gameColor(void 0,u)[1],E=0;E<R.length;E+=1)r.fillText(R[E],m+13+F,p+20+E*16);R.length===1&&(R[0].charAt(0)===" "||R[0].charAt(0)===" "&&R[0].charAt(1)===" "||R[0].charAt(R[0].length-1)===" ")&&(r.save(),r.setLineDash([1,2]),r.lineWidth=1,r.lineLength=1,r.strokeStyle="#fff",R[0].charAt(0)===" "&&r.strokeRect(m+13+F-3,p+13,6,8),R[0].charAt(0)===" "&&R[0].charAt(1)===" "&&r.strokeRect(m+13+10+F-3,p+13,6,8),R[0].charAt(R[0].length-1)===" "&&R[0].length>1&&!(R[0].charAt(0)===" "&&R[0].charAt(1)===" ")&&r.strokeRect(m+13+F+t-6,p+13,6,8),r.restore())}}function Y(r,i,s,l,u,t,c){var m=View.dimensions(r),v=m.personSpeechSize,p=m.personSpeechLineHeight,I,E,x,N,R,F,X,Te,Ve,Ye,je,be=c===!0?-1:1,Fe=0;for(I=0,E=0,e.font=v+"px Arial, Helvetica, sans-serif",X=0;X<l.length;X+=1)Te=e.measureText(l[X].replace("\xAC"," ")),I=Te.width>I?Te.width:I,E=E+p;for(vim.videoMode&&(E=E-20),be===-1&&(Fe=I+25,i-=I+50),c&&(e.save(),e.scale(-1,1)),x=i+45,R=s-15-E,N=x+25+I,F=R+25+E,vim.images.drawPartScale(e,u,0,60,25,25,be*(x+Fe),R,25,25),vim.images.drawPartScale(e,u,75,60,25,25,be*(N-Fe),R,25,25),vim.images.drawPartScale(e,u,0,140,25,30,be*(x+Fe),F,25,30),vim.images.drawPartScale(e,u,75,140,25,30,be*(N-Fe),F,25,30),c?(vim.images.drawPartScale(e,u,25,60,50,25,be*(N-Fe+I),R,I,25),vim.images.drawPartScale(e,u,25,140,50,30,be*(N-Fe+I),F,I,30),vim.images.drawPartScale(e,u,25,85,50,55,be*(N-Fe+I),R+25-1,I,E+1)):(vim.images.drawPartScale(e,u,25,60,50,25,x+25,R,I,25),vim.images.drawPartScale(e,u,25,140,50,30,x+25,F,I,30),vim.images.drawPartScale(e,u,25,85,50,55,x+25,R+25-1,I,E+1)),vim.images.drawPartScale(e,u,0,85,25,55,be*(x+Fe),R+25-1,25,E+1),vim.images.drawPartScale(e,u,75,85,25,55,be*(N-Fe),R+25-1,25,E+1),c&&e.restore(),e.fillStyle=gameColor(void 0,t)[t?1:0],X=0;X<l.length;X+=1)if(t&&View.isInMiddleOfCursorCommand(l)){var rn=l[X].substr(0,l[X].length-1);l[X].charAt(l[X].length-1)==="\xAC"&&(e.fillStyle="#ff0",e.fillText("|",x+25+I-3,R+40+X*p-1),e.fillStyle=gameColor(void 0,t)[1]),e.fillText(rn+" ",x+25,R+40+X*p)}else Ve=!1,Ye=l[X],X+1===l.length&&l[X].indexOf("Press Esc to")!==-1&&(e.fillStyle="#777",Ve=!0),l[X].substr(0,2)==="^c"&&(Ve=!0,Ye=l[X].substr(2)),Ve&&(je=e.measureText(Ye).width),e.fillText(Ye,x+25+(c?-30:0)+(Ve?(I-je)/2:0),R+40+X*p)}function ve(r,i,s,l,u,t){var c,m=ve.images,v,p,I;m||(m={},ve.images=m),m[u]||(m[u]={}),m[u][i]||(m[u][i]={}),v=m[u][i][(vim.videoMode?"video-":"")+t],v||(v=document.createElement("canvas"),v.width=20,v.height=20,p=v.getContext("2d"),t?p.font='bold 18px "Comic Sans MS", Purisa, cursive':vim.videoMode?p.font="bold 20px Courier New":(p.font="18px Courier New",["d","id","x","ix","r","ir","+","i+"].includes(u)&&(p.font="bold "+p.font,I=!0)),c=gameColor(u,!1),u==="r"&&(p.save(),p.translate(10,10),p.rotate(-30*Math.PI/180),p.translate(-10,-9)),vim.videoMode?(p.fillStyle=c[0],p.fillText(i,4,15)):(I||(p.fillStyle=c[1],p.fillText(i,5,16)),p.fillStyle=c[0],p.fillText(i,4,15)),u==="r"&&p.restore(),m[u][i][(vim.videoMode?"video-":"")+t]=v),u==="r"&&(s-=10,l-=10),r.drawImage(v,s,l)}function ue(r,i,s,l,u,t,c,m,v){var p=t?[m?"#fff":v||"#0f0","#000"]:u?["#f00","#600"]:["#fff","#006"],I,E=0;u&&(E=Math.abs(S%20-10)),r.font="bold 14px Arial",I=r.measureText(i).width,s+=t?-10-8*(i<10?1:2):25-I,l-=t?c?-38:-30:15+E,r.fillStyle=p[1],r.fillText(i,s,l-1),r.fillText(i,s,l+1),r.fillText(i,s-1,l),r.fillText(i,s+1,l),r.fillText(i,s-1,l-1),r.fillText(i,s+1,l+1),r.fillText(i,s-1,l+1),r.fillText(i,s+1,l-1),r.fillStyle=p[0],r.fillText(i,s,l)}function K(r){var i=View.dimensions(r),s=i.screenWidth,l,u,t=0,c=["yellow","blue","red","small_brown","star"],m;for(u=0;u<c.length;++u){for(m=c[u]==="small_brown",l=0;l<Inventory.numberOfKeys(c[u])(r);l+=1)vim.images.drawScale(e,c[u]+"_key",vim.videoMode?s-80-(l+t)*40:s-200+(l+t)*40,40+(m?85*.2:0),50*(m?.8:1),85*(m?.8:1));t+=l}}function fe(r,i,s){var l=s.x,u=s.y;return function(t){var c=TextArea.at(r,i)(t);return c&&c.x==l&&c.y==u}}function q(r,i,s,l){var u=!0;return i<s.startY&&(u=!1),i>s.endY&&(u=!1),i===s.startY&&r<s.startX&&(u=!1),i===s.endY&&r>s.endX&&(u=!1),s.isDirectLine&&(r!==s.startX||r!==s.endX)&&(u=!1),s.reverseSelection&&typeof s.ta!="undefined"&&fe(r,i,s.ta)(l)&&(u=!u),u}function de(r){var i=View.dimensions(r),s=i.cellWidth,l=i.cellHeight,u=i.xCells,t=i.yCells;if(r.scrollMode){var c=!1,m=r.scrollMode,v=m.srcTopX,p=m.srcTopY,I=m.dstTopX,E=m.dstTopY;if(!r.scrollMode.started)r.scrollMode.started=!0,r.scrollMode.step=r.scrollMode.step||4,r.scrollMode.xOffset=0,r.scrollMode.yOffset=0,c=!0;else{var x=r.scrollMode,N=x.xOffset,R=x.yOffset,F=x.step,X=Math.abs(v-I)*s,Te=Math.abs(p-E)*l;r.scrollMode.xOffset=Math.min(N+F,X),r.scrollMode.yOffset=Math.min(R+F,Te),c=r.scrollMode.xOffset!==X||r.scrollMode.yOffset!==Te,c||(r.scrollMode.finished=!0)}var Ve=r.scrollMode,Ye=Ve.xOffset,je=Ve.yOffset,be=Math.floor((v*s+Ye*Math.sign(I-v))/s),Fe=Math.floor((p*l+je*Math.sign(E-p))/l),rn=Ye%s===0?0:I<v?-s+Ye%s:-Ye%s,xn=je%l===0?0:E<p?-l+je%l:-je%l;D(r,e,be,Fe,be+u,Fe+t,rn,xn,be-Math.min(v,I),Fe-Math.min(p,E)),c&&Re(r)}else{var pn=r.buffer,qn=pn.topX,Ze=pn.topY;D(r,e,qn,Ze,qn+u,Ze+t)}}function ye(r,i,s,l){typeof ye.bubbles=="undefined"&&(ye.bubbles=[]),ye.bubbles.push({context:r,xpos:i,ypos:s,text:l})}function We(r){var i,s;if(ye.bubbles){for(i=0;i<ye.bubbles.length;++i)s=ye.bubbles[i],U(r,s.context,s.xpos,s.ypos,s.text,!0);ye.bubbles=[]}}function Be(r,i,s,l,u){switch(i){case Tile.GRASS:vim.images.draw(r,"grass",s,l);break;case Tile.WATER:vim.images.draw(r,"water",s,l);break;case Tile.PATH:vim.images.draw(r,"dirt",s,l);break;case Tile.PLAIN:vim.images.draw(r,"plain",s,l);break;case Tile.DARK:vim.images.draw(r,"dark",s,l);break;case Tile.CRACKED:vim.images.draw(r,"cracked",s,l);break;case Tile.WOOD:vim.images.draw(r,"wood",s,l);break;case Tile.WALL:vim.images.draw(r,"stone",s,l);break;case Tile.TALL_WALL:vim.images.draw(r,"stone_tall",s,l);break;case Tile.HOUSE_WALL:u?(vim.images.draw(r,"stone_tall_facade",s,l+34),vim.images.draw(r,"stone_facade",s,l+20)):(vim.images.draw(r,"stone_tall",s,l),vim.images.draw(r,"stone",s,l-29));break;case Tile.RAMP_EAST:vim.images.draw(r,"stone",s,l+15),vim.images.draw(r,"ramp_east",s,l);break;case Tile.RAMP_WEST:vim.images.draw(r,"stone",s,l+15),vim.images.draw(r,"ramp_west",s,l);break;case Tile.WHITE:vim.images.draw(r,"white",s,l);break;case Tile.CLOUD:vim.images.draw(r,"cloud",s,l);break;case Tile.SAND:vim.images.draw(r,"sand",s,l);break;case Tile.LAVA:vim.images.draw(r,"lava",s,l);break}}function D(r,i,s,l,u,t,c,m,v,p){var I=View.dimensions(r),E=I.cellWidth,x=I.cellHeight,N=r.buffer,R=N.cursorX,F=N.cursorY,X=N.name,Te=TextArea.at(R,F,X)(r),Ve=u-s,Ye=t-l,je=r.challenge&&r.challenge.started,be=r.challenge&&r.challenge.ctf&&!r.challenge.started&&r.challenge.reviewFlag;c=c||0,m=m||0,v=v||0,p=p||0;var Fe=!1;if(de.waveValues||(de.waveValues=[],de.lastWaveUpdate=T-2e3),T-de.lastWaveUpdate>1500&&(Fe=!0,de.lastWaveUpdate=T),!de.disappearingCursorVals){de.disappearingCursorVals=[];for(var rn=0;rn<36*30;++rn)de.disappearingCursorVals.push(rn);for(var xn=0;xn<36*30;++xn){var pn=Math.floor(Math.random()*(1080-xn)),qn=de.disappearingCursorVals[xn];de.disappearingCursorVals[xn]=de.disappearingCursorVals[pn],de.disappearingCursorVals[pn]=qn}}de.disappearingCursorPixel||(de.disappearingCursorPixel=i.createImageData(1,1),de.disappearingCursorPixel.data[0]=0,de.disappearingCursorPixel.data[1]=0,de.disappearingCursorPixel.data[2]=33,de.disappearingCursorPixel.data[3]=.5),_n.x=_n.y=0;for(var Ze=-2;Ze<Ye+2;Ze+=1)for(var Qn=function(){var ke=sn+s,Me=Ze+l,Je=ke===R&&Me===F,en=ke===R&&Me===F+1,se=r.cache(sn+v)(Ze+p),Se=se.sa,xe=se.tile,gn=se.tileHeight,qe=xe===Tile.PLAIN&&se.ta&&se.ta.setRegs?Tile.WHITE:xe,Z=sn*E+c,j=Ze*x+m,Kn=(50*Me+ke)%1500;(Fe||gn===0&&typeof de.waveValues[Kn]=="undefined")&&(de.waveValues[Kn]=Math.floor(Math.random()*3)-1),gn===0?j=j+x/2-2+de.waveValues[Kn]:(qe===Tile.RAMP_EAST||qe===Tile.RAMP_WEST)&&(j=j-x/2),se.isSunk&&(j=j+7);var Cn=Se&&Se.type==="M";Cn&&(i.save(),i.translate(Z+18,j+32),i.rotate((S%40>19?2:-2)*Math.PI/180),Z=-18,j=-32);var fn=r.effects.find(function(_e){return _e.type==="appearing-background"&&_e.x===ke&&_e.y===Me});fn?(fn.alpha==null&&(fn.alpha=0),Be(i,fn.bg,Z,j,en),i.globalAlpha=fn.alpha,Be(i,qe,Z,j,en),i.globalAlpha="1.0",fn.alpha=Math.min(fn.alpha+.02,1)):Be(i,qe,Z,j,en),r.effects.filter(function(_e){return _e.type==="falling-block"&&_e.x===ke&&_e.y===Me}).forEach(function(_e){_e.width===void 0&&(_e.width=37);var Nn=_e.width;Nn>3&&(vim.images.drawScale(i,"plain",Z+(E-Nn)/2,j+19+(x-Math.floor(Nn*30/37))/2+8-Nn/5,Math.floor(Nn),Math.floor(Nn*30/37)),_e.width=_e.width/1.2)});var Pe=se.shadows;if(Pe){var Sn=0,An=0;if(Pe.north||Pe.ne||Pe.nw){var ur=r.cache(sn+v)(Ze-1+p);ur.isSunk&&!se.isSunk&&(An=7),Ze>0&&ur.tileHeight===3&&se.tileHeight===2&&(An-=14)}if(Pe.south||Pe.se||Pe.sw){var Un=r.cache(sn+v)(Ze+1+p);!se.isSunk&&Un.isSunk&&(Sn=7)}Pe.north&&vim.images.draw(i,"shadow_north",Z,j+An),!Pe.north&&!Pe.east&&Pe.ne&&r.cache(sn-1+v)(Ze-1+p).tile!==Tile.RAMP_EAST&&vim.images.draw(i,"shadow_north_east",Z,j+An),!Pe.north&&!Pe.west&&Pe.nw&&r.cache(sn+1+v)(Ze-1+p).tile!==Tile.RAMP_WEST&&vim.images.draw(i,"shadow_north_west",Z,j+An),Pe.south&&r.cache(sn+v)(Ze+1+p).tile!==Tile.RAMP_EAST&&r.cache(sn+v)(Ze+1+p).tile!==Tile.RAMP_WEST&&vim.images.draw(i,"shadow_south",Z,j+Sn),!Pe.south&&!Pe.east&&Pe.se&&r.cache(sn+1+v)(Ze+1+p).tile!==Tile.RAMP_WEST&&vim.images.draw(i,"shadow_south_east",Z,j+Sn),!Pe.south&&!Pe.west&&Pe.sw&&r.cache(sn-1+v)(Ze+1+p).tile!==Tile.RAMP_EAST&&vim.images.draw(i,"shadow_south_west",Z,j+Sn),Pe.east&&r.cache(sn+1+v)(Ze+1+p).tile!==Tile.RAMP_WEST&&vim.images.draw(i,"shadow_east",Z,j),Pe.west&&r.cache(sn-1+v)(Ze+p).tile!==Tile.RAMP_EAST&&vim.images.draw(i,"shadow_west",Z,j)}var Fn=gn>1?-14:0,En=find(Effect.textCompleted)(r.effects);En&&En.count===void 0&&(En.count=10);var tr=se.ta;if(En&&tr&&En.count>0&&En.topX===tr.x&&En.topY===tr.y&&Tile.isCodeTile(qe)&&qe!==Tile.MISSING)i.fillStyle="rgba(255,255,255,"+En.count%2+")",i.fillRect(Z+2,j+Fn+19+2,E-4,x-4);else{var tn=find(Effect.showRange)(r.effects);tn&&tn.count===void 0&&(tn.count=7),tn&&tn.count>0&&(!tn.ta||fe(ke,Me,tn.ta)(r))&&q(ke,Me,tn,r)&&(i.fillStyle=tn.color||"rgba(255,0,0,0.5)",typeof tn.inputCursorBefore=="undefined"?i.fillRect(Z+2,j+Fn+19+2,E-4,x-4):tn.inputCursorBefore?i.fillRect(Z+2,j+Fn+19+2,3,x-4):i.fillRect(Z-7+E,j+Fn+19+2,3,x-4))}se.isSunk&&(i.fillStyle="rgba(255,255,0,0.5)",i.fillRect(Z,j+19,E,x)),(se.entities||[]).filter(function(_e){return _e.type==="cursor_npc"&&!_e.invisible&&(Math.floor(T/(_e.blinkRate||400))%2===0||Je)}).forEach(function(_e){i.fillStyle=_e.fillStyle,i.fillRect(Z,j+19,E,x)}),(se.entities||[]).filter(function(_e){return _e.type==="red_bug"&&_e.frozen&&"Bram Uganda Charity".includes(_e.vol)}).forEach(function(_e){var Nn=2;i.fillStyle={Bram:"#fff",Uganda:"#f00",Charity:"rgba(0,0,255,0.5)"}[_e.vol]||"rgba(255,255,255,0)",Math.floor(T/(Nn*200))%2!==1&&i.fillRect(Z,j+19,E,x)});var yn=r.effects.find(function(_e){return _e.type==="falling-cursor"&&_e.x===ke&&_e.y===Me}),dr=r.effects.find(function(_e){return _e.type==="disappearing-cursor"&&_e.x===ke&&_e.y===Me});if(yn){yn.width||(yn.width=37);var Zn=yn.width;i.fillStyle="rgba(255,255,255,0.5)",i.fillRect(Z+(E-Zn)/2,j+19+(x-Math.floor(Zn*30/37))/2+8-Zn/5,Zn,Math.floor(Zn*30/37))}else if(dr){dr.count===void 0&&(dr.count=21);var Pn=dr.count;if(i.fillStyle="rgba(0,0,33,0.5)",Pn>14)i.fillRect(Z,j+19,E,x);else for(var Yn=0;Yn<Pn%15*72;++Yn)i.fillRect(Z+(de.disappearingCursorVals[Yn]-Math.floor(de.disappearingCursorVals[Yn]/36)*36),j+19+Math.floor(de.disappearingCursorVals[Yn]/36),1,1)}if(Je){_n.x=Z,_n.y=j+19;var br=isReviewMode(r)||Math.floor((T-O)/400)%2===0;br&&!Model.cursorHidden(r)&&(Model.inputMode(r)?(qe===Tile.MISSING||qe===Tile.SKY_MISSING?i.fillStyle="rgba(255,255,255,0.5)":i.fillStyle="rgba(0,0,33,0.5)",i.fillRect(Z,j+19,3,x)):(i.fillStyle="rgba(0,0,33,0.5)",qe!==Tile.RAMP_EAST&&qe!==Tile.RAMP_WEST&&i.fillRect(Z,j+19,E,x),qe===Tile.RAMP_EAST&&(i.beginPath(),i.moveTo(Z,j+19),i.lineTo(Z+E,j+33),i.lineTo(Z+E,j+33+x),i.lineTo(Z,j+19+x),i.fill()),qe===Tile.RAMP_WEST&&(i.beginPath(),i.moveTo(Z+E,j+19),i.lineTo(Z,j+33),i.lineTo(Z,j+33+x),i.lineTo(Z+E,j+19+x),i.fill())))}var $n=se.ta;if($n!==void 0){var cr=se.letter,er=se.highlighted,ln=se.tile,me=se.tileHeight,le=se.sa,d=se.isMatchingBracket,C=$n.sacred,L=Z+Math.floor(E*.2),re=j+Math.floor(x*.8+1+(me>1?-14:0));if(le&&le.hidden!==!0)switch(le.type){case"x":case"r":case"d":case"*":{var Ce=le.startX===ke&&le.startY===Me,He=le.endX===ke&&le.endY===Me,Le=me>1?-14:0;i.strokeStyle=ln===Tile.LAVA?"#500":"rgba(255,0,0,0.25)",i.lineWidth=2,Ce&&i.strokeRect(Z+1,j+23+Le,1,x-9),i.strokeRect(Z+1,j+20+Le,E+(He?-3:0),1),i.strokeRect(Z+1,j+x-10+26+Le,E+(He?-3:0),1),i.strokeRect(Z+1,j+x-10+26+Le+3,E+(He?-3:0),1),He&&i.strokeRect(Z+6+E-9,j+23+Le,1,x-9)}break;case"+":me==1&&(i.fillStyle="rgba(127,255,0,0.5)",i.fillRect(Z,j+19,E,x));break;case"o":{var mn=se.mark;(typeof mn=="undefined"||mn.mark!==le.requiredMark)&&(i.globalAlpha="0.5",vim.images.drawFlag(i,Z+5,j-25,le.requiredMark),i.globalAlpha="1.0")}break}if(er&&!be&&(i.fillStyle="rgba(102,204,255,0.5)",i.fillRect(Z,j+19-(me===2?15:0),E,x+(me===2?1:0))),d&&je&&!be&&(i.fillStyle="rgba(255,255,102,0.5)",i.fillRect(Z,j+19-(me===2?15:0),E,x+(me===2?1:0))),cr!==" ")if(le&&le.type==="r"&&le.hidden!==!0)ve(i,cr,L,re,"r",C),ve(i,le.originalCharacter,L,re,"completed",C);else if(le&&le.type==="*"&&le.inplace&&le.hidden!==!0)ve(i,cr,L,re,"r",C),ve(i,le.originalText.charAt(ke-le.startX),L,re,"completed",C);else if(le&&le.type==="*"&&!le.inplace&&le.hidden!==!0)ve(i,cr,L,re,le&&le.hidden!==!0?ln===Tile.LAVA?"d_on_lava":"d":"completed",C);else{var Xn=le&&le.hidden!==!0?le.type:"completed";ln===Tile.WATER?Xn="watered":ln===Tile.LAVA?Xn="on_lava":(ln===Tile.MISSING||ln===Tile.SKY_MISSING)&&(Xn="missing"),ve(i,cr,L,re,Xn,C)}if(le&&le.hidden!==!0&&(le.type==="r"||le.type==="*"&&le.inplace)){var zn=le.startX===ke&&le.startY===Me||ke===$n.x,yr=le.endX===ke&&le.endY===Me||ke===$n.x+TextArea.lineLength(Me-$n.y)($n)-1,fr=me>1?-14:0;i.strokeStyle=ln===Tile.LAVA?"#500":"rgba(170,0,0,0.5)",i.lineWidth=2,zn&&yr?(i.lineWidth=2,i.beginPath(),i.moveTo(Z+6.5,j+.5+x-9+18+fr),i.lineTo(Z+6.5+E-13,j+.5+x-9+18+fr-10),i.stroke()):i.strokeRect(Z+(zn?6.5:.5),j+.5+x-9+15+fr,E-2+(yr?-5:0)+(zn?-3:0)+(zn&&yr?-3:0),1)}}Cn&&i.restore()},sn=-2;sn<Ve+2;sn+=1)Qn();rr(r,v,p),On(r),dn(r);for(var Wn=-2;Wn<Ye+2;Wn+=1)for(var wr=function(){var ke=Jn+s,Me=Wn+l,Je=Jn*E+c,en=Wn*x+m,se=r.cache(Jn+v)(Wn+p),Se=se.ta,xe=se.sa,gn=se.tileHeight,qe=se.mark;if(!Se)return"continue";if(qe){var Z=find(function(Un){return Un.type==="set-mark"&&Un.x===ke&&Un.y===Me})(r.effects);Z&&Z.count===void 0&&(Z.count=10);var j=Z?Z.count:0,Kn=en-(j?j>5?10-j:j-1:0)*2;Z&&Z.count>0&&(Z.count=Math.max(Z.count-2,0)),vim.images.drawFlag(i,Je+5,Kn-25,qe.mark,isReviewMode(r)),xe&&xe.hidden!==!0&&xe.type==="_"&&isSupportedMark(qe.mark)&&vim.images.drawToBeRemovedSign(i,Je+5,Kn-25)}if(xe&&xe.type==="n"){var Cn=Je+10,fn=Math.floor(en+x*1.3+1+(gn>1?-14:0));ue(i,xe.stepNumber,Cn,fn,xe.stepNumber===TextArea.currentStepNumber(Se))}var Pe=Model.isShowRelativeNumbers(r),Sn=Model.isShowNumbers(r),An=Te&&Se.x===Te.x&&Se.y===Te.y;if(An&&(Sn||Pe)&&(ke===Se.x||ke===s+1&&!r.scrollMode)){var ur=Me-Se.y+1;Pe&&(ur=Math.abs(Me-F),Sn&&Me===F&&(ur=Me-Se.y+1)),ue(i,ur,Je,en,!1,!0,ke===Se.x,isReviewMode(r),(r.challenge||{}).lineNumbersColor)}},Jn=-2;Jn<Ve+2;Jn+=1)var vr=wr();for(var pr=function(ke){for(var Me=function(Un){var Fn=Un+s,En=ke+l,tr=Fn===R&&En===F+1,tn=Un*E+c,yn=ke*x+m,dr=yn,Zn=r.cache(Un+v)(ke+p),Pn=Zn.tileHeight,Yn=Zn.entities,br=(50*En+Fn)%1500;Pn===0&&(yn=yn+x/2+2+de.waveValues[br]);var $n=_toConsumableArray(Yn||[]),cr=r.effects.filter(function(me){return me.type==="collect"&&me.x===Fn&&me.y===En});cr.forEach(function(me){$n.push(me)});var er=r.effects.find(function(me){return me.type==="selector-appear"&&me.x===Fn&&me.y===En}),ln=r.effects.find(function(me){return me.type==="roof-fade"&&me.entity.x===Fn&&me.entity.y===En&&X===r.buffer.name});ln&&(ln.alpha===void 0&&(ln.alpha=1),$n.push(ln.entity)),$n.forEach(function(me){var le=me.type==="collect"?me.entity_type:me.type,d=0,C=Entity.typeToInitialYOffset(le);if(me.id&&(d=me.xOffset,C=me.yOffset),me.type==="collect"?(me.yOffset===void 0&&(me.fromChest?(me.yOffset=-20,C=me.yOffset):me.entity_type.includes("key")?(me.yOffset=C+View.keyYOffset(le,S),C=me.yOffset):me.yOffset=C,me.max=-me.step*me.count),C=me.yOffset-me.max-me.step*me.count,me.count=Math.max(me.count-1,0)):le.includes("key")&&le!=="keyboard_key"&&(C=C+View.keyYOffset(le,S)),le==="keyboard_key"){var L=me.character.charAt(0)==="\\"?me.character.substr(1):me.character;if(L!=="CTRL-R"){var re=E/2+2;vim.images.drawScale(i,Entity.typeToImageName(le),tn+d+E/5,yn+C,re,re*2),i.fillStyle="#000",i.font="13px Courier New",i.fillText(L,tn+d+17-i.measureText(L).width/2,yn+C+26)}else vim.images.drawScale(i,Entity.typeToImageName(le),tn+d-5,yn+C+1,E+10,E+2),i.fillStyle="#000",i.font="10px Courier New",i.fillText(L,tn+d+17-i.measureText(L).width/2,yn+C+26)}else if(le==="red_bug"||le==="big_bug")vn(i,tn,yn,me);else if(le==="selector_on"&&er)er.count===void 0&&(er.count=24),i.save(),i.globalAlpha=Math.min(1,Math.abs(Math.sin(f))+.25),vim.images.draw(i,Entity.typeToImageName(le),tn+(d||0),yn-E/3+(C||Entity.typeToInitialYOffset(le))),i.restore();else{var Ce=yn+18+x;r.cache(Un+v)(ke+1+p).tileHeight>1&&(Ce-=14),ln&&le.includes("roof")?i.globalAlpha=ln.alpha:tr&&le.includes("roof")&&(i.globalAlpha="0.5"),vim.images.draw(i,Entity.typeToImageName(le),tn+(d||0),(le.includes("roof")?dr:yn)-12+(C||Entity.typeToInitialYOffset(le)),Ce),ln&&le.includes("roof")&&(!r.scrollMode||r.scrollMode.finished)&&(ln.alpha=Math.max(ln.alpha-.05,0)),(ln||tr&&le.includes("roof"))&&(i.globalAlpha="1.0")}})},Je=-2;Je<Ve+2;Je+=1)Me(Je);for(var en=-2;en<Ve+2;en+=1){var se=en+s,Se=ke+l,xe=en*E+c,gn=ke*x+m,qe=r.cache(en+v)(ke+p),Z=qe.ta,j=qe.sa,Kn=r.cache(en+v)(ke-1+p),Cn=Kn.ta;if(Cn&&Se===Cn.y+TextArea.numberOfLines(Cn)&&Cn.x===se){var fn=TextArea.getEmptyLineSpecialArea(se,Se-1,!1)(Cn);fn&&fn.hidden!==!0&&se===fn.startX&&Se===fn.startY&&fn.emptyLine&&ye(i,xe-22,gn-10,fn.originalText)}if(Z){if(se===Z.x){var Pe=TextArea.getEmptyLineSpecialArea(se,Se,!0)(Z);Pe&&Pe.hidden!==!0&&se===Pe.startX&&Se===Pe.startY&&Pe.emptyLine&&ye(i,xe-22,gn-10,Pe.originalText)}(j&&j.type==="*"&&!j.inplace||j&&j.type==="+")&&j.hidden!==!0&&se===j.startX&&Se===j.startY&&V(i,xe-22,gn-15,j.originalText.substr(-1)==="\n"?j.originalText.substring(0,j.originalText.length-1):j.originalText,!0);var Sn=TextArea.getEmptySpecialArea(se,Se,!0)(Z);if(Sn&&Sn.hidden!==!0&&se===Sn.startX&&Se===Sn.startY&&!Sn.emptyLine&&V(i,xe-22,gn-10-15*(se%2),Sn.originalText,!0),se===Z.x+TextArea.lineLength(Se-Z.y)(Z)-1){var An=TextArea.getEmptySpecialArea(se,Se,!1)(Z);An&&An.hidden!==!0&&se+1===An.startX&&Se===An.startY&&V(i,xe-22+E,gn-10-15*((se+1)%2),An.originalText,!0)}}}},ir=-2;ir<Ye+2;ir+=1)pr(ir);We(r),jn(r),Mn(r),(Model.isCandleLightMode(r)||a)&&h(i,r,R-s,F-l,c,m),ee(r),isReviewMode(r)&&y(i,r);var gr=find(Effect.textCompleted)(r.effects);gr&&gr.count!==void 0&&(gr.count=Math.max(gr.count-1,0));var lr=find(Effect.showRange)(r.effects);lr&&lr.count!==void 0&&(lr.count=Math.max(lr.count-1,0)),r.effects.filter(Effect.explosion).forEach(function(ge){ge.count===void 0&&(ge.count=9);var ke=!(typeof ge.scale=="undefined"||ge.scale<=1),Me="explosion"+(9-ge.count+1),Je=r.buffer,en=Je.topX,se=Je.topY,Se=View.dimensions(r),xe=Se.cellWidth,gn=Se.cellHeight,qe=(ge.x-en)*xe+ge.xOffset,Z=(ge.y-se)*gn-5+ge.yOffset;ke?vim.images.drawMulScale(i,Me,qe,Z,ge.scale,ge.scale):vim.images.draw(i,Me,qe,Z),ge.count=Math.max(0,ge.count-1)}),r.effects.filter(Effect.bubbleUp).forEach(function(ge){ge.count===void 0&&(ge.count=30,ge.xOffset=0);var ke=r.buffer,Me=ke.topX,Je=ke.topY,en=View.dimensions(r),se=en.cellWidth,Se=en.cellHeight,xe=(ge.x-Me)*se-22+ge.xOffset;if(ge.lineBubble){var gn=(ge.y-Je)*Se-10;ye(i,xe,gn+(-30+ge.count)*4,ge.text)}else{var qe=(ge.y-Je)*Se-30;V(i,xe,qe+(-30+ge.count)*4,ge.text,!0)}ge.count=Math.max(0,ge.count-1),ge.count%16<10&&(ge.xOffset=ge.xOffset+~(~(Math.random()*3)%3)*2)}),r.effects.filter(function(ge){return ge.type==="falling-cursor"}).forEach(function(ge){var ke=ge.width;ke&&(r.effects.some(function(Me){return Effect.fadeIn(Me)||Effect.fadeOut(Me)})||(ge.width=ke/1.2,ke/1.2<3&&(ge.width=0)))}),r.effects.filter(function(ge){return ge.type==="disappearing-cursor"}).forEach(function(ge){r.effects.some(function(ke){return Effect.fadeIn(ke)||Effect.fadeOut(ke)})||(ge.count=Math.max(0,ge.count-1))});var Vn=find(function(ge){return ge.type==="selector-appear"})(r.effects);Vn&&Vn.count!==void 0&&(Vn.count=Math.max(Vn.count-1,0))}function ee(r){var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,s=find(Effect.princessFlash)(r.effects);if(s&&(i||(s.count=Math.max(s.count-1,0)),s.count%2===1)){var l=View.dimensions(r),u=l.screenWidth,t=l.screenHeight;e.fillStyle=s.color,e.fillRect(0,0,u,t)}}function J(r){n=r}function h(r,i,s,l,u,t){var c=View.dimensions(i),m=c.screenWidth,v=c.screenHeight,p=c.cellWidth,I=c.cellHeight,E,x,N,R,F,X;if(F=m,X=v,E=s*p+18+(u||0)%p,x=l*I+18+16+(t||0)%I,a){if(R=n,R===-1)return}else R=100;r.fillStyle="#000",r.fillRect(0,0,F,x-R+2),r.fillRect(0,0,E-R,X),r.fillRect(0,x+R-2,F,X-x-R+2),r.fillRect(E+R,0,F-E-R,X),N=r.createRadialGradient(E,x,0,E,x,R),N.addColorStop(0,"rgba(0,0,0,0)"),N.addColorStop(1,"rgba(255,204,0,0.75)"),r.fillStyle=N,r.fillRect(E-R,x-R,R*2,R*2),N=r.createRadialGradient(E,x,0,E,x,R+3),N.addColorStop(0,"rgba(0,0,0,0)"),N.addColorStop(1,"rgba(0,0,0,1)"),r.fillStyle=N,r.fillRect(E-R,x-R-1,R*2+1,R*2+2)}function _(r){if(!r.challenge||!r.challenge.reviewMode)return{topGap:0,bottomGap:0,sideGap:0};var i=View.dimensions(r),s=i.cellWidth,l=i.cellHeight;return{topGap:l,bottomGap:2*l,sideGap:Math.floor(1.5*s)}}function y(r,i){var s=View.dimensions(i),l=s.screenWidth,u=s.screenHeight,t=_(i),c=t.topGap,m=t.bottomGap,v=t.sideGap;r.fillStyle="rgb(30, 30, 30)",r.fillRect(0,0,l,c),r.fillRect(0,0,v,u),r.fillRect(l-v,0,v,u),r.fillRect(0,u-m,l,m),r.strokeStyle="#fff",r.lineWidth=3,r.strokeRect(v-.5,c-.5,l-2*v+1,u-c-m+1)}function P(r,i,s,l){var u=View.dimensions(r),t=u.cellWidth,c=u.cellHeight,m=r.buffer,v=m.topX,p=m.topY,I,E,x,N;I=(s-v)*t+18,E=(l-p)*c+18+16,N=150,x=i.createRadialGradient(I,E,0,I,E,N),x.addColorStop(0,"rgba(77,128,179,0.5)"),x.addColorStop(.5,"rgba(255,204,0,0.75)"),x.addColorStop(1,"rgba(0,0,0,0)"),i.save(),i.globalCompositeOperation="lighter",i.fillStyle=x,i.fillRect(I-N,E-N,N*2,N*2),i.restore()}function W(r){var i=find(function(X){return X.type==="speech"})(r.effects);if(i){var s=r.buffer,l=s.cursorX,u=s.cursorY,t=View.dimensions(r),c=t.cellWidth,m=t.cellHeight,v=i.x,p=i.y,I=i.message,E=i.flipped,x=i.automaticFadeOut;if(i.alpha===void 0&&(i.fixed=x!==!0,i.alpha=x?4:1),v!==-1&&p!==-1&&!r.scroll){if(i.fixed&&(l!==v||u!==p)&&(i.fixed=!1,i.alpha=1),(i.alpha>0||i.fixed)&&I!==""){var N=(v-r.buffer.topX)*c-12,R=(p-r.buffer.topY)*m-15;e.globalAlpha=i.alpha>1||i.fixed?"1.0":""+i.alpha,Y(r,N,R,I,"speech",!1,E),e.globalAlpha="1.0"}if(i.alpha>0&&!i.fixed){var F=I.length>1?.05:.1;i.alpha=Math.max(i.alpha-F,0)}}}}function $(r){var i,s,l,u;if(!(r.scrollMode&&!r.scrollMode.finished)){r.scrollMode?(i=r.buffer.cursorX,s=r.buffer.cursorY,l=r.scrollMode.dstTopX,u=r.scrollMode.dstTopY):(i=r.buffer.cursorX,s=r.buffer.cursorY,l=r.buffer.topX,u=r.buffer.topY);var t=find(function(Ye){return Ye.type==="cursorCommand"})(r.effects);if(!(!t&&!r.incompleteCursorCommand)){var c=t||{x:i,y:s},m=c.x,v=c.y,p=c.message,I=View.dimensions(r),E=I.cellWidth,x=I.cellHeight,N=find(function(Ye){return Ye.type==="speech"})(r.effects)||{speechX:i,speechY:s},R=N.x,F=N.y;if(typeof $.blinkCounter=="undefined"&&($.blinkCounter=0),!r.incompleteCursorCommand&&t.alpha===void 0&&(t.alpha=p.length>7?4:2),!r.incompleteCursorCommand&&t.fixed&&(i!==m||s!==v)&&(t.fixed=!1,t.alpha=1),r.incompleteCursorCommand||(t.alpha>0||t.fixed)&&p!==""&&(i!==R||s!==F)){var X=r.incompleteCursorCommand?[r.incompleteCursorCommand]:_toConsumableArray(p);View.isInMiddleOfCursorCommand(X)&&$.blinkCounter>=5&&(X[0]=X[0].slice(0,X[0].length-1)+" ");var Te=(i-l)*E-12,Ve=(s-u)*x-15;e.globalAlpha=r.incompleteCursorCommand||t.alpha>1||View.isInMiddleOfCursorCommand(X)||t.fixed?"1.0":""+t.alpha,Y(r,Te,Ve,X,"cursor_speech",!0),e.globalAlpha="1.0"}!r.incompleteCursorCommand&&t.alpha>0&&!View.isInMiddleOfCursorCommand(p)&&!t.fixed&&(t.alpha=Math.max(t.alpha-.05,0)),$.blinkCounter=($.blinkCounter+1)%10}}}function ie(r){var i=View.dimensions(r),s=i.cellWidth,l=i.xCells;if(r.limit){var u=r.limit-1+" key presses to go";e.font="30px Arial",e.fillStyle="#000";for(var t=-2;t<3;t+=1)for(var c=-2;c<3;c+=1)e.fillText(u,l*s-320+c,50+t);e.fillStyle="#fff",e.fillText(u,l*s-320,50),Ge(r)}}function pe(r){var i=Math.floor(r%60),s=Math.min(Math.floor(r/60),59);return Math.floor(r/60)>59&&(i=59),r<0?"00 : 00":("0"+s).substr(-2)+" : "+("0"+i).substr(-2)}function Ae(r){var i=View.dimensions(r),s=i.cellWidth,l=i.xCells,u=find(Effect.timerStart)(r.effects);if(u){var t=Math.floor((Date.now()-u.startTime)/1e3);if(!(!t>u.duration)){var c=pe(u.duration-t);e.font="30px Arial",e.fillStyle="#000";for(var m=-2;m<3;m+=1)for(var v=-2;v<3;v+=1)e.fillText(c,l*s-140+v,50+m);e.fillStyle="#fff",e.fillText(c,l*s-140,50),Xe(r)}}}function Ne(r){var i=r.challenge||{},s=i.started,l=i.duration;if(s){var u=View.dimensions(r),t=u.cellWidth,c=u.xCells,m=vim.stats.getChallengeTimeLeft(l);e.font="30px Arial",e.fillStyle="#000";for(var v=-2;v<3;v+=1)for(var p=-2;p<3;p+=1)e.fillText(m,c*t-140+p,50+v);e.fillStyle="#fff",e.fillText(m,c*t-140,50)}}function ae(r){var i=r.challenge||{},s=i.started,l=i.ctf,u=i.flagCount;if(!(!l||!s)){var t=View.dimensions(r),c=t.cellWidth,m=t.cellHeight,v=t.xCells,p=v*c-240,I=50,E="x "+u;vim.images.drawSmallStillFlag(e,p-c+8,I-m+2," "),e.font="30px Arial",e.fillStyle="#000";for(var x=-2;x<3;x+=1)for(var N=-2;N<3;N+=1)e.fillText(E,p+N,I+x);e.fillStyle="#fff",e.fillText(E,p,I)}}function De(r){var i,s,l=vim.stats.getStatisticsStr(r.stats).split("\n"),u,t;if(Model.level(r)!==0&&!(l.length===1&&l[0]===""))for(e.font="15px Arial",u=0;u<l.length;++u){for(e.fillStyle="#000",i=-2;i<3;i+=1)for(s=-2;s<3;s+=1)l[u].indexOf("	")===-1?e.fillText(l[u],50+s,90+i+u*20):(t=l[u].split("	"),e.fillText(t[0],50+s,90+i+u*20),e.fillText(t[1],200-e.measureText(t[1]).width+s,90+i+u*20));e.fillStyle="#fff",l[u].indexOf("	")===-1?e.fillText(l[u],50,90+u*20):(t=l[u].split("	"),e.fillText(t[0],50,90+u*20),e.fillText(t[1],200-e.measureText(t[1]).width,90+u*20))}}function Re(r){var i=View.dimensions(r),s=i.screenWidth,l=i.screenHeight,u,t,c="To skip scrolling effect, press any key.",m;for(e.font="20px Arial",m=Math.floor((s-e.measureText(c).width)/2),e.fillStyle="#000",u=-2;u<3;u+=1)for(t=-2;t<3;t+=1)e.fillText(c,m+t,l-100+u);e.fillStyle="#aaa",e.fillText(c,m,l-100)}function Ge(r){var i=View.dimensions(r),s=i.screenWidth,l=i.screenHeight,u,t,c="Press Esc twice to cancel the current trial with the limited keystores text.",m;if(!r.scrollMode&&!(g<3)){for(vim.screens["game-screen"].getColonCommand()||g--,e.globalAlpha=(g<20?"0."+g*5:"1.0").substr(0,3),e.font="20px Arial",m=Math.floor((s-e.measureText(c).width)/2),e.fillStyle="#000",u=-2;u<3;u+=1)for(t=-2;t<3;t+=1)e.fillText(c,m+t,l-100+u);e.fillStyle="#aaa",e.fillText(c,m,l-100),e.globalAlpha="1.0"}}function Xe(r){var i=View.dimensions(r),s=i.screenWidth,l=i.screenHeight,u,t,c="Press Esc twice to cancel the timer and restore your position.",m;if(!r.scrollMode&&!(g<3)){for(g--,e.globalAlpha=(g<20?"0."+g*5:"1.0").substr(0,3),e.font="20px Arial",m=Math.floor((s-e.measureText(c).width)/2),e.fillStyle="#000",u=-2;u<3;u+=1)for(t=-2;t<3;t+=1)e.fillText(c,m+t,l-100+u);e.fillStyle="#aaa",e.fillText(c,m,l-100),e.globalAlpha="1.0"}}function ze(r){vim.images.drawLevelNumber(e,Model.level(r))}function $e(r){var i=View.dimensions(r),s=i.screenHeight,l=Model.macroRegister(r),u,t,c="".concat(Model.inputMode(r)?"-- INSERT --":"").concat(l?"recording @"+l:"");if(c!==""){for(e.font="30px Arial",e.fillStyle="#000",u=-2;u<3;u+=1)for(t=-2;t<3;t+=1)e.fillText(c,60+t,s-40+u);e.fillStyle="#fff",e.fillText(c,60,s-40)}}function he(r){var i=window.performance.now(),s=_objectSpread(_objectSpread({},Game.currentGameState()),{},{effects:Game.currentGameEffects(),cache:Game.cellCache,scrollMode:Game.currentScrollMode()});if(!s.model){requestAnimationFrame(he);return}if(_typeof(he.lastTime)===void 0&&(he.lastTime=1),he.fpsArray||(he.fpsArray=[0,0,0,0,0]),M=1/(i-he.lastTime),he.fpsArray.shift(),he.fpsArray.push(M),M=Math.max.apply(Math,he.fpsArray),!vim.gameEnded&&r-he.lastTime<1e3/o){requestAnimationFrame(he);return}he.lastTime=i;try{Dn(s)}catch(l){console.log("View error: ",l)}requestAnimationFrame(he)}function Q(r){var i=View.dimensions(r),s=i.screenWidth,l=i.screenHeight,u=i.cellWidth,t=i.cellHeight,c,m,v,p,I,E=r.buffer.topX*3,x=r.buffer.topY*3;if(!Q.stars)for(Q.stars=[],v=0;v<300;++v)I={x:Math.floor(Math.random()*s*4),y:Math.floor(Math.random()*l*4),w:Math.floor(Math.random()*5)*2+1,delay:Math.floor(Math.random()*5)+1},Q.stars.push(I);for(e.save(),e.strokeStyle="rgba(255,255,255,0.2)",r.scrollMode&&(E+=r.scrollMode.xOffset/u*3,x+=r.scrollMode.yOffset/t*3),v=0;v<Q.stars.length;++v)for(I=Q.stars[v],c=Math.floor(S%(I.delay*I.w)/I.delay),m=c<I.w/2?c:I.w-c-1,p=-m-2;p<m+2;++p)e.beginPath(),e.moveTo(I.x-p-E,I.y-x),e.lineTo(I.x+p-E,I.y-x),e.stroke(),e.moveTo(I.x-E,I.y-p-x),e.lineTo(I.x-E,I.y+p-x),e.stroke();e.restore()}function ne(r){if(!(r.buffer.name!=="sky"&&(!r.challenge||r.challenge.background!=="sky"))){var i=View.dimensions(r),s=i.screenWidth,l=i.screenHeight,u=Model.level(r)>13;ne.dayGrad||(ne.nightGrad=e.createLinearGradient(0,0,0,l),ne.nightGrad.addColorStop(0,"#1c3161"),ne.nightGrad.addColorStop(1,"#000"),ne.dayGrad=e.createLinearGradient(0,0,0,l),ne.dayGrad.addColorStop(0,"#366797"),ne.dayGrad.addColorStop(.5,"#4f84b6"),ne.dayGrad.addColorStop(1,"#96bad9"),ne.dayGradGrayScale=e.createLinearGradient(0,0,0,l),ne.dayGradGrayScale.addColorStop(0,"#5E5E5E"),ne.dayGradGrayScale.addColorStop(.5,"#808080"),ne.dayGradGrayScale.addColorStop(1,"#B3B3B3")),e.fillStyle=u?ne.nightGrad:vim.images.isGrayScale()?ne.dayGradGrayScale:ne.dayGrad,e.fillRect(0,0,s,l),u&&Q(r)}}function ce(r){var i=View.dimensions(r),s=i.screenWidth,l=i.screenHeight,u,t;if(!(r.buffer.name!=="sky"||Model.level(r)>13)){if(!ce.clouds)for(ce.clouds=[],t=ce.clouds,u=0;u<5;++u)t.push({cloudType:"cloud"+Math.floor(Math.random()*4)+"b",cloudScale:Math.floor(Math.random()*2)+1,cloudSpeed:Math.floor(Math.random()*5)+1,cloudYPos:Math.floor(Math.random()*l),cloudXPos:Math.floor(Math.random()*s)});for(S%100===0&&Math.random()>.5&&ce.clouds.push({cloudType:"cloud"+Math.floor(Math.random()*4)+"b",cloudScale:Math.floor(Math.random()*2)+1,cloudSpeed:Math.floor(Math.random()*5)+1,cloudYPos:Math.floor(Math.random()*l),cloudXPos:s}),t=ce.clouds,t.length>0&&t[0].cloudXPos+460*t[0].cloudScale<0&&t.splice(0,1),e.globalAlpha="0.8",u=0;u<t.length;++u)vim.images.drawMulScale(e,t[u].cloudType,t[u].cloudXPos,t[u].cloudYPos,t[u].cloudScale,t[u].cloudScale),t[u].cloudXPos-=t[u].cloudSpeed;e.globalAlpha="1.0"}}function oe(r){var i=View.dimensions(r),s=i.screenWidth,l=i.screenHeight,u,t;if(!(r.buffer.name!=="sky"||Model.level(r)>13)){if(!oe.clouds)for(oe.clouds=[],t=oe.clouds,u=0;u<5;++u)t.push({cloudType:"cloud"+Math.floor(Math.random()*4),cloudScale:1,cloudSpeed:Math.floor(Math.random()*10)+2,cloudYPos:Math.floor(Math.random()*l),cloudXPos:Math.floor(Math.random()*s)});for(S%100===0&&Math.random()>.5&&oe.clouds.push({cloudType:"cloud"+Math.floor(Math.random()*4),cloudScale:1,cloudSpeed:Math.floor(Math.random()*10)+2,cloudYPos:Math.floor(Math.random()*l),cloudXPos:s}),t=oe.clouds,t.length>0&&t[0].cloudXPos+460*t[0].cloudScale<0&&t.splice(0,1),e.globalAlpha="0.8",u=0;u<t.length;++u)vim.images.drawMulScale(e,t[u].cloudType,t[u].cloudXPos,t[u].cloudYPos,t[u].cloudScale,t[u].cloudScale),t[u].cloudXPos-=t[u].cloudSpeed;e.globalAlpha="1.0"}}var te=Oe.bind(null,"#43c6ac","#191654");function Ee(r){if(r.challenge){var i=vim.images.isGrayScale(),s={breakfast:te,matrix:we}[r.challenge.background]||function(){};s(r,i)}}function Ie(r){var i=r.replace("#","").match(/.{1,2}/g).map(function(v){return parseInt(v,16)}),s=_slicedToArray(i,3),l=s[0],u=s[1],t=s[2],c=Math.round(Number(l*.3+u*.59+t*.11)).toString(16),m=("0"+c).substr(-2);return"#"+m+m+m}function Oe(r,i,s,l){var u=View.dimensions(s),t=u.screenWidth,c=u.screenHeight;Oe.cache||(Oe.cache={});var m="".concat(r,"-").concat(i);if(!Oe.cache[m]){var v=e.createLinearGradient(0,0,0,c);v.addColorStop(0,r),v.addColorStop(1,i),Oe.cache[m]=v;var p=e.createLinearGradient(0,0,0,c);p.addColorStop(0,Ie(r)),p.addColorStop(1,Ie(i)),Oe.cache[m+"G"]=p}e.fillStyle=Oe.cache[m+(l?"G":"")],e.fillRect(0,0,t,c)}function Ke(){var r=we.ctx,i=we.canvas.width,s=we.canvas.height,l=12;Ke.yValues||(Ke.yValues=new Array(Math.ceil(i/l)).fill(-l)),r.fillStyle="rgba(0, 0, 0, 0.04)",r.fillRect(0,0,i,s),r.fillStyle="#0f4a",r.font=l+"px arial";var u="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%+-/~{[|`]}".split("");Ke.yValues.forEach(function(t,c){var m=choose(1)(u);t>=0&&t<s&&r.fillText(m,c*l,t),t>s?Ke.yValues[c]=-l:t===-l?Math.random()>.975&&(Ke.yValues[c]=0):Ke.yValues[c]+=l})}function we(r,i){if(!(!r.challenge||r.challenge.background!=="matrix")){var s=View.dimensions(r),l=s.screenWidth,u=s.screenHeight;if(we.canvas||(we.canvas=document.createElement("canvas"),we.canvas.width=l,we.canvas.height=u,we.ctx=we.canvas.getContext("2d")),i){if(we.interval||(clearInterval(Ke),we.interval=void 0),!we.grayscaleCanvas){we.grayscaleCanvas=document.createElement("canvas"),we.grayscaleCanvas.width=l,we.grayscaleCanvas.height=u,we.grayscaleCtx=we.grayscaleCanvas.getContext("2d");for(var t=we.ctx.getImageData(0,0,l,u),c=0;c<t.data.length;c+=4){var m=Math.floor(t.data[c]*.3+t.data[c+1]*.59+t.data[c+2]*.11);t.data[c]=t.data[c+1]=t.data[c+2]=m}we.grayscaleCtx.putImageData(t,0,0)}}else we.interval||(we.interval=setInterval(Ke,80));e.drawImage(i?we.grayscaleCanvas:we.canvas,0,0)}}var wn=function(){var r=[],i=null,s=null,l=null,u=null,t=null,c=null,m=null;function v(){i=e,s=document.createElement("canvas"),l=s.getContext("2d"),u=document.createElement("canvas"),t=u.getContext("2d");var N=i.createRadialGradient(6,6,0,6,6,6);N.addColorStop(0,"rgba(30, 30, 30, 0)"),N.addColorStop(1,"rgba(30, 30, 30, 1)"),t.fillStyle=N,t.beginPath(),t.arc(6,6,6,0,2*Math.PI,!1),t.fill(),c=document.createElement("canvas"),m=c.getContext("2d");var R=i.createRadialGradient(3,3,1,3,3,4);R.addColorStop(0,"rgba(255, 255, 255, 1)"),R.addColorStop(1,"rgba(0, 0, 0, 0)"),m.fillStyle=R,m.beginPath(),m.arc(3,3,20,0,2*Math.PI,!1),m.fill(),p(12)}function p(N){var R=N*10;s.width=R,s.height=R,l.globalCompositeOperation="source-over";for(var F=0;F<100;F++){var X=F*N,Te=X%R,Ve=Math.floor(X/R)*N;l.fillStyle="hsl("+Math.round(F*3.6)+",100%,60%)",l.beginPath(),l.arc(Te+6,Ve+6,5,0,2*Math.PI,!1),l.fill(),l.drawImage(u,Te,Ve)}}function I(){for(var N=r.length;N--;){var R=r[N];R.update()&&(r.splice(N,1),R.usePhysics||(Math.random()<.8?an.star(R):an.circle(R))),R.render(i,s,c)}}function E(N,R,F,X,Te){N=N||{},R=R||{},F=F||{},r.push(new on({x:N.x||(window.innerWidth-40)*.5,y:N.y||window.innerHeight-50+10},{y:R.y||150+Math.random()*100},{x:F.x||Math.random()*3-1.5,y:F.y||0},X||Math.floor(Math.random()*100)*12,Te))}function x(){for(var N=0,R=r.length;R--;)r[R].usePhysics||++N;return N}return{initialize:v,createParticle:E,getNumberOfFireworks:x,drawFireworks:I,bigGlowCanvas:u,smallGlowCanvas:c}}(),on=function(i,s,l,u,t){this.GRAVITY=.06,this.alpha=1,this.easing=Math.random()*.02,this.fade=Math.random()*.1,this.gridX=u%120,this.gridY=Math.floor(u/120)*12,this.color=u,this.pos={x:i.x||0,y:i.y||0},this.vel={x:l.x||0,y:l.y||0},this.lastPos={x:this.pos.x,y:this.pos.y},this.target={y:s.y||0},this.usePhysics=t||!1};on.prototype={update:function(){var i=window.innerHeight-50;if(this.lastPos.x=this.pos.x,this.lastPos.y=this.pos.y,this.usePhysics)this.vel.y+=this.GRAVITY,this.pos.y+=this.vel.y,this.alpha-=this.fade;else{var s=this.target.y-this.pos.y;this.pos.y+=s*(.03+this.easing),this.alpha=Math.min(s*s*5e-5,1)}return this.pos.x+=this.vel.x,this.alpha<.005||this.usePhysics&&this.pos.y>i},render:function(i,s,l){var u=Math.round(this.pos.x),t=Math.round(this.pos.y),c=(u-this.lastPos.x)*-5,m=(t-this.lastPos.y)*-5;i.save(),i.globalAlpha=Math.random()*this.alpha,i.fillStyle="rgba(255,255,255,0.3)",i.beginPath(),i.moveTo(this.pos.x,this.pos.y),i.lineTo(this.pos.x+1.5,this.pos.y),i.lineTo(this.pos.x+c,this.pos.y+m),i.lineTo(this.pos.x-1.5,this.pos.y),i.closePath(),i.fill(),i.drawImage(s,this.gridX,this.gridY,12,12,u-6,t-6,12,12),i.drawImage(l,u-3,t-3),i.restore()}};var an={circle:function(i){for(var s=100,l=Math.PI*2/s;s--;){var u=4+Math.random()*4,t=s*l;wn.createParticle(i.pos,null,{x:Math.cos(t)*u,y:Math.sin(t)*u},i.color,!0)}},star:function(i){var s=6+Math.round(Math.random()*15),l=3+Math.round(Math.random()*7),u=10,t=80,c=-(Math.random()*3-6),m=0,v=0,p=Math.PI*2,I=Math.random()*p;do{m=v,v=(v+l)%s;for(var E=m/s*p-I,x=(m+l)/s*p-I,N={x:i.pos.x+Math.cos(E)*t,y:i.pos.y+Math.sin(E)*t},R={x:i.pos.x+Math.cos(x)*t,y:i.pos.y+Math.sin(x)*t},F={x:R.x-N.x,y:R.y-N.y,a:x-E},X=0;X<u;X++){var Te=X/u,Ve=E+Te*F.a;wn.createParticle({x:N.x+Te*F.x,y:N.y+Te*F.y},null,{x:Math.cos(Ve)*c,y:Math.sin(Ve)*c},i.color,!0)}}while(v!==0)}};function bn(){var r;if(vim.gameEnded){if(wn.getNumberOfFireworks()===0)for(r=Math.floor(Math.random()*3)+1;r--;)wn.createParticle();wn.drawFireworks()}}function Dn(r){var i=View.dimensions(r),s=i.screenWidth,l=i.screenHeight;S=(S+1)%2e4,T=new Date().getTime(),f=new Date/500,e.clearRect(0,0,s,l),vim.gameEnded?bn():(ne(r),Ee(r),ce(r),de(r),oe(r),K(r),r.challenge&&r.challenge.started?(Ne(r),ae(r)):Ae(r),Ue(r)||(ze(r),De(r)),$e(r),ie(r),$(r),W(r),Bn(r),r.scrollMode||_n(r),A&&(e.fillStyle="#000",e.fillRect(300,5,20,20),e.fillStyle="#fff",e.fillText((M*1e3|0).toString(),302,20)))}function Bn(r){var i=View.dimensions(r),s=i.screenWidth,l=i.screenHeight,u=find(Effect.fadeIn)(r.effects),t=find(Effect.fadeOut)(r.effects);if(u&&u.fadeRatio===void 0&&(b=!1,u.fadeRatio=1),t&&t.fadeRatio===void 0&&(t.fadeRatio=0),u||t){var c=u||t;c.background?e.fillStyle="rgba(30,30,30,"+c.fadeRatio+")":e.fillStyle="rgba(0,0,0,"+c.fadeRatio+")",e.fillRect(0,0,s,l),c.fadeRatio+=(u?-1:1)*.05,t&&Effect.expiredFadeOut(t)&&t.toBlank&&(b=!0,w=c.background?"rgba(30,30,30,1.0)":"rgba(0,0,0,1.0)")}else b&&(e.fillStyle=w,e.fillRect(0,0,s,l),ee(r,!0))}function nn(r){var i=r;return function(){J(i),i===100&&(a=!1)}}function Hn(){var r=100,i,s=1500,l=30;for(a=!0,n=0,i=0;i<r;i+=1)window.setTimeout(nn(i),s+l),s+=l;window.setTimeout(nn(r),s+l)}function nr(){g=60}function Rn(){n=-1}function hn(){n=100}function Tn(){a=!1}function kn(){a=!0,Rn(),window.setTimeout(hn,200),window.setTimeout(Rn,500),window.setTimeout(hn,900),window.setTimeout(Rn,1100),window.setTimeout(hn,1200),window.setTimeout(Rn,1300),window.setTimeout(hn,1350),window.setTimeout(Rn,1400),window.setTimeout(Tn,1400)}function Gn(){b=!0}function vn(r,i,s,l){typeof vn.bugs=="undefined"&&(vn.bugs=[]),vn.bugs.push({context:r,xpos:i,ypos:s,entity:l})}function jn(r){var i,s,l;if(!(!vn.bugs&&!l)){for(i=0;i<vn.bugs.length;++i)s=vn.bugs[i],s.entity.type==="big_bug"?l=s:ar(r,s.context,s.xpos,s.ypos,s.entity);l&&mr(r,l.context,l.xpos,l.ypos,l.entity),vn.bugs=[]}}function ar(r,i,s,l,u){var t=View.dimensions(r),c=t.cellWidth,m=u.vol,v=u.xOffset,p=v===void 0?0:v,I=u.yOffset,E=I===void 0?0:I,x=u.volHidden;(m!=="Bram"&&m!=="Uganda"&&m!=="Charity"||!u.frozen)&&vim.images.draw(i,Entity.bugImageName(u),s+p,l-c/3+E),x||(i.font="bold 13px Courier New",i.fillStyle="#000",i.fillText(m,s+p+16-i.measureText(m).width/2,l+E+31),i.fillStyle="#fff",i.fillText(m,s+p+17-i.measureText(m).width/2,l+E+32))}function mr(r,i,s,l,u){var t=u.hitpoints,c=View.dimensions(r),m=c.cellWidth;vim.images.draw(i,Entity.bugImageName(u),s+(u.xOffset||0),l-m/3+(u.yOffset||0)),i.fillStyle="#000",i.fillRect(s+(u.xOffset||0)+16,l+(u.yOffset||0),102,12),i.fillStyle=t>2?"#0f0":t>1?"#ff0":"#f00",i.fillRect(s+(u.xOffset||0)+16+1,l+(u.yOffset||0)+1,Math.floor(100*t/5),10)}function hr(r){H.push(r)}function _n(r){var i=find(Effect.cursorGlow)(r.effects);if(!(!i||vim.screens["game-screen"].isTitleScreenOn()||find(Effect.fading)(r.effects)||b)){var s=View.dimensions(r),l=s.cellWidth;i.times===void 0&&(i.times=2,i.initialDropHeight=20,i.dropHeight=i.initialDropHeight);var u=_n.x,t=_n.y,c=i.dropHeight,m=i.times,v=2,p=2,I="#fff",E="#000",x=20,N=5,R=10,F=u+l/2,X=t-10-x-c;u===0||t===0||m===0||(i.dropHeight>0&&(i.dropHeight=Math.max(0,i.dropHeight-v),i.dropHeight===0&&i.times>0&&(i.times--,i.dropHeight=i.initialDropHeight)),e.save(),e.lineWidth=5,e.lineCap="round",e.strokeStyle=E,e.beginPath(),e.moveTo(F+p,X+p),e.lineTo(F+p,X+x+p),e.moveTo(F-N+p,X+x-R+p),e.lineTo(F+p,X+x+p),e.moveTo(F+N+p,X+x-R+p),e.lineTo(F+p,X+x+p),e.stroke(),e.strokeStyle=I,e.beginPath(),e.moveTo(F,X),e.lineTo(F,X+x),e.moveTo(F-N,X+x-R),e.lineTo(F,X+x),e.moveTo(F+N,X+x-R),e.lineTo(F,X+x),e.stroke(),e.restore())}}function Ue(r){if(vim.screens["game-screen"].isTitleScreenOn()||r.challenge&&r.challenge.name)return!0;for(var i=r.buffer,s=i.topX,l=i.topY,u=0;u<4;++u)for(var t=0;t<5;++t){var c=TextArea.at(s+t+1,l+u);if(c&&(c.bossMode||c.ctfMode))return!0}return!1}function rr(r,i,s){var l=r.buffer,u=l.cursorX,t=l.cursorY,c=l.name,m=l.topX,v=l.topY,p=TextArea.at(u,t)(r);if(!(!p||!p.bossMode||c!=="underground"||Model.level(r)!==14)&&Tile.at(p.x,p.y)(r)===Tile.MISSING){i=i||0,s=s||0;var I=[{mark:"B",x:412,y:419},{mark:"i",x:427,y:412},{mark:"u",x:427,y:427},{mark:"g",x:441,y:419}];I.forEach(function(E){var x=r.cache(E.x-m+i)(E.y-v+s).mark;x&&x.mark===E.mark&&P(r,e,E.x,E.y)})}}function z(r,i){var s=[],l=[],u=i,t=80,c=1/t,m,v,p,I,E=0,x,N=4;for(s.push(0),m=0;m<Math.floor(u/4);++m)s.push(Math.random());for(s.push(1),s.sort(function(R,F){return R-F}),l.push({x:r,y:0}),m=1;m<s.length;++m)p=u*c*(s[m]-s[m-1]),x=s[m]>.95?20*(1-s[m]):1,I=Math.floor(Math.random()*2*t-t),I-=(I-E)*(1-p),I*=x,E=I,l.push({x:r+I,y:Math.floor(s[m]*u)});for(l.push({x:r,y:i}),v=N;v>0;--v){for(e.strokeStyle=v===1?"#fff":"rgba(255,255,0,"+(v===1?1:.75/v)+")",e.lineWidth=v===1?1:v*2,e.beginPath(),e.moveTo(l[0].x,l[0].y),m=1;m<l.length;++m)e.lineTo(l[m].x,l[m].y);e.stroke()}}function dn(r){var i=View.dimensions(r),s=i.cellWidth,l=i.cellHeight,u=r.buffer.name,t=r.buffer,c=t.topX,m=t.topY;r.effects.filter(function(v){var p=v.type,I=v.bufferName;return p==="appearing-glow"&&I===u}).forEach(function(v){v.count===void 0&&(v.count=20);var p=(v.x-c)*s+18,I=(v.y-m)*l+28,E=20+20-v.count,x=e.createRadialGradient(p,I,E,p,I,E+20);x.addColorStop(0,"rgba(0,0,0,0)"),x.addColorStop(.5,"#fff"),x.addColorStop(1,"rgba(0,0,0,0)"),e.strokeStyle=x,e.fillStyle=x,e.lineWidth=5,e.beginPath(),e.arc(p,I,E+20,0,2*Math.PI,!0),e.fill(),v.count=Math.max(v.count-1,0)})}function In(r,i,s,l,u){var t=[{x:-.866,y:-.5},{x:.866,y:-.5},{x:0,y:1}].map(function(c){var m=c.x,v=c.y;return{x:m*s,y:v*s}});e.save(),e.translate(r,i),e.rotate(-Math.PI/2+l),e.fillStyle=u,e.beginPath(),e.moveTo(t[0].x,t[0].y),e.lineTo(t[1].x,t[1].y),e.lineTo(t[2].x,t[2].y),e.closePath(),e.fill(),e.restore()}function cn(r){var i=_slicedToArray(r,6),s=i[0],l=i[1],u=i[2],t=i[3],c=i[4],m=i[5];return{x:.5*.5*s+2*.5*.5*u+.5*.5*c,y:.5*.5*l+2*.5*.5*t+.5*.5*m}}function Ln(r,i,s,l,u,t,c,m,v,p){var I=vim.perfectArrows.getArrow,E=View.dimensions(r),x=E.screenWidth,N=E.screenHeight,R=_(r),F=R.topGap,X=R.bottomGap,Te=R.sideGap,Ve=s===u,Ye=i===l,je=Ve||Ye||!p,be={bow:je?.2:0,stretch:je?.5:0,stretchMin:0,stretchMax:420,padStart:10,padEnd:20,flip:v,straights:!je},Fe=I(i,s,l,u,be),rn=cn(Fe);(rn.x<20+Te||rn.y<20+F||rn.x+20>x-Te||rn.y+20>N-X)&&(Fe=I(i,s,l,u,_objectSpread(_objectSpread({},be),{},{flip:!v})));var xn=Fe,pn=_slicedToArray(xn,7),qn=pn[0],Ze=pn[1],Qn=pn[2],sn=pn[3],Wn=pn[4],wr=pn[5],Jn=pn[6];[{lineWidth:9,color:"#000",endSize:12,border:!0},{lineWidth:7,color:t,endSize:10}].forEach(function(vr){var pr=vr.lineWidth,ir=vr.color,gr=vr.endSize,lr=vr.border;e.save(),e.strokeStyle=ir,e.lineWidth=pr,e.lineCap="round",e.beginPath(),e.moveTo(qn,Ze),e.quadraticCurveTo(Qn,sn,Wn,wr),e.stroke(),In(Wn,wr,gr,Jn,ir),e.fillStyle=ir,e.strokeStyle=ir,e.font="bold 18px Curier New";var Vn=e.measureText(c),ge=Vn.fontBoundingBoxAscent+Vn.fontBoundingBoxDescent,ke=Vn.actualBoundingBoxAscent+Vn.actualBoundingBoxDescent,Me=Vn.width+8,Je=(ge||ke+6)+4,en=cn(Fe),se=en.x-Math.floor(Me/2),Se=en.y-Math.floor(Je/2);m===1&&(c==="l"?se=se-2:c==="k"?Se=Se+8:c==="j"&&(Se=Se-10,se=se-1));var xe=10;e.lineJoin="round",e.lineWidth=xe,lr?(e.strokeRect(se+xe/2-1,Se+xe/2-1,Me-xe+2,Je-xe+2),e.fillRect(se+xe/2-1,Se+xe/2-1,Me-xe+2,Je-xe+2)):(e.strokeRect(se+xe/2,Se+xe/2,Me-xe,Je-xe),e.fillRect(se+xe/2,Se+xe/2,Me-xe,Je-xe),e.fillStyle="#000",e.textBaseline="top",e.fillText(c,se+4,Se+4)),e.restore()})}function Mn(r){var i=View.dimensions(r),s=i.cellWidth,l=i.cellHeight,u=r.buffer,t=u.topX,c=u.topY,m=u.arrows;m&&m.forEach(function(v){var p=Math.floor((v.sx-t+.5)*s),I=Math.floor((v.sy-c+.5)*l+19),E=Math.floor((v.ex-t+.5)*s),x=Math.floor((v.ey-c+.5)*l+19),N=Math.abs(v.ex-v.sx)+Math.abs(v.ey-v.sy);Ln(r,p,I,E,x,v.color,v.caption,N,v.isPlayer,v.isBest)})}function On(r){var i=View.dimensions(r),s=i.cellWidth,l=i.cellHeight,u=r.buffer,t=u.topX,c=u.topY,m=u.name,v=r.effects.filter(Effect.lightning);v.forEach(function(p){if(p.count===void 0&&(p.count=5),m===p.buffer){var I=(p.x-t)*s,E=(p.y-c)*l+20;z(I+Math.floor(Math.random()*s),E+Math.floor(Math.random()*l)),p.count=Math.max(0,p.count-1)}})}function sr(r,i){var s=i.x,l=i.y,u=i.message,t=i.type==="cursorCommand",c=View.dimensions(r),m=c.screenWidth,v=c.cellWidth,p=c.cellHeight,I=c.personSpeechSize,E=c.personSpeechLineHeight,x=i.topX?i:r.buffer,N=x.topX,R=x.topY;if(t){var F=TextArea.at(s,l)(r);if(F&&(F.bossMode||F.ctfMode))return{topX:N,topY:R};if(u&&u[0]==="H")return{topX:N,topY:R}}var X=0,Te=0;e.font=I+"px Arial, Helvetica, sans-serif";for(var Ve=0;Ve<u.length;Ve+=1){var Ye=e.measureText(u[Ve]);X=Math.max(Ye.width,X),Te=Te+E}var je=(s-N)*v-12+45,be=(l-R)*p-15-15-Te,Fe=je+25+X-1+25,rn=N,xn=R;if(be<0&&(xn=R-(Math.floor((0-be)/p)+1)),Fe>m&&(rn=N+(t?1:-1)*(Math.floor((Fe-m)/v)+1)),Array.isArray(r.colonCommand)&&r.colonCommand.length){var pn=be+Te+25+25,qn=vim.screens["game-screen"].getColonMessageTopYOffset();pn>qn&&(xn=R+(Math.floor((pn-qn)/p)+1))}return{topX:rn,topY:xn}}return{resetCursorBlink:B,draw:he,doDraw:Dn,notifyBlank:Gn,scheduleSoundAfterFadeIn:hr,testDraw:function(){for(var i=_objectSpread(_objectSpread({},Game.currentGameState()),{},{effects:Game.currentGameEffects(),cache:Game.cellCache}),s=window.performance.now(),l=300,u;l--;)Dn(i);return u=window.performance.now(),u-s},init:G,renderloop:function(){requestAnimationFrame(he)},adjustViewportToSpeech:sr,notifyDoubleEscMsg:nr,notifyLightsOnAnimation:kn,notifyCandleLightAnimation:Hn}}();var Game=function(){"use strict";var e={buffer:{}},n=[],o,a,f={},T,S={},b={},w=vim.dom,H=w.$,g,M,A=-1;function O(){function D(){var ee=document.getElementById("screen");ee.width=window.innerWidth,ee.height=window.innerHeight,vim.client.send({type:"resize",value:{width:ee.width,height:ee.height}})}D(),O.initialised||(window.addEventListener("resize",debounce(D,400)),O.initialised=!0)}function B(D){var ee=e.buffer,J=ee.cursorX,h=ee.cursorY;if(!(D.x===J&&D.y===h)){var _=Math.floor(Math.random()*9)+1,y=D.xOffset,P=D.yOffset;y=y+(_%3===1?-1:0),y=y+(_%3===0?1:0),P=P+(_<4?-1:0),P=P+(_>6?1:0),y=Math.max(y,-6),y=Math.min(y,6),P=Math.max(P,-6),P=Math.min(P,6),D.xOffset=y,D.yOffset=P}}function G(D){var ee=e.buffer;if(ee&&!D.alpha){var J=D.message;if(J&&!"HML".includes(J[0])){var h=vim.view.adjustViewportToSpeech(e,D),_=h.topX,y=h.topY,P=D.topX?D:ee,W=P.topX,$=P.topY;(_!==W||y!==$)&&vim.client.send({type:"adjustViewport",value:{topX:_,topY:y}})}}}function U(){if(!vim.screens["game-screen"].isTitleScreenOn()&&!(a&&!a.finished)&&!find(Effect.fading)(n)){var D=n.filter(function(h){return h.wait});if(n=n.map(function(h){return h.wait?_objectSpread(_objectSpread({},h),{},{wait:!1}):h}),find(Effect.sound)(n)){var ee=Effect.highestPrecedenceSound(n);ee&&(vim.audio.play(ee.name),n=n.filter(function(h){return h!==ee}))}var J=find(Effect.setRegistersOutput)(D);J&&(vim.screens["game-screen"].setColonCommand(J.colonCommandOutput),window.setTimeout(function(){var h=vim.screens["game-screen"].getColonCommand();h===J.colonCommandOutput&&vim.screens["game-screen"].setColonCommand(J.colonCommandFinal)},2500))}}function V(D){if(e.buffer.topX){var ee=e.scroll?Math.min(e.scroll.srcTopX,e.scroll.dstTopX):e.buffer.topX,J=e.scroll?Math.min(e.scroll.srcTopY,e.scroll.dstTopY):e.buffer.topY;D.forEach(function(h){var _=h.x-ee+2,y=h.y-J+2,P=h.oldX-ee+2,W=h.oldY-J+2;_!==P||y!==W?(o[W]&&o[W][P]&&(o[W][P].entities=o[W][P].entities.filter(function($){return $.id!==h.id})),o[y][_].entities=(o[y][_].entities||[]).concat(_objectSpread({},h))):o[y][_].entities=o[y][_].entities.map(function($){return $.id===h.id?_objectSpread(_objectSpread({},$),h):$})})}}function Y(D){var ee=D.find(Effect.resetClientState);ee&&vim.screens["game-screen"].resetClientState();var J=D.filter(Effect.cancelAll);if(J.length){n=[];var h=J.pop(),_=D.lastIndexOf(h);D=D.filter(function(Q,ne){return ne>=_})}var y=find(Effect.challengeInstructions)(D);y&&vim.screens["game-screen"].openChallengeInstructionsDialog(y.name,y.instructions,y.ctf);var P=find(Effect.challengeOver)(D);P&&(P.timesup&&w.addClass(document.body,"time-is-up"),vim.input.disableKeys(),setTimeout(function(){w.removeClass(document.body,"time-is-up"),vim.screens["game-screen"].openChallengeResultsDialog(P)},P.timesup?1e3:0));var W=find(Effect.executeColonCommand)(D);W&&vim.screens["game-screen"].executeColonCommand(W.command.trim(),e.buffer,W.extendedKeyDescription),find(Effect.doubleLogin)(D)&&(vim.login.clearUserInfo(),vim.screens["game-screen"].doubleLogin()),find(Effect.gameError)(D)&&vim.screens["game-screen"].gameErrorPopUp();var $=find(Effect.licenseExpired)(D);if($){vim.login.clearUserInfo();var ie=$.email,pe=$.activationDate;vim.screens["game-screen"].licenseExpired(ie,pe)}if(find(Effect.lightsOn)(D)&&vim.view.notifyLightsOnAnimation(),find(Effect.doubleEscMessage)(D)&&vim.view.notifyDoubleEscMsg(),find(Effect.timerClear)(D)&&(n=n.filter(function(Q){return Q.type!=="timer-start"})),find(Effect.startLevelMark)(D)&&vim.stats.setStartLevelMark(),find(Effect.clearSpeech)(D)){n=n.filter(function(Q){return!Effect.speechBubble(Q)});var Ae=D.filter(Effect.clearSpeech).pop(),Ne=D.lastIndexOf(Ae);D=D.filter(function(Q,ne){return!Effect.speechBubble(Q)||ne>Ne})}find(Effect.runGameEnding)(D)&&(vim.input.disableKeys(),vim.screens["game-screen"].hideGameMenu(),vim.screens["game-screen"].runEnding()),n=[].concat(_toConsumableArray(n),_toConsumableArray(filter(noneOf(Effect.executeColonCommand,Effect.lightsOn,Effect.doubleEscMessage,Effect.timerClear,Effect.clearSpeech,Effect.doubleLogin,Effect.licenseExpired,Effect.gameError,Effect.startLevelMark,Effect.runGameEnding,Effect.challengeInstructions,Effect.challengeOver,Effect.resetClientState))(D)));var ae=last(Effect.showRange)(n);ae&&(n=[].concat(_toConsumableArray(filter(function(Q){return!Effect.showRange(Q)})(n)),[ae]));var De=last(Effect.timerStart)(n);De&&(n=[].concat(_toConsumableArray(filter(function(Q){return!Effect.timerStart(Q)})(n)),[De]),De.startTime||(De.startTime=new Date().valueOf()));var Re=find(Effect.commandHelp)(n);Re&&(vim.screens["game-screen"].showCommandHelp(Re.extendedKeyDescription,e.buffer),vim.input.disableKeys(),window.setTimeout(vim.input.enableKeys,Re.delay));var Ge=last(Effect.cursorCommand)(n);Ge&&(n=[].concat(_toConsumableArray(filter(function(Q){return!Effect.cursorCommand(Q)})(n)),[Ge]));var Xe=last(Effect.fixedSpeechBubble)(n);Xe&&(n=[].concat(_toConsumableArray(filter(function(Q){return!Effect.fixedSpeechBubble(Q)})(n)),[Xe]));var ze=find(Effect.princessFlash)(n);ze&&(n=filter(function(Q){return!Effect.fixedSpeechBubble(Q)||Q.type==="cursorCommand"})(n)),U();var $e=find(Effect.speechBubble)(n);$e&&G($e);var he=find(Effect.darknessFalls)(n);he&&(n=filter(function(Q){return!Effect.darknessFalls(Q)})(n),q()),n.filter(function(Q){return Q.type==="appearing-background"&&Q.width&&Q.height}).forEach(function(Q){n=filter(function(ne){return ne!==Q})(n),range(0)(Q.width-1).forEach(function(ne){return range(0)(Q.height-1).forEach(function(ce){return n.push({type:"appearing-background",x:Q.x+ne,y:Q.y+ce,bg:Q.bg,bufferName:Q.bufferName})})})})}function ve(D){if(D.challenge&&D.challenge.reviewMode)vim.images.toGrayScale();else if(D.model&&D.model.level===14)switch(e.buffer.name){case"lorem":vim.images.toGrayScale();break;case"sky":vim.images.toDark();break;case"ground":vim.images.toDark();break;case"underground":default:vim.images.toNormalColor();break}else vim.images.toNormalColor()}function ue(D){var ee=document.getElementById("screen");if(ee.width=window.innerWidth-40,ee.height=window.innerHeight-50,!ee.getContext){vim.game.showScreen("no-canvas");return}vim.client.connect(),vim.client.on("open",function(){O()}),vim.client.on("update",function(J){var h=J.effects,_=J.positionUpdates;if(J.connection&&(b=_objectSpread(_objectSpread({},b),J.connection)),_&&_.length&&!J.buffer){V(_),h&&h.length&&Y(h);return}if(J.buffer){Object.keys(J).forEach(function(Q){if(J[Q]==="SAME"){if(!S||S[Q]===void 0)return;J[Q]=S[Q]}}),Object.keys(J.buffer).forEach(function(Q){if(J.buffer[Q]==="SAME"){if(!S||!S.buffer||S.buffer[Q]===void 0)return;J.buffer[Q]=S.buffer[Q]}}),S=J;var y=e.buffer||{},P=y.cursorX,W=y.cursorY,$=J.buffer,ie=$.cursorX,pe=$.cursorY;(ie!==P||pe!==W)&&vim.view.resetCursorBlink()}var Ae=e.model?e.model.inputMode:void 0,Ne=e.model?e.model.macroRegister:void 0,ae=e.challenge||{},De=e.scroll;(J.scroll&&!De||!J.scroll&&De)&&(a&&!a.finished&&!J.scroll&&h.push({type:"cursor-pointer"}),a=J.scroll),Object.keys(J).length>2&&(e=_objectSpread(_objectSpread({},J),{},{effects:void 0,positionUpdates:void 0})),e.colonCommand?vim.screens["game-screen"].setColonCommand(e.colonCommand):vim.screens["game-screen"].setColonCommand("");var Re=e.challenge?e.challenge.reviewMode:void 0;(Re&&(Re!==ae.reviewMode||(e.challenge||{}).reviewFlag!==ae.reviewFlag)||(e.challenge||{}).optionNumber!==ae.optionNumber||(e.challenge||{}).optionNumber!==vim.screens["game-screen"].challengeOptionNumber())&&vim.screens["game-screen"].updateReviewMenu(e.challenge);var Ge=e.model?e.model.inputMode:void 0,Xe=e.model?e.model.macroRegister:void 0;if((Ge!==Ae||Xe!==Ne||Re!==ae.reviewMode)&&(Ge||Xe?(vim.screens["game-screen"].hideGameMenu(),vim.screens["game-screen"].hideReviewMenu()):e.challenge&&e.challenge.reviewMode?(vim.screens["game-screen"].hideGameMenu(),vim.screens["game-screen"].showReviewMenu()):vim.screens["game-screen"].isTitleScreenOn()||(vim.screens["game-screen"].hideReviewMenu(),vim.screens["game-screen"].showGameMenu())),e.user&&vim.loggedIn!==e.user.loggedIn&&(vim.loggedIn=e.user.loggedIn,vim.screens["game-screen"].updateLoginRelatedUI()),e.user&&vim.login.updateUserInfo(void 0,e.user,!1),h&&h.length&&Y(h),e.incompleteCursorCommand){var ze=e.buffer,$e=ze.cursorX,he=ze.cursorY;G({fixed:!1,flipped:!0,message:[e.incompleteCursorCommand],type:"cursorCommand",x:$e,y:he})}J.buffer&&(o=We(e),Be()),e.buffer,ve(e)}),vim.view.init(ee),vim.screens["game-screen"].hideToBeContinuedMessage(),vim.screens["game-screen"].hideCommandHelp(),vim.input.initialize(),g=!0,D&&K(),vim.view.renderloop()}function K(){g?g=!1:M&&(vim.screens["game-screen"].setColonCommand(M),M="")}function fe(){ue(),M="",T||(T=window.setInterval(function(){return Object.keys(f).forEach(function(D){return B(f[D])})},200)),Modernizr.localstorage&&(window.localStorage["VIM Adventures email"]="",window.localStorage["VIM Adventures password"]="",window.localStorage["VIM Adventures state"]="",window.localStorage["VIM Adventures token"]="",window.localStorage["VIM Adventures stats"]="")}function q(){vim.input.disableKeys(),vim.view.notifyCandleLightAnimation(),vim.screens["game-screen"].hideCommandHelp(),vim.audio.play("slam"),vim.loggedIn?vim.input.enableKeys():(vim.free_game_ended=!0,window.setTimeout(vim.screens["game-screen"].toBeContinuedFadeIn,7030))}function de(){vim.dom.removeClass(document.body,"user-message-shown"),A!==-1&&window.clearTimeout(A),A=-1}function ye(D){var ee=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,J=H("#user-message")[0];J.innerHTML=D,vim.dom.addClass(document.body,"user-message-shown"),A!==-1&&window.clearTimeout(A),A=ee?-1:window.setTimeout(de,3e3)}function We(D){var ee=Model.marks(D),J=D.buffer,h=J.bg,_=J.cursorX,y=J.cursorY,P=h.length,W=h[0].length,$=D.scroll?Math.min(D.scroll.srcTopX,D.scroll.dstTopX):D.buffer.topX,ie=D.scroll?Math.min(D.scroll.srcTopY,D.scroll.dstTopY):D.buffer.topY,pe=filter(function(ce){var oe=ce.x,te=ce.y,Ee=ce.text,Ie=Ee.split("\n"),Oe=Math.max.apply(Math,_toConsumableArray(Ie.map(function(we){return we.length}))),Ke=Ie.length;return!(oe+Oe<$-2||oe>$-2+W||te+Ke<ie-2||te>ie-2+P)})(D.buffer.textareas),Ae,Ne,ae=TextArea.letterAt(_,y)(D);if("()[]{}<>".includes(ae)){var De=TextArea.at(_,y)(D),Re=TextArea.findMatchingBracket(_,y)(De),Ge=Re.x,Xe=Re.y;(Ge!==_||Xe!==y)&&(Ae=Ge,Ne=Xe)}var ze=pe.map(function(ce){var oe=ce.x,te=ce.y,Ee=ce.marks,Ie=Ee===void 0?[]:Ee,Oe=TextArea.specialAreas(ce);return{x:oe,y:te,cells:TextArea.visibleText(ce).map(function(Ke,we){return Ke.split("").map(function(wn,on){var an=Oe.find(TextArea.matchSpecialArea(oe+on,te+we)),bn=TextArea.isHighlighted(oe+on,te+we)(ce)(D),Dn=find(function(nn){return nn.x===oe+on&&nn.y===te+we})(ee)||find(function(nn){return nn.x===oe+on&&nn.y===te+we})(Ie),Bn=oe+on===Ae&&te+we===Ne;return _objectSpread(_objectSpread(_objectSpread({x:oe+on,y:te+we,ta:ce,letter:wn,highlighted:bn},an&&{sa:an}),an&&an.type==="t"&&!an.hidden&&{tile:ce.shouldClean}),{},{mark:Dn,isMatchingBracket:Bn})})}).reduce(function(Ke,we){return[].concat(_toConsumableArray(Ke),_toConsumableArray(we))},[])}}).reduce(function(ce,oe){return[].concat(_toConsumableArray(ce),_toConsumableArray(oe.cells))},[]),$e=sort(sortXYAscending)(ze),he=sort(sortXYAscending)(D.buffer.entities.filter(function(ce){return!ce.invisible})),Q=sort(sortXYAscending)(D.sinkList||[]),ne=range(-2)(P-3).map(function(ce){return range(-2)(W-3).map(function(oe){for(;$e[0]&&(ce+ie>$e[0].y||ce+ie===$e[0].y&&oe+$>$e[0].x);)$e.shift();for(var te=$e[0]||{};he[0]&&(ce+ie>he[0].y||ce+ie===he[0].y&&oe+$>he[0].x);)he.shift();for(var Ee=he[0]||{},Ie=[];ce+ie===Ee.y&&oe+$===Ee.x;)Ie.push(he.shift()),Ee=he[0]||{};for(;Q[0]&&(ce+ie>Q[0].y||ce+ie===Q[0].y&&oe+$>Q[0].x);)Q.shift();var Oe=Q[0]||{};return _objectSpread(_objectSpread(_objectSpread({i:ce,j:oe,x:oe+$,y:ce+ie,tile:h[ce+2].charAt(oe+2),tileHeight:Tile.height(h[ce+2].charAt(oe+2))},oe+$===Oe.x&&ce+ie===Oe.y&&{isSunk:!0}),oe+$===te.x&&ce+ie===te.y&&_objectSpread({},te)),Ie.length>0&&{entities:Ie})})});return ne.forEach(function(ce){return ce.forEach(function(oe){if(oe.tile===Tile.RAMP_EAST||oe.tile===Tile.RAMP_WEST||oe.tile===Tile.MISSING||oe.tile===Tile.SKY_MISSING)oe.shadows=void 0;else{var te=oe.i,Ee=oe.j,Ie=oe.tileHeight,Oe={north:ne[te-1+2]&&ne[te-1+2][Ee+2]&&ne[te-1+2][Ee+2].tileHeight>Ie,south:ne[te+1+2]&&ne[te+1+2][Ee+2]&&ne[te+1+2][Ee+2].tileHeight>Ie&&ne[te+1+2][Ee+2].tileHeight<3,west:ne[te+2]&&ne[te+2][Ee-1+2]&&ne[te+2][Ee-1+2].tileHeight>Ie,east:ne[te+2]&&ne[te+2][Ee+1+2]&&ne[te+2][Ee+1+2].tileHeight>Ie,nw:ne[te-1+2]&&ne[te-1+2][Ee-1+2]&&ne[te-1+2][Ee-1+2].tileHeight>Ie,ne:ne[te-1+2]&&ne[te-1+2][Ee+1+2]&&ne[te-1+2][Ee+1+2].tileHeight>Ie,sw:ne[te+1+2]&&ne[te+1+2][Ee-1+2]&&ne[te+1+2][Ee-1+2].tileHeight>Ie,se:ne[te+1+2]&&ne[te+1+2][Ee+1+2]&&ne[te+1+2][Ee+1+2].tileHeight>Ie};oe.shadows=Oe.north||Oe.south||Oe.west||Oe.east||Oe.nw||Oe.ne||Oe.sw||Oe.se?Oe:void 0}})}),ne}function Be(){var D={};o.forEach(function(ee){return ee.forEach(function(J){J.entities&&J.entities.filter(function(h){return h.movement==="person"}).forEach(function(h){D[h.id]=h;var _=f[h.id];_&&(h.xOffset=_.xOffset,h.yOffset=_.yOffset)})})}),f=D}return{init:fe,currentGameState:function(){return e},currentGameEffects:function(){return n=filter(Effect.unexpired)(n),U(),n},cellCache:function(ee){return function(J){return o&&o[J+2]?o[J+2][ee+2]||{}:{}}},currentScrollMode:function(){return a},sendKeyToServer:function(ee){vim.client.send({type:"keypress",value:ee})},sendColonMessage:function(ee){vim.client.send({type:"colon-message",value:ee})},gameFocus:K,showMessage:ye,hideMessage:de,darknessFalls:q,restartGame:ue,connectionDetails:function(){return b}}}();vim.screens["game-screen"]=function(){"use strict";var e=vim.dom,n=e.$,o=vim.audio,a=!0,f=!1,T=o.getVolume(),S=n("#to-be-continued")[0],b=n("#more-information a")[0],w=n("#colon-command")[0],H=-1,g=!0,M="",A="standard",O=["~`!1@2#3$4%5^6&7*8(9)0_-+=","QqWwEeRrTtYyUuIiOoPp{[}]|\\","AaSsDdFfGgHhJjKkLl:;\"'","ZzXxCcVvBbNnMm<,>.?/"],B=["~`!1@2#3$4%5^6&7*8(9)0{[}]","\"'<,>.PpYyFfGgCcRrLl?/+=|\\","AaOoEeUuIiDdHhTtNnSs_-",":;QqJjKkXxBbMmWwVvZz"],G=O,U,V,Y=n("#credits")[0],ve=n("#new-terms")[0],ue=n("#register-screen")[0],K=n("#instructions")[0],fe=n("#button-desc")[0],q=!1,de=["~`!1@2#3$4%5^6&7*8(9)0_-+=","QqWwFfPpGgJjLlUuYy:;{[}]|\\","AaRrSsTtDdHhNnEeIiOo\"'","ZzXxCcVvBbKkMm<,>.?/"],ye=n("#stats")[0],We,Be,D=150,ee=1,J=1,h=0,_=1,y,P,W=n("#confirm-new-terms-button")[0],$=n("#new-terms-message")[0];function ie(){return A==="Dvorak"?"Colemak":A==="Colemak"?"standard":"Dvorak"}function pe(){Ae(ie())}function Ae(d){switch(A=d,d){case"Dvorak":G=B;break;case"Colemak":G=de;break;default:G=O}nr()}function Ne(){var d=document.querySelector("#game-menu-sound");f=!f,f?(T=o.getVolume(),o.setVolume(0),d.classList.add("muted")):(o.setVolume(T),d.classList.remove("muted"))}function ae(d){d&&d.preventDefault?d.preventDefault():window.event&&window.event.returnValue&&(window.eventReturnValue=!1)}function De(d){return Ge(),(!vim.free_game_ended||vim.loggedIn===!0)&&(S.style.visibility="hidden",b.style.visibility="hidden",vim.input.initialize()),n("#game-screen #game-menu")[0].style.display=vim.videoMode?"none":"block",Game.gameFocus(),ae(d),!1}function Re(){V=!0,e.addClass(document.body,"title-shown"),n("#title")[0].style.display="block",n("#social-buttons")[0].style.display="block",Wn(),Jn(),be(),vim.input.disableKeys(),window.addEventListener("keydown",De,!1)}function Ge(){V=!1,e.removeClass(document.body,"title-shown"),n("#title")[0].style.display="none",n("#social-buttons")[0].style.display="none",window.removeEventListener("keydown",De,!1),vim.client.isConnected()?X():vim.client.runOnConnect(X),e.hasClass(document.body,"no-challenges")||window.setTimeout(function(){e.addClass(document.body,"hide-new")},5e3)}function Xe(){var d=S.style.color,C=d.substring(d.lastIndexOf(",")+1,d.lastIndexOf(")")),L=.05,re;if(d===""){for(S.style.color="rgba(255,255,255,0)",re=L;re<1;re+=L)window.setTimeout(Xe,re*2e3);window.setTimeout(ze,re*2e3),S.style.visibility="visible"}else S.style.color="rgba(255,255,255,"+(parseFloat(C)+L)+")"}function ze(){var d=b.style.color,C=d.substring(d.lastIndexOf(",")+1,d.lastIndexOf(")")),L=.05,re;if(d===""){for(b.style.color="rgba(255,255,0,0)",re=L;re<1;re+=L)window.setTimeout(ze,re*2e3);b.style.visibility="visible"}else b.style.color="rgba(255,255,0,"+(parseFloat(C)+L)+")"}function $e(){o.play("menu_click"),kn()}function he(){vim.input.injectMenuColonCommand(["ESC","ESC",":","l","e","v","e","l"," ","1","ENTER"])}function Q(){vim.input.injectMenuColonCommand(["ESC","ESC",":","l","e","v","e","l"," ","3","ENTER"])}function ne(){vim.input.injectMenuColonCommand(["ESC","ESC",":","l","e","v","e","l"," "])}function ce(){vim.input.injectMenuColonCommand(["ESC","ESC",":","w"," "])}function oe(){vim.input.injectMenuColonCommand(["ESC","ESC",":","e"," "])}function te(){vim.input.injectMenuColonCommand(["ESC","ESC",":","!","l","s","ENTER"])}function Ee(){vim.input.injectMenuColonCommand(["ESC","ESC",":","!","r","m"," "])}function Ie(){e.addClass("#game-menu","nohover"),window.setTimeout(function(){e.removeClass("#game-menu","nohover")},100)}function Oe(){vim.input.injectMenuColonCommand(["ESC","ESC",":","s","e","t"," ","s","t","a","t","s","ENTER"]),Ie()}function Ke(){vim.input.injectMenuColonCommand(["ESC","ESC",":","s","e","t"," ","n","o","s","t","a","t","s","ENTER"]),Ie()}function we(){vim.input.injectMenuColonCommand(["ESC","ESC",":","h","e","l","p"," "])}function wn(d){return d.keyCode===27&&(on(),ae(d)),!1}function on(){n("#allow-arrow-keys-dialog")[0].style.display="none",n("#shadowOverlay")[0].style.visibility="hidden",window.removeEventListener("keydown",wn,!1),vim.input.enableArrowKeys(),je()}function an(){vim.input.disableKeys(),n("#shadowOverlay")[0].style.visibility="visible",be(),window.addEventListener("keydown",wn,!1),n("#allow-arrow-keys-dialog")[0].style.display="block"}function bn(d){if(detectTilde.keydown(d),detectTilde.checkAndResetCtrlR())return nn("CTRL-R"),ae(d),!1;if(detectTilde.checkAndResetFirefoxSlash())return nn("/"),ae(d),!1;if(detectTilde.checkAndResetFirefoxSingleQuote())return nn("'"),ae(d),!1;d.keyCode===27||d.keyCode===13?Hn():d.keyCode===16||(U=!0)}function Dn(d){detectTilde.keyup(d),d.keyCode===16&&(U||pe(),U=!1)}function Bn(d){var C=String.fromCharCode(d.charCode||d.keyCode);detectTilde.keypress(d),C===" "?Hn():nn(C)}function nn(d){var C=ValidKeys.getKeyDescription(d),L=document.getElementById("key-description");C!==""&&(L.innerHTML=d+" - "+C+(ValidKeys.isDisabled(d)(Game.currentGameState())?" <span style='color: #555'>(Temporarily missing)</span>":""))}function Hn(){n("#valid-keys-dialog")[0].style.display="none",n("#shadowOverlay")[0].style.visibility="hidden",window.removeEventListener("keypress",Bn,!1),window.removeEventListener("keydown",bn,!1),window.removeEventListener("keyup",Dn,!1),je(),U=!1}function nr(){var d,C,L="",re,Ce=Game.currentGameState();for(d=0;d<G.length;++d){switch(L+="<ul>",d){case 1:L+='<li class="tab_key key_inactive">&nbsp;</li>';break;case 2:L+='<li class="capslock key_inactive"></li>';break;case 3:L+='<li class="shift key_inactive">',L+='<div id="switch-keyboard-layout" onClick="vim.screens[\'game-screen\'].switchLayoutStyle()">Switch layout<br>to '+ie()+"</div>",L+="</li>";break}for(C=0;C<G[d].length/2;++C)L+="<li",re=G[d].charAt(C*2),re==="|"&&(L+=' class="pipe"'),L+='><div class="key_up',ValidKeys.isValid(re)(Ce)&&(ValidKeys.isDisabled(re)(Ce)?L+=" disabled":L+=" active"),L+="\" onClick=\"vim.screens['game-screen'].showKeyDescription('"+(re==='"'?"&quot;":re)+"');\"",L+=">"+(ValidKeys.isDisabled(re)(Ce)||ValidKeys.isValid(re)(Ce)?re:"")+"</div>",L+='<div class="key_down',re=G[d].charAt(C*2+1),ValidKeys.isValid(re)(Ce)&&(ValidKeys.isDisabled(re)(Ce)?L+=" disabled":L+=" active"),L+='" onClick=\'vim.screens["game-screen"].showKeyDescription("'+(re==="'"?"&apos;":re)+"\");'",L+=">"+(ValidKeys.isDisabled(re)(Ce)||ValidKeys.isValid(re)(Ce)?re:"")+"</div></li>";switch(d){case 0:L+='<li class="backspace key_inactive">&nbsp;</li>';break;case 2:L+='<li class="enter key_inactive"></li>';break;case 3:L+='<li class="shift key_inactive"></li>';break}L+="</ul>"}L+='<div id="key-description">Please press a key to read its description. Enter or ESC to exit.<br>For a more complete description type :help [character] in the game screen.</div>',n("#show-valid-keys-dialog")[0].innerHTML=L}function Rn(d){return d.keyCode===27?(Tn(),ae(d),!1):d.keyCode===40||d.keyCode===38?(ue.scrollTop=ue.scrollTop+20*(d.keyCode===40?1:-1),ae(d),!1):!0}function hn(d){var C=d.charCode||d.keyCode,L=String.fromCharCode(C);(L==="k"||L==="j")&&(ue.scrollTop=ue.scrollTop+20*(L==="j"?1:-1))}function Tn(){ue.style.display="none",je(),n("#shadowOverlay")[0].style.visibility="hidden",window.removeEventListener("keydown",Rn,!1),window.removeEventListener("keypress",hn,!1)}function kn(){Ye(),n("#shadowOverlay")[0].style.visibility="visible",be(),ue.style.display="block",window.addEventListener("keydown",Rn,!1),window.addEventListener("keypress",hn,!1)}function Gn(d){var C=d.charCode||d.keyCode,L=String.fromCharCode(C);(L==="k"||L==="j")&&(K.scrollTop=K.scrollTop+20*(L==="j"?1:-1))}function vn(d){return d.keyCode===27||d.keyCode===13?(jn(),ae(d),!1):d.keyCode===40||d.keyCode===38?(K.scrollTop=K.scrollTop+20*(d.keyCode===40?1:-1),ae(d),!1):!0}function jn(){K.style.display="none",je(),n("#shadowOverlay")[0].style.visibility="hidden",window.removeEventListener("keydown",vn,!1),window.removeEventListener("keypress",Gn,!1)}function ar(){Ye(),n("#shadowOverlay")[0].style.visibility="visible",be(),K.style.display="block",window.addEventListener("keydown",vn,!1),window.addEventListener("keypress",Gn,!1)}function mr(d){var C=d.charCode||d.keyCode,L=String.fromCharCode(C);(L==="k"||L==="j")&&(ye.scrollTop=ye.scrollTop+20*(L==="j"?1:-1))}function hr(d){return d.keyCode===27||d.keyCode===13?(_n(),ae(d),!1):d.keyCode===40||d.keyCode===38?(ye.scrollTop=ye.scrollTop+20*(d.keyCode===40?1:-1),ae(d),!1):!0}function _n(){ye.style.display="none",je(),n("#shadowOverlay")[0].style.visibility="hidden",window.removeEventListener("keydown",hr,!1),window.removeEventListener("keypress",mr,!1)}function Ue(){var d=vim.login;Ye(),n("#shadowOverlay")[0].style.visibility="visible",be(),n("#stat-user-email")[0].innerText=vim.loggedIn?vim.emailaddr+(d.isPartOfAGroup()?" ("+d.getGroupName()+")":""):"Unlicensed user",n("#stat-table-div")[0].innerHTML=vim.stats.getUserStatisticsTable(),ye.style.display="block",window.addEventListener("keydown",hr,!1),window.addEventListener("keypress",mr,!1)}function rr(){vim.input.disableKeys(),U=!1,n("#shadowOverlay")[0].style.visibility="visible",be(),window.addEventListener("keypress",Bn,!1),window.addEventListener("keydown",bn,!1),window.addEventListener("keyup",Dn,!1),nr(),n("#valid-keys-dialog")[0].style.display="block"}function z(){vim.loggedIn?vim.login.logout():(be(),vim.login.askForLoginInfo())}function dn(){S.style.visibility==="visible"&&(S.style.visibility="hidden",S.style.color="",b.style.visibility="hidden",b.style.color="",vim.input.enableKeys())}function In(){vim.loggedIn?(n("#user-login")[0].style.display="none",n("#user-logout")[0].style.display="block",n(".game-menu-buy")[0].style.display="none"):(n("#user-login")[0].style.display="block",n("#user-logout")[0].style.display="none",n(".game-menu-buy")[0].style.display="block")}function cn(){e.hasClass(document.body,"hide-new")||window.setTimeout(function(){e.addClass(document.body,"hide-new")},1e4),vim.loggedIn?vim.accessToChallenges?(e.removeClass(document.body,"logged-in-no-challenges"),e.addClass(document.body,"logged-in-with-challenges")):(e.removeClass(document.body,"logged-in-with-challenges"),e.addClass(document.body,"logged-in-no-challenges")):(e.removeClass(document.body,"logged-in-no-challenges"),e.removeClass(document.body,"logged-in-with-challenges"))}function Ln(){var d=vim.loggedIn&&vim.groupAdmin;n("#level-breakdown")[0].style.display=d?"block":"none";var C=vim.loggedIn&&vim.login.isPartOfAGroup();n("#leaderboard")[0].style.display=C?"block":"none"}function Mn(){var d=vim.login.shouldUserConfirmTerms()?"block":"none";n("#accept-terms")[0].style.display=d,n("#terms-notification")[0].style.display=d}function On(){Tn(),vim.email.confirmEmailAddress(i,void 0,!1)}function sr(){Tn(),vim.email.confirmEmailAddress(i,void 0,!0)}function r(){Tn(),vim.email.confirmEmailAddress(i,void 0,!1,!0)}function i(d,C,L,re){var Ce=document.getElementById("paypal_form"),He=document.location.host==="localhost"||document.location.host==="test.vim-adventures.com:3000"||document.location.host.indexOf("beta")!==-1,Le;Ce.innerHTML||(Ce.action="https://www."+(He?"sandbox.":"")+"paypal.com/cgi-bin/webscr",Ce.method="post",Ce.target="_top",Le='<input type="hidden" name="cmd" value="_s-xclick"><input type="hidden" name="hosted_button_id" value="CHANGE_ME">',He?Le+='<input type="image" src="https://www.sandbox.paypal.com/en_US/i/btn/btn_buynowCC_LG.gif" border="0" name="submit" alt="PayPal \u2013 The safer, easier way to pay online!">':Le+='<input type="image" src="https://www.paypalobjects.com/en_US/GB/i/btn/btn_buynowCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online.">',Le+='<img alt="" border="0" src="https://www.'+(He?"sandbox.paypal":"paypalobjects")+'.com/en_GB/i/scr/pixel.gif" width="1" height="1">',Le+='<input id="paypal_user_email" type="hidden" name="custom" value="CHANGE ME">',Ce.innerHTML=Le),d?Ce.children[1].value=He?"BAETQ5NWV7Q3N":"VR374LF726C9Q":C?Ce.children[1].value=He?"F347KRWFPAAB8":"S7GTMZDYSV9PU":re?Ce.children[1].value=He?"6WTVGH8S9C6VQ":"7ZXKEZJRYWH2J":L==10?Ce.children[1].value=He?"BUTTON_ID_HERE":"NKEJ4GZNCR8JY":Ce.children[1].value=He?"XU4NNWEXWZGNA":"R8977MY6X6S9A",n("#paypal_user_email")[0].value=vim.emailaddr,n("#buy_now form")[0].submit()}function s(d){return d.keyCode===27||d.keyCode===13?(t(),ae(d),!1):d.keyCode===40||d.keyCode===38?(Y.scrollTop=Y.scrollTop+20*(d.keyCode===40?1:-1),ae(d),!1):!0}function l(d){var C=d.charCode||d.keyCode,L=String.fromCharCode(C);(L==="k"||L==="j")&&(Y.scrollTop=Y.scrollTop+20*(L==="j"?1:-1))}function u(){Y.scrollTop=0,Y.style.display="block",Ye(),n("#shadowOverlay")[0].style.visibility="visible",be(),Y.style.display="block",window.addEventListener("keydown",s,!1),window.addEventListener("keypress",l,!1)}function t(){Y.style.display="none",je(),n("#shadowOverlay")[0].style.visibility="hidden",window.removeEventListener("keydown",s,!1),window.removeEventListener("keypress",l,!1)}function c(){e.bind("#game-menu-sound","click",Ne),e.bind(".game-menu-keyboard","click",rr),e.bind(".game-menu-buy","click",kn),e.bind("#restart-game","click",he),e.bind("#save-game","click",ce),e.bind("#restore-game","click",oe),e.bind("#restore-level3","click",Q),e.bind("#load-level","click",ne),e.bind("#list-games","click",te),e.bind("#delete-game","click",Ee),e.bind("#user-login","click",z),e.bind("#user-logout","click",z),e.bind("#user-stats","click",Ue),e.bind("#level-breakdown","click",qe),e.bind("#leaderboard","click",Z),e.bind("#display-ingame-stats","click",Oe),e.bind("#hide-ingame-stats","click",Ke),e.bind("#help","click",ar),e.bind("#topic-help","click",we),e.bind("#terms-and-conditions","click",se),e.bind("#copyright-and-credits","click",u),e.bind("#privacy-policy","click",Se),e.bind("#cookie-usage","click",xe),e.bind(".terms-link","click",se),e.bind(".privacy-link","click",Se),e.bind(".redeem-terms-link","click",se),e.bind(".redeem-privacy-link","click",Se),e.bind("#accept-terms","click",pr),e.bind("#confirm-new-terms-button","click",ge),e.bind(".game-menu-challenges","click",throttle(Kn,1e3)),e.bind("#retry-challenge-button","click",throttle(Kn,1e3)),e.bind("#retry-challenge-link","click",throttle(Kn,1e3)),e.bind("#review-challenge","click",Cn),e.bind("#back-to-game-link","click",throttle(function(){Be&&Be(),vim.socket.send({type:"restartGame"})},1e3)),In(),Ln(),Mn(),cn(),e.bind(b,"click",$e),e.bind("#personal-license","click",On),e.bind("#friend-license","click",sr),e.bind("#pro-license","click",r),e.bind("#group-license","click",function(d){return window.open("special-offer","_blank"),ae(d),!1}),e.bind("#group-license-mail","click",I),e.bind("#another-pro-license","click",m),e.bind("#convert-to-personal-license","click",v),e.bind("#upgrade-license-to-challenges","click",p),e.bind(".not-logged-in","click",kn),e.bind(".review-next","click",Sn),e.bind(".review-prev","click",An),e.bind(".review-close","click",fn),e.bind("#review-menu-other-options","click",Fn),e.bind("#review-menu-help-options","click",En),e.bind("#title-screen-buy-a-license","click",function(d){return De(d),kn(),ae(d),!1})}function m(){vim.emailaddr=vim.expiredEmail,i(!1,!0),vim.emailaddr=void 0}function v(){vim.emailaddr=vim.expiredEmail,i(!1),vim.emailaddr=void 0}function p(){vim.emailaddr?i(!1,!1,void 0,!0):console.log("email address not set! aborting.")}function I(){var d="contact@vim-adventures.com",C="Further details regarding group license",L="[ Please describe the context you wish to use VIM Adventures in, and how many licenses you require ]";window.open("mailto:"+d+"?subject="+C+"&body="+L)}function E(){w.innerHTML=M+(g?"<span id='colon-dialog-cursor'>|</span>":""),g=!g}function x(){return w.offsetTop}function N(){return M}function R(d){var C=d.substr(-1)==="|";C&&(d=d.substr(0,d.length-1)),H!==-1&&(window.clearInterval(H),H=-1,g=!0),M=d,w.innerHTML=d,w.style.visibility=d===""?"hidden":"visible",d===""?e.removeClass("#game-menu","nohover"):e.addClass("#game-menu","nohover"),C&&(H=window.setInterval(E,400))}function F(d,C){for(var L=d.substring(d.indexOf("?")+1),re=L.split("&"),Ce=0;Ce<re.length;Ce++){var He=re[Ce].split("=");if(He[0]==C)return decodeURIComponent(He[1])}return""}function X(){var d=new XMLHttpRequest;d.onerror=d.onload=function(){d.responseText!==""&&Game.showMessage("Vimium is capturing this page's keystrokes.<BR>Please add this page to Vimium's excluded URLs list.")},d.open("GET","chrome-extension://dbepggeogbaibhgnhhndojpepiihcmeb/content_scripts/vimium.css"),d.send()}function Te(){window.setInterval(function(){var d=["#register-screen","#login-dialog-overlay","#signup-dialog-overlay","#redeem-dialog-overlay","#forgot-password-dialog-overlay","#email-dialog-overlay","#license-expired-dialog-overlay","#gift-dialog-overlay"],C=d.some(function(L){return document.querySelector(L).style.display==="block"});C&&vim.client.send({type:"nop"})},45*1e3)}function Ve(){if(Modernizr.canvas&&Modernizr.canvastext?a&&(V=!0,o.initialize(),Game.init(),vim.input.disableKeys(),c(),Te(),a=!1):(vim.dom.$("#no-canvas")[0].style.display="block",V=!1,a&&(c(),a=!1)),document.referrer.indexOf("resetPassword.php")!==-1)Ge(),vim.login.choosePassword(F(document.referrer,"email"));else if(document.referrer.toLowerCase().indexOf("activatelicense.php")!==-1&&F(document.location.search,"email")!=="")Ge(),vim.newAccount=!0,vim.login.choosePassword(F(document.location.search,"email"));else if(document.referrer.toLowerCase().indexOf("activatelicense.php")!==-1&&F(document.location.search,"login")!=="")Ge(),vim.login.askForLoginInfo(F(document.location.search,"login"));else if(F(document.location.search,"email")!==""&&(F(document.location.search,"gift")!==""||F(document.location.search,"personal")!==""))Ge(),vim.login.choosePassword(F(document.location.search,"email"));else if(F(document.location.search,"login")!==""&&F(document.location.search,"personal")!==""){Ge();var d=F(document.location.search,"login");vim.login.askForLoginInfo(d==="blank"?void 0:d)}else if(F(document.location.search,"redeem")!==""){Ge();var C=F(document.location.search,"redeem");vim.login.redeemCode(C)}else F(document.location.search,"quiz-buy")!==""?(Ge(),kn()):V&&Re();window.scroll(0,0)}function Ye(){vim.input.disableKeys()}function je(){(!vim.free_game_ended||vim.loggedIn===!0)&&vim.input.enableKeys()}function be(){e.removeClass(fe,"shown"),q=!1,window.setTimeout(function(){return fe.innerHTML=""},500)}function Fe(d,C){var L=C.cursorX,re=C.topX;typeof ValidKeys.getNumberOfExampleSteps(d)!="undefined"&&(y=d,q=!0,We=0,L-re>18?(fe.style.left="50px",fe.style.right="auto"):(fe.style.right="50px",fe.style.left="auto"),fe.innerHTML=ValidKeys.getExtendedDescHTML(d),e.addClass(fe,"shown"))}function rn(){return q}function xn(){return V}var pn=new RegExp("\u23CE","g"),qn=function(C){return C.replace(pn,'<span class="enter">&nbsp;&nbsp;</span>')};function Ze(d){var C=ValidKeys.getNumberOfExampleSteps(y);!y||!C||((d<0&&We>0||d>0&&We<C-1)&&(We=We+d),fe.innerHTML=ValidKeys.getExtendedDescHTML(y,We))}var Qn=function(C,L){return function(){return document.querySelector(C).style.display=L}},sn=Qn("#game-screen #game-menu",vim.videoMode?"none":"block"),Wn=Qn("#game-screen #game-menu","none"),wr=function(){Qn("#review-menu","flex")(),Qn(".review-close","block")(),Qn(".review-prev",ee===1?"none":"block")(),Qn(".review-next",ee===J?"none":"block")()},Jn=function(){return["#game-screen #review-menu",".review-next",".review-prev",".review-close"].forEach(function(C){return Qn(C,"none")()})},vr=function(){var C=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},L=C.captions,re=L===void 0?[]:L,Ce=C.alternatives,He=Ce===void 0?[]:Ce,Le=C.helpTopics,mn=Le===void 0?[]:Le,Xn=C.optionNumber,zn=C.uncaptured,yr=C.flagNumber;_=He.length,h=Xn,P=mn.reduce(function(Qe,un){var or=un.command,Cr=un.extendedKeyDescription;return _objectSpread(_objectSpread({},Qe),{},_defineProperty({},or,Cr))},{}),n("#review-flag-number")[0].innerHTML=zn?"Uncaptured":"Flag #".concat(yr),n("#review-menu-yours > span")[0].innerHTML=re.map(function(Qe){var un=Qe.caption,or=Qe.moved;return'<span class="'.concat(or?"":"did-not-move",'">').concat(qn(un),"</span>")}).join("");var fr=re.filter(function(Qe){var un=Qe.moved;return un}).map(function(Qe){var un=Qe.caption;return un}).join("").length,_e=!zn&&He.filter(function(Qe){return Qe.keys.join("").length<=fr}).length===0,Nn=mn.length===0?"":":help<ol>".concat(mn.map(function(Qe){var un=Qe.command;return'<li\n                            class="code"\n                            data-option-command="'.concat(un,'"\n                          >').concat(un,"</li>")}).join(""),"</ol>"),kr=He.map(function(Qe,un){var or=Qe.keys;return'<li\n                    class="code '.concat(zn?"":or.join("").length<fr?"better-option":or.join("").length>fr?"worse-option":""," ").concat(un+1===Xn?"selected-option":"",'"\n                    data-option-number="').concat(un+1,'"\n                >').concat(or.join(""),"</li>")}).filter(function(Qe,un){return un<5}).join("");n("#review-menu-other-options > ol")[0].innerHTML=_e?'<li class="no-better code">No better or equivalent alternatives</li>':kr,n("#review-menu-help-options")[0].innerHTML=Nn};function pr(d,C){return pr.closingMsg=C||"",ve.style.display="block",Ye(),n("#shadowOverlay")[0].style.visibility="visible",be(),R(""),ve.style.display="block",!1}function ir(d,C,L){var re=n("#challenge-instructions-dialog h1")[0];re.innerText=d;var Ce=n("#challenge-instructions-dialog p.instructions");_toConsumableArray(Ce).forEach(function(He){return He.parentElement.removeChild(He)}),C.reverse().forEach(function(He){var Le=document.createElement("p");Le.classList.add("instructions"),Le.innerHTML=He||"&nbsp;",re.insertAdjacentElement("afterend",Le)}),L&&vim.audio.prepare("whistle"),er("#challenge-instructions-overlay",{display:"flex",onClose:function(Le){Le&&Le.cancel===!0||(L?(e.addClass(document.body,"ready-steady-go"),setTimeout(function(){e.removeClass(document.body,"ready-steady-go"),vim.client.send({type:"startChallenge"})},2600),setTimeout(function(){vim.audio.play("whistle")},2e3)):vim.client.send({type:"startChallenge"}))}})}function gr(d){var C=d.title,L=d.text,re=d.stars,Ce=d.flags,He=d.name,Le=d.numberOfRecommendations,mn=parseInt(C,10),Xn=isNaN(mn)?C:"<span class='number'>".concat(mn,"</span> ").concat(C.substr((""+mn).length)),zn="\n            <h1>".concat(Xn,'</h1>\n            <div class="stars">\n                <span class="star ').concat(re>=1?"star-full":"",'">&nbsp;</span>\n                <span class="star ').concat(re>=2?"star-full":"",'">&nbsp;</span>\n                <span class="star ').concat(re>=3?"star-full":"",'">&nbsp;</span>\n            </div>\n            <p>').concat(L,"</p>\n        ");document.querySelector(".challenge-results-content .content").innerHTML=zn,document.querySelector("#retry-challenge-button").setAttribute("data-challenge",He),document.querySelector("#retry-challenge-link").setAttribute("data-challenge",He),vim.dom.setClass(document.querySelector(".challenge-results-content"),"retry-only",Le===0),Le>0&&Ce&&(ee=1,h=0,J=Ce.length,_=Ce[0].alternatives.length),lr()}function lr(){er("#challenge-results-overlay",{display:"flex",ignoreEnter:!0,ignoreSpace:!0,onClose:function(C){var L=C.key,re=C.cancel;re!==!0&&L!==void 0&&vim.socket.send({type:"restartGame"})}})}function Vn(){n("#new-terms-message")[0].style.display="none",n("#confirm-new-terms-button")[0].style.display="block",ve.style.display="none",je(),n("#shadowOverlay")[0].style.visibility="hidden",R(pr.closingMsg),Mn()}function ge(){var d=(vim.emailaddr||"").trim();o.play("menu_click"),W.style.display="none",d===""?Me("Email address can't be empty. Please login first.","error"):d.indexOf("@")===-1?Me("Email address missing @ sign. Please login.","error"):d.indexOf(".",d.indexOf("@"))===-1?Me("Email address appears to be invalid. Please login again.","error"):vim.fetcher.getUrl("php/acceptTerms.php",Je,en,d,(vim.password||"").trim(),void 0,function(){Me("Updating server information...","processing")},void 0)}function ke(){$.style.display="none",W.style.display="block"}function Me(d,C){W.style.display="none",$.innerHTML=d,$.style.display="block",$.className=C,C!=="processing"&&window.setTimeout(ke,3e3)}function Je(){vim.terms=!0,Me("Terms of Use and Privacy Policy accepted.","ok"),window.setTimeout(function(){ke(),Vn()},3e3)}function en(d){Me("Error: "+d.responseText,"error")}function se(d){return window.open("terms","_blank"),ae(d),!1}function Se(d){return window.open("privacy","_blank"),ae(d),!1}function xe(d){return window.open("cookies","_blank"),ae(d),!1}function gn(){var d=document.location.hostname==="localhost"?"http://localhost/":Game.connectionDetails()["api-endpoint"]||"https://neweudb.vim-adventures.com/";return d[d.length-1]==="/"?d:d+"/"}function qe(d){return window.open(gn()+"breakdown?email="+encodeURIComponent(vim.emailaddr)+"&token="+encodeURIComponent(vim.token)+(document.location.hostname.includes("beta")?"&beta=true":""),"_blank"),ae(d),!1}function Z(d){var C=document.createElement("form");return C.method="POST",C.action=gn()+"php/leaderboard.php",C.target="_blank",C.innerHTML='<INPUT name="email" value="'+vim.emailaddr+'" hidden /><INPUT name="token" value="'+vim.token+'" hidden />',document.body.appendChild(C),C.submit(),ae(d),!1}function j(d){return j.bugElem||(j.bugElem=document.getElementById("ending_pic_bug")),function(){j.bugElem.style.left=d+"px",j.bugElem.style.visibility!=="visible"&&(j.bugElem.style.visibility="visible")}}function Kn(d){var C=d.target;if(C.classList.contains("start-challenge")&&document.body.classList.contains("logged-in-with-challenges")){Be&&Be({keepShadowOverlay:!0});var L=C.getAttribute("data-challenge");return vim.client.send({type:"resetToChallenge",value:{name:L}}),ae(d),!1}}function Cn(d){return Be&&(Be(),ee=1,h=0,vim.input.disableKeys(),window.addEventListener("keydown",Pe,!1),window.addEventListener("keypress",tr,!1),Wn()),rn()&&be(),wr(),vim.client.send({type:"reviewChallenge",value:{flagNumber:ee,optionNumber:h}}),ae(d),!1}function fn(d){return window.removeEventListener("keydown",Pe),window.removeEventListener("keypress",tr),Jn(),sn(),lr(),ae(d),!1}function Pe(d){d.keyCode===27&&(rn()?be():fn(d))}var Sn=function(C){return rn()&&be(),ee+1<=J&&(h=0),ee=Math.min(ee+1,J),Cn(C)},An=function(C){return ee-1>=1&&(h=0),ee=Math.max(ee-1,1),Cn(C)},ur=function(C){return h=Math.min(h+1,_),Cn(C)},Un=function(C){return h=Math.max(h-1,0),Cn(C)},Fn=function(C){var L=Number(C.target.getAttribute("data-option-number"));return isNaN(L)?(ae(C),!1):(h=L,Cn(C))},En=function(C){var L=C.target.getAttribute("data-option-command");return L&&Fe(P[L],{cursorX:0,cursorY:0}),ae(C),!1};function tr(d){var C=String.fromCharCode(d.charCode||d.keyCode);if(rn())"+=-_".includes(C)?Ze(C==="+"||C==="="?1:-1):be();else{if(C==="l")return Sn(d);if(C==="h")return An(d);if(C==="k")return Un(d);if(C==="j")return ur(d)}return ae(d),!1}function tn(){vim.input.disableKeys(),vim.gameEnded=!0,be(),n("#ending-dialog")[0].style.display="block",Pn("ending1","THANKS LIN                ",12,1),Yn("ending1","THANKS LIN                ",3,12),Pn("ending1","SHADOWY ONE, YOU'RE",void 0,14,"THANKS "),Pn("ending2","THE HERO OF HYRU     ",16,33),Yn("ending2","THE HERO OF HYRU     ",4,50),Pn("ending2","TEXTLAND.",void 0,55,"THE HERO OF "),window.setTimeout(function(){document.getElementById("ending_pic_princess").classList.add("css3-flip")},71*D),Pn("ending3","FINALLY,",void 0,94),Pn("ending4","PEACH RETURN              ",12,108),Yn("ending4","PEACH RETURN              ",8,121),Pn("ending4","E RETURNS TO TEXTLAND.",void 0,130,"PEAC"),Pn("ending5","THIS ENDS THE STORY.",void 0,156),Yn("ending5","THIS ENDS THE STORY.",void 0,180),Pn("ending5","THIS ENDS VIM-ADVENTURES.",void 0,200),dr(":%s/ENDS/ENDS PART 1 OF/g",235),window.setTimeout(function(){var re=document.getElementById("ending5");vim.screens["game-screen"].setColonCommand(""),re.innerHTML="THIS ENDS PART 1 OF VIM-ADVENTURES.",re.classList.add("css3-glow"),window.setTimeout(function(){re.classList.remove("css3-glow")},2*D)},270*D);var d=80,C=Math.floor(window.innerWidth/2/d),L=0;for(L=0;L<d;++L)window.setTimeout(j(-330-(d-1-L)*C),278*D+L*D/2);window.setTimeout(function(){document.getElementById("what_happened_bubble").style.visibility="visible"},321*D),window.setTimeout(function(){document.getElementById("what_happened_bubble").style.visibility="hidden"},408*D),dr(":q!",458),window.setTimeout(function(){vim.screens["game-screen"].setColonCommand(""),n("#ending-dialog")[0].style.display="none",n("#game")[0].style.display="none"},473*D)}function yn(d){return function(){vim.screens["game-screen"].setColonCommand(d)}}function dr(d,C){var L;for(L=1;L<=d.length;++L)window.setTimeout(yn(d.substr(0,L)),(L+C)*D)}function Zn(d,C,L,re){for(var Ce="",He=L.length;He--;)Ce+="&nbsp;";return function(){d.innerHTML=(re||"")+C+Ce}}function Pn(d,C,L,re,Ce){var He=document.getElementById(d),Le;for(Le=1;Le<=(L!==void 0?L:C.length);++Le)window.setTimeout(Zn(He,C.substr(0,Le),C.substr(Le),Ce),(Le+re)*D)}function Yn(d,C,L,re,Ce){var He=document.getElementById(d),Le=C.trim().length-1,mn;for(mn=0;mn<(L!==void 0?L:C.length);++mn)window.setTimeout(Zn(He,C.substr(0,Le-mn),C.substr(Le-mn),Ce),(mn+re)*D)}function br(d,C){vim.expiredEmail=d,n("#expired-user-email")[0].innerHTML=d||"Unknown user",n("#activated-on")[0].innerHTML=C?"<BR>License activated on "+C:"",er("#license-expired-dialog-overlay",{onClose:function(){n("#expired-user-email")[0].innerHTML="Unlicensed user",n("#activated-on")[0].innerHTML=""}})}function $n(){er("#double-login-dialog-overlay")}function cr(){er("#game-error-dialog-overlay")}function er(d){var C=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},L=C.display,re=L===void 0?"block":L,Ce=C.onClose,He=Ce===void 0?function(){}:Ce,Le=C.ignoreEnter,mn=Le===void 0?!1:Le,Xn=C.ignoreEsc,zn=Xn===void 0?!1:Xn,yr=C.ignoreSpace,fr=yr===void 0?!1:yr;Be&&Be();function _e(){var Qe=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},un=Qe.key,or=Qe.keepShadowOverlay,Cr=or===void 0?!1:or,Sr=Qe.cancel;Be=void 0,document.querySelector(d).style.display="none",He({key:un,cancel:Sr}),Cr||(document.querySelector("#shadowOverlay").style.visibility="hidden"),window.removeEventListener("keypress",kr,!1),window.removeEventListener("keydown",Nn,!1),je()}Be=_e;function Nn(Qe){(Qe.keyCode===27&&!zn||Qe.keyCode===13&&!mn)&&_e({key:Qe.keyCode===27?"ESC":"ENTER"})}function kr(Qe){var un=String.fromCharCode(Qe.charCode||Qe.keyCode);un===" "&&!fr&&_e(" ")}on(),Hn(),Ge(),Tn(),jn(),Ie(),vim.input.disableKeys(),document.querySelector("#shadowOverlay").style.visibility="visible",be(),R(""),window.addEventListener("keypress",kr,!1),window.addEventListener("keydown",Nn,!1),document.querySelector(d).style.display=re}function ln(d,C,L){if(d===":help")ar();else if(d===":stats")Ue();else if(d.indexOf(":help ")===0){var re=d.substr(6);L||Game.sendColonMessage("Sorry, no help for "+re),Fe(L,C)}else d===":login"?(be(),vim.login.askForLoginInfo()):d===":buy"?(be(),kn()):d===":privacy"?(be(),Se()):d===":cookies"?(be(),xe()):d===":copyright"?(be(),u()):d===":terms"?(be(),se()):d===":logout"?vim.login.logout():d===":keyboard"?rr():(d===":q"||d===":q!"||d===":quit"||d===":quit!")&&Re()}function me(){In(),Ln(),Mn(),cn(),vim.loggedIn&&dn()}function le(){Be&&Be({cancel:!0}),rn()&&be(),vim.dom.hasClass(document.body,"ready-steady-go")&&vim.dom.removeClass(document.body,"ready-steady-go"),window.removeEventListener("keydown",Pe,!1),window.removeEventListener("keypress",tr,!1),!xn()&&!vim.login.isInDialogFlow()&&ue.style.display!=="block"&&je()}return{run:Ve,toBeContinuedFadeIn:Xe,hideToBeContinuedMessage:dn,confirmArrowKeys:an,setColonCommand:R,getColonCommand:N,getColonMessageTopYOffset:x,showKeyDescription:nn,switchLayoutStyle:pe,displayKeyboard:rr,disableKeys:Ye,enableKeys:je,showTitle:Re,showCommandHelp:Fe,hideCommandHelp:be,traverseHelpCommandExample:Ze,isCommandHelpOn:rn,isTitleScreenOn:xn,showHelp:ar,showStats:Ue,doubleLogin:$n,licenseExpired:br,gameErrorPopUp:cr,showGameMenu:sn,hideGameMenu:Wn,showReviewMenu:wr,hideReviewMenu:Jn,updateReviewMenu:vr,showBuyLicense:kn,openCreditsDialog:u,openTermsDialog:se,openPrivacyDialog:Se,openCookiesDialog:xe,openNewTermsDialog:pr,openChallengeInstructionsDialog:ir,openChallengeResultsDialog:gr,runEnding:tn,executeColonCommand:ln,updateLoginRelatedUI:me,challengeOptionNumber:function(){return h},resetClientState:le}}();
